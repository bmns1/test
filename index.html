<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicon Valley Academy Parent Portal (beta)</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A softer slate-50 background */
        }
        .tab-active {
            border-bottom: 2px solid #0d9488; /* teal-600 */
            color: #0d9488; /* teal-600 */
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        #mobile-menu { display: none; }
        .rotate-180 { transform: rotate(180deg); }
        .transition-transform { transition: transform 0.2s ease-in-out; }
        .toastify.toastify-success {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }
        .toastify.toastify-error {
            background: linear-gradient(to right, #ff5f6d, #ffc371);
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-slate-100 p-4">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg max-w-md w-full">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
            <h1 class="text-3xl font-bold text-slate-900 mt-4">Silicon Valley Academy</h1>
            <p class="text-lg text-slate-600 mb-6">Parent Portal (beta)</p>
            <p class="text-sm text-slate-500 mb-8">Please log in with your student's Google Classroom account. For assistance or password issues, please contact: <a href="mailto:parent.portal@svaschool.org" class="font-medium text-teal-600 hover:underline">parent.portal@svaschool.org</a></p>
            <div id="google-signin-button-container" class="flex justify-center"></div>
        </div>
    </div>

    <div id="portal-container" class="hidden">
        <div id="qr-code-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Event Check-in QR Code</h3>
                    <div class="mt-2 px-7 py-3">
                        <div id="qrcode" class="mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-4">Have an admin scan this code to get credit for your hours.</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-modal-btn" class="px-4 py-2 bg-teal-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-400">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="min-h-screen bg-slate-50">
            <header class="bg-white shadow-sm sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                            <div class="flex-shrink-0"><img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-12 w-auto"></div>
                            <div class="ml-4">
                                <h1 class="text-2xl font-bold text-slate-900">Silicon Valley Academy</h1>
                                <p class="text-sm text-slate-500">Parent Portal (beta)</p>
                            </div>
                        </div>
                        <div class="hidden sm:flex items-center">
                            <div id="user-info-desktop" class="mr-4 text-right"></div>
                            <button onclick="signOut();" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300">Sign Out</button>
                        </div>
                        <div class="sm:hidden flex items-center">
                            <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-slate-500 hover:text-white hover:bg-teal-600 focus:outline-none" aria-controls="mobile-menu" aria-expanded="false">
                                <i id="menu-icon-open" class="ph-list text-2xl"></i><i id="menu-icon-close" class="ph-x text-2xl hidden"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="sm:hidden" id="mobile-menu">
                    <div class="pt-4 pb-3 border-b border-slate-200">
                        <div id="user-info-mobile" class="px-5"></div>
                    </div>
                    <div id="main-nav-mobile" class="px-2 pt-2 pb-3 space-y-1"></div>
                    <div class="pt-4 pb-3 border-t border-slate-200">
                        <div class="px-2"><button onclick="signOut();" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Sign Out</button></div>
                    </div>
                </div>
            </header>
            
            <nav class="hidden sm:block bg-white border-b border-slate-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div id="main-nav" class="flex justify-center -mb-px">
                        <button class="tab-btn tab-active text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="dashboard"><i class="ph-house mr-2"></i>Student Dashboard</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block" data-tab="actions"><i class="ph-bell-ringing mr-2"></i>Actions</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block" data-tab="volunteering"><i class="ph-hands-clapping mr-2"></i>Volunteering</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block" data-tab="signups"><i class="ph-list-checks mr-2"></i>My Signups</button>
                        </div>
                </div>
            </nav>

            <main class="max-w-7xl mx-auto py-8 sm:py-10 px-4 sm:px-6 lg:px-8">
                <div id="skeleton-loader">
                    <div class="space-y-12">
                        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-slate-200">
                            <div class="p-6 bg-slate-50 border-b border-slate-200">
                                <div class="flex items-center animate-pulse">
                                    <div class="h-16 w-16 rounded-full bg-slate-200"></div>
                                    <div class="ml-4 space-y-2">
                                        <div class="h-6 w-48 bg-slate-200 rounded"></div>
                                        <div class="h-4 w-32 bg-slate-200 rounded"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                               <div class="h-8 w-1/3 bg-slate-200 rounded animate-pulse"></div>
                               <div class="mt-4 space-y-3">
                                   <div class="h-5 w-full bg-slate-200 rounded animate-pulse"></div>
                                   <div class="h-5 w-5/6 bg-slate-200 rounded animate-pulse"></div>
                               </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="main-content" class="hidden">
                    <div id="dashboard" class="tab-content tab-content-active">
                        <h2 class="text-3xl font-bold text-slate-900 mb-6">My Students</h2>
                        <div id="student-content-container" class="space-y-12"></div>
                    </div>
                    
                    <div id="actions" class="tab-content">
                         </div>
                    <div id="volunteering" class="tab-content">
                         </div>
                    <div id="signups" class="tab-content">
                         </div>
                    </div>

            </main>
            
            <footer class="bg-white mt-12 border-t border-slate-200">
                 <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-slate-500 text-sm"><p>&copy; 2025 BMNS. All Rights Reserved.</p></div>
            </footer>
        </div>
    </div>
    
    <template id="student-card-template">
        <div class="student-card bg-white rounded-xl shadow-md overflow-hidden border border-slate-200">
            <div class="p-6 bg-slate-50 border-b border-slate-200">
                <div class="flex items-center">
                    <img class="student-photo h-16 w-16 rounded-full" src="" alt="Student Photo">
                    <div class="ml-4">
                        <h3 class="student-name text-2xl font-bold text-slate-900"></h3>
                        <p class="student-grade text-slate-600"></p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3">
                <div class="lg:col-span-2 p-6">
                    <div class="mb-8">
                        <h4 class="font-semibold text-lg text-slate-700 mb-3">Quick Actions</h4>
                        <div class="flex flex-wrap gap-3">
                            <button class="report-absence-nav-btn inline-flex items-center bg-teal-100 text-teal-800 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200 transition-colors">Report Absence/Tardy</button>
                            <button class="view-handbook-btn inline-flex items-center bg-slate-100 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition-colors">View Student Handbook</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg text-slate-700 mb-2">Teachers</h4>
                        <ul class="teachers-list space-y-0"></ul>
                    </div>
                </div>
                <div class="bg-slate-50 p-6 lg:border-l border-slate-200">
                    <h4 class="font-semibold text-lg text-slate-700 mb-2">Upcoming Events</h4>
                    <ul class="events-list space-y-4"></ul>
                </div>
            </div>
        </div>
    </template>

    <template id="teacher-item-template">
        <li class="flex items-center justify-between py-3 border-b border-slate-100 last:border-b-0">
            <div class="flex items-center">
                <img class="teacher-photo h-10 w-10 rounded-full mr-4" src="" alt="">
                <div>
                    <p class="teacher-name font-semibold text-slate-800"></p>
                    <p class="teacher-role text-sm text-slate-500"></p>
                </div>
            </div>
            <a class="teacher-email text-teal-600 hover:underline text-sm font-medium" href=""></a>
        </li>
    </template>


    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx3LGShhqFBG5Y2TocWHYYgg8Sp-mK2YbkZ2x6tWJwf6li0teEvIYYXa5zNxDKtV4U7/exec';
        const NEWSLETTER_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdZkNNppgbr_FdH2FOAztYpujc9A4URAsQIlWnADSypDlb5_KnCiVP3EImRK96jWK3Yg/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";
        let ID_TOKEN = null;
        let portalData = {};

        // --- HELPER FUNCTIONS ---
        function showToast(message, type = 'success') {
            const options = {
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                stopOnFocus: true,
                className: `toastify-${type}`
            };
            Toastify(options).showToast();
        }

        function decodeGrade(grade) {
            const gradeStr = String(grade).toUpperCase();
            if (gradeStr === 'P') return 'Pre-K';
            if (gradeStr === '0' || gradeStr === 'K') return 'KG';
            return `Grade ${gradeStr}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return !isNaN(date.getTime()) ? date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : dateString;
        }
        
        function switchToTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active'));
            document.querySelectorAll(`.tab-btn[data-tab="${tabName}"]`).forEach(b => b.classList.add('tab-active'));
            document.getElementById(tabName).classList.add('tab-content-active');
            const mobileMenu = document.getElementById('mobile-menu');
            if(mobileMenu.style.display === 'block'){
                mobileMenu.style.display = 'none';
                document.getElementById('menu-icon-open').classList.remove('hidden');
                document.getElementById('menu-icon-close').classList.add('hidden');
            }
        }

        // --- DATA FETCH & RENDER ---
        function fetchData(token) {
            fetch(`${WEB_APP_URL}?token=${token}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('skeleton-loader').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    
                    if (data.status !== 'success' || !data.data) throw new Error(data.error || 'Invalid data from backend.');
                    portalData = data.data;

                    renderDashboard(portalData.students);
                    // ... calls to other render functions ...
                    
                    if (typeof phosphor !== 'undefined') phosphor.replace();
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    const skeleton = document.getElementById('skeleton-loader');
                    skeleton.innerHTML = `<div class="text-center"><i class="ph-x-circle text-6xl text-red-500 mx-auto"></i><h2 class="text-2xl font-semibold text-slate-700 mt-4">Failed to Load Portal</h2><p class="text-slate-500">${error.message}</p></div>`;
                });
        }

        // --- NEW TEMPLATE-BASED RENDERING ---
        function renderDashboard(students) {
            const container = document.getElementById('student-content-container');
            container.innerHTML = '';
            if (!students || students.length === 0) {
                container.innerHTML = '<p>No students found.</p>';
                return;
            }

            const studentTemplate = document.getElementById('student-card-template');
            const teacherTemplate = document.getElementById('teacher-item-template');

            students.forEach(student => {
                const studentCard = studentTemplate.content.cloneNode(true);
                const studentInitials = student.studentName.split(" ").map(n=>n[0]).join("");

                studentCard.querySelector('.student-photo').src = `https://placehold.co/100x100/E2E8F0/4A5568?text=${studentInitials}`;
                studentCard.querySelector('.student-name').textContent = student.studentName;
                studentCard.querySelector('.student-grade').textContent = `${decodeGrade(student.grade)} - Classroom ${student.classroom}`;
                studentCard.querySelector('.report-absence-nav-btn').dataset.studentId = student.uniqueStudentId;

                const teachersList = studentCard.querySelector('.teachers-list');
                teachersList.innerHTML = '';
                if (student.teachers && student.teachers.length > 0) {
                    student.teachers.forEach(teacher => {
                        const teacherItem = teacherTemplate.content.cloneNode(true);
                        teacherItem.querySelector('.teacher-photo').src = teacher.photoUrl;
                        teacherItem.querySelector('.teacher-photo').alt = teacher.teacherName;
                        teacherItem.querySelector('.teacher-name').textContent = teacher.teacherName;
                        teacherItem.querySelector('.teacher-role').textContent = teacher.role;
                        teacherItem.querySelector('.teacher-email').textContent = teacher.email;
                        teacherItem.querySelector('.teacher-email').href = `mailto:${teacher.email}`;
                        teachersList.appendChild(teacherItem);
                    });
                } else {
                    teachersList.innerHTML = '<li><p class="text-slate-500 py-3">No teachers listed.</p></li>';
                }
                
                // You would continue this pattern for events, etc.
                container.appendChild(studentCard);
            });
        }

        // --- EVENT LISTENERS ---
        function addEventListeners() {
            // Event listeners would go here
        }

        // --- GOOGLE SIGN-IN & INITIALIZATION ---
        function handleCredentialResponse(response) {
            ID_TOKEN = response.credential;
            const profile = JSON.parse(atob(ID_TOKEN.split('.')[1]));
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('portal-container').classList.remove('hidden');

            showToast(`Welcome, ${profile.given_name}!`, 'success');

            const userInfoHtml = `<div class="flex items-center"><img class="h-8 w-8 rounded-full" src="${profile.picture}" alt=""><div class="ml-3"><div class="text-base font-medium text-slate-800">${profile.name}</div><div class="text-sm font-medium text-slate-500">${profile.email}</div></div></div>`;
            document.getElementById('user-info-desktop').innerHTML = userInfoHtml;
            document.getElementById('user-info-mobile').innerHTML = userInfoHtml;
            
            fetchData(ID_TOKEN);
            addEventListeners();
        }
        
        function signOut() {
            google.accounts.id.disableAutoSelect();
            window.location.reload();
        }

        window.onload = function() {
            try {
                google.accounts.id.initialize({
                  client_id: CLIENT_ID,
                  callback: handleCredentialResponse,
                  auto_select: true
                });
                google.accounts.id.renderButton(
                  document.getElementById('google-signin-button-container'),
                  { theme: "outline", size: "large", width: "300" } 
                );
            } catch (error) {
                console.error("Google Sign-In initialization failed:", error);
            }
        };
    </script>
</body>
</html>
