<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicon Valley Academy Parent Portal (beta)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A softer slate-50 background */
        }
        .tab-active {
            border-bottom: 2px solid #0d9488; /* teal-600 */
            color: #0d9488; /* teal-600 */
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        #mobile-menu { display: none; }
        /* Simple animation for accordion */
        .rotate-180 { transform: rotate(180deg); }
        .transition-transform { transition: transform 0.2s ease-in-out; }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        .student-tab-active {
            border-bottom: 3px solid #0d9488;
            color: #0d9488;
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-100 p-4">
        <!-- Screen 1: Main Login Choice -->
        <div id="login-screen" class="text-center p-8 bg-white rounded-xl shadow-lg max-w-md w-full">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
            <h1 class="text-3xl font-bold text-slate-900 mt-4">Silicon Valley Academy</h1>
            <p class="text-lg text-slate-600 mb-6">Parent Portal (beta)</p>
            <p class="text-sm text-slate-500 mb-8">Please log in with your SVA-associated parent email. For assistance or password issues, please contact: <a href="mailto:parent.portal@svaschool.org" class="font-medium text-teal-600 hover:underline">parent.portal@svaschool.org</a></p>
            
            <!-- NEW: Error Message Area -->
            <div id="login-error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 text-left" role="alert">
                <strong class="font-bold">Login Failed:</strong>
                <span class="block sm:inline" id="login-error-text"></span>
            </div>

            <!-- Google Sign-In Button -->
            <div id="google-signin-button-container" class="flex justify-center"></div>
            
            <!-- Divider -->
            <div class="my-6 flex items-center justify-center">
                <span class="border-b border-slate-300 w-full"></span>
                <span class="mx-4 text-sm font-medium text-slate-500">OR</span>
                <span class="border-b border-slate-300 w-full"></span>
            </div>
            
            <!-- Passkey Login Form -->
            <form id="passkey-request-form" class="space-y-4">
                <div>
                    <label for="email-input" class="sr-only">Parent Email</label>
                    <input type="email" id="email-input" placeholder="Enter your parent email" class="w-full px-4 py-3 rounded-md border-slate-300 shadow-sm" required>
                </div>
                <button type="submit" id="request-passkey-btn" class="w-full bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 transition">
                    Send Login Link
                </button>
            </form>
        </div>

        <!-- Screen 2: "Check Email" Screen (Hidden by default) -->
        <div id="passkey-verify-screen" class="hidden text-center p-8 bg-white rounded-xl shadow-lg max-w-md w-full">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
            <h2 class="text-2xl font-bold text-slate-900">Check Your Email</h2>
            <p class="text-slate-600 my-4">A secure login link has been sent to <strong id="passkey-email-display">your email</strong>.</p>
             <p class="text-sm text-slate-500">Please click the link in that email to log in. The link will expire in 10 minutes. You may need to check your spam folder.</p>
            
            <button type="button" id="go-back-btn" class="w-full text-sm text-slate-600 hover:text-slate-900 hover:underline mt-6">
                &larr; Go Back
            </button>
        </div>
    </div>


    <div id="loading-overlay" class="fixed inset-0 bg-slate-100 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <i id="loading-icon" class="ph-spinner-gap text-6xl text-teal-600 mx-auto animate-spin"></i>
            <h2 id="loading-title" class="text-2xl font-semibold text-slate-700 mt-4">Loading Portal Data...</h2>
            <p id="loading-message" class="text-slate-500">Please wait a moment.</p>
        </div>
    </div>
    
    <!-- Modal for Hot Lunch Order Review -->
    <div id="order-review-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">Review & Confirm Order</h2>
            <div id="order-review-content" class="space-y-3 text-left">
                <!-- Content injected here by JS -->
            </div>
            <div class="border-t border-slate-200 pt-4 mt-4 flex justify-between items-center">
                <button onclick="closeModal('order-review-modal')" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="confirm-order-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 disabled:opacity-50" disabled>
                    Confirm Order & Pay
                </button>
            </div>
        </div>
    </div>


    <div id="portal-container" class="hidden">
        <div id="qr-code-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Event Check-in QR Code</h3>
                    <div class="mt-2 px-7 py-3">
                        <div id="qrcode" class="mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-4">Have an admin scan this code when you arrive at the event to get credit for your hours.</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-qr-modal-btn" class="px-4 py-2 bg-teal-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-400">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="min-h-screen bg-slate-50">
            <header class="bg-white shadow-sm sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-12 w-auto">
                            </div>
                            <div class="ml-4">
                                <h1 class="text-2xl font-bold text-slate-900">Silicon Valley Academy</h1>
                                <p class="text-sm text-slate-500">Parent Portal (beta)</p>
                            </div>
                        </div>
                        <div class="hidden sm:flex items-center">
                            <div id="user-info-desktop" class="mr-4 text-right"></div>
                            <button onclick="signOut();" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300">Sign Out</button>
                        </div>
                        <div class="sm:hidden flex items-center">
                            <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-slate-500 hover:text-white hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                                <span class="sr-only">Open main menu</span>
                                <i id="menu-icon-open" class="ph-list text-2xl"></i>
                                <i id="menu-icon-close" class="ph-x text-2xl hidden"></i>
                            </button>
                        </div>
                    </div>
                </div>
                 <div class="sm:hidden" id="mobile-menu">
                    <div class="pt-4 pb-3 border-b border-slate-200">
                        <div id="user-info-mobile" class="px-5"></div>
                    </div>
                    <div id="main-nav-mobile" class="px-2 pt-2 pb-3 space-y-1"></div>
                    <div class="pt-4 pb-3 border-t border-slate-200">
                        <div class="px-2">
                             <button onclick="signOut();" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300">Sign Out</button>
                        </div>
                    </div>
                </div>
            </header>

            <nav class="hidden sm:block bg-white border-b border-slate-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div id="main-nav" class="flex justify-center -mb-px">
                        <button class="tab-btn tab-active text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="dashboard"><i class="ph-house mr-2"></i>Student Dashboard</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="actions"><i class="ph-bell-ringing mr-2"></i>Actions</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="volunteering"><i class="ph-hands-clapping mr-2"></i>Volunteering</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="signups"><i class="ph-list-checks mr-2"></i>My Signups</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="hotlunch"><i class="ph-bowl-food mr-2"></i>Hot Lunch</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="pto"><i class="ph-users-three mr-2"></i>PTO</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="faq-forms"><i class="ph-link mr-2"></i>Resources</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="live-event"><i class="ph-video-camera-fill mr-2"></i>Live Events</button>  
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="calendar"><i class="ph-calendar mr-2"></i>Calendar</button>
                    </div>
                </div>
            </nav>

            <main class="max-w-7xl mx-auto py-8 sm:py-10 px-4 sm:px-6 lg:px-8">
                <div id="dashboard" class="tab-content tab-content-active">
                     <h2 class="text-3xl font-bold text-slate-900 mb-6">My Students</h2>
                    <div id="student-content-container" class="space-y-12"></div>
                </div>
                
                <div id="actions" class="tab-content">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">Actions</h2>
                    <div id="actions-content-container" class="space-y-10"></div>
                </div>

                <div id="volunteering" class="tab-content">
                     <h2 class="text-3xl font-bold text-slate-900 mb-6">Volunteering Opportunities</h2>
                    <div class="mb-6 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-2">Volunteering Objectives & Rules</h3>
                        <p class="text-slate-600 text-sm">
                            Our parent volunteer program is essential to the success of our school community. The primary objective is to foster a strong partnership between parents and the school, enriching our students' educational experience. We require each family to complete a set number of volunteer hours per school year, divided between two semesters. Please sign up for opportunities that match your interests and schedule. If you must withdraw from a commitment, please do so at least three weeks in advance to allow another parent to take the spot. Failure to show up for a signed-up event without prior cancellation will result in a penalty, increasing your total required hours. For safety reasons, we ask that you do not bring small children while volunteering. We recommend arranging childcare during your volunteer shift. Thank you for your dedication to our students and school!
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="filter-semester" class="block text-sm font-medium text-slate-700">Semester</label>
                                <select id="filter-semester" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="all">All</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-event" class="block text-sm font-medium text-slate-700">Filter by Event</label>
                                <select id="filter-event" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="all">All Events</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-time" class="block text-sm font-medium text-slate-700">Time of Day</label>
                                <select id="filter-time" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option>All</option>
                                    <option>Morning</option>
                                    <option>Afternoon</option>
                                    <option>Evening</option>
                                    <option>All Day</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-hours" class="block text-sm font-medium text-slate-700">Max Hours</label>
                                <select id="filter-hours" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="99">Any</option>
                                    <option value="2">Up to 2</option>
                                    <option value="4">Up to 4</option>
                                    <option value="8">Up to 8</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-location" class="block text-sm font-medium text-slate-700">Location</label>
                                <select id="filter-location" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option>All</option>
                                    <option>On-Campus</option>
                                    <option>Remote</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-sort" class="block text-sm font-medium text-slate-700">Sort By</label>
                                <select id="filter-sort" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="default">Default</option>
                                    <option value="recent">Recently Added</option>
                                </select>
                            </div>
                        </div>
                    </div>
                     <div id="volunteering-list" class="space-y-6"><p>Loading volunteering opportunities...</p></div>
                </div>
                
                <!-- NEW HOT LUNCH TAB -->
                <div id="hotlunch" class="tab-content">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">Hot Lunch Orders</h2>
                    <div id="hotlunch-content-container">
                        <!-- Family Credit Display -->
                        <div class="bg-teal-50 p-4 rounded-xl shadow-sm border border-teal-200 flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-teal-800 flex items-center">
                                <i class="ph-wallet text-xl mr-2"></i>Family Credit Balance:
                            </h3>
                            <span id="credit-balance" class="text-2xl font-bold text-teal-700">--</span>
                        </div>

                        <!-- Student Selector -->
                        <div id="student-selector" class="flex overflow-x-auto border-b border-slate-200 bg-white sticky top-20 z-10">
                            <!-- Student tabs injected here -->
                        </div>

                        <!-- Order Calendar -->
                        <div id="hotlunch-order-calendar" class="mt-6">
                            <!-- Calendar injected here -->
                        </div>

                        <!-- Order Summary and Submit Button -->
                        <div class="bg-white p-4 rounded-xl shadow-lg border border-slate-200 mt-6 sticky bottom-0 z-10">
                            <div class="flex justify-between items-center font-bold text-lg mb-2">
                                <span>Total Pending Cost:</span>
                                <span id="pending-cost" class="text-red-600">$0.00</span>
                            </div>
                             <div class="flex justify-between items-center text-sm mb-4 border-b border-slate-100 pb-2">
                                <span>Credit After Order:</span>
                                <span id="remaining-credit" class="text-teal-700 font-semibold">$0.00</span>
                            </div>
                            <button id="review-order-btn" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700 disabled:opacity-50" disabled>
                                Review & Place Order
                            </button>
                        </div>
                    </div>
                </div>
                <!-- END NEW HOT LUNCH TAB -->

                <div id="signups" class="tab-content">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">My Volunteer Hours</h2>
                    <div id="my-signups-content"></div>
                </div>

                <div id="pto" class="tab-content">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">Parent-Teacher Organization (PTO)</h2>
                    <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold text-teal-700 mb-2">Building a Strong School Community Together</h3>
                            <p class="text-slate-600 leading-relaxed">As-salamu alaykum! The SVA Parent-Teacher Organization (PTO) warmly welcomes all new and returning families. We believe that a high level of parent participation is critical to the success of our students' education, tarbiyah, and development. The PTO is a formal, volunteer-based organization of parents, teachers, and staff working together to enhance the SVA student experience.</p>
                        </div>
                        <div class="border-t border-slate-200 pt-6">
                            <h3 class="text-xl font-semibold text-teal-700 mb-3">Our Mission & Key Roles</h3>
                            <ul class="list-disc list-inside space-y-3 text-slate-600">
                                <li><strong>Organize Enriching Events:</strong> We plan and execute co-curricular events and activities like International Day, Book Fairs, Movie Nights, and the Hajj Simulation to enrich our children's education.</li>
                                <li><strong>Raise Funds:</strong> Through community efforts, we raise funds to support vital school programs, classroom needs, and new initiatives.</li>
                                <li><strong>Build Community:</strong> We strive to create a strong, collaborative, and supportive environment that connects parents, teachers, and staff.</li>
                                <li><strong>Shape the Educational Experience:</strong> The PTO provides a valuable opportunity for parents to have a voice and actively contribute to their children's journey at SVA.</li>
                            </ul>
                        </div>
                         <div class="border-t border-slate-200 pt-6">
                            <h3 class="text-xl font-semibold text-teal-700 mb-2">Get Involved</h3>
                            <p class="text-slate-600 mb-4">Every parent and guardian at SVA is automatically a member of the PTO! We encourage you to get involved. You can sign up to be a committee member for a specific event or support year-long school programs.</p>
                            <div class="bg-teal-50 p-5 rounded-lg border border-teal-200">
                                <h4 class="font-semibold text-slate-800">2025-26 PTO Volunteering Leads:</h4>
                                <ul class="list-disc list-inside mt-2 text-slate-700">
                                    <li>Sara M.</li>
                                    <li>Rubeka A.</li>
                                    <li>Esraa El T.</li>
                                    <li>Ahmed S.</li>
                                </ul>
                                <p class="mt-4 text-sm">Interested in becoming a PTO lead, helping out, or have a question? To reach the PTO leadership, please email <a href="mailto:pto@svamail.com" class="text-teal-600 font-semibold hover:underline">pto@svamail.com</a>.</p>
                            </div>
                        </div>
                    </div>
                </div>


               <div id="faq-forms" class="tab-content">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">Resources, Newsletters & FAQs</h2>
                    <div class="flex border-b border-gray-200">
                        <button class="faq-forms-tab-btn tab-active px-6 py-3 text-sm font-medium" data-tab="faq-content">FAQ</button>
                        <button class="faq-forms-tab-btn px-6 py-3 text-sm font-medium text-slate-500" data-tab="forms-content">Forms</button>
                        <button class="faq-forms-tab-btn px-6 py-3 text-sm font-medium text-slate-500" data-tab="newsletters-content">Newsletters</button>
                        <button class="faq-forms-tab-btn px-6 py-3 text-sm font-medium text-slate-500" data-tab="quicklinks-content">Quick Links</button>
                    </div>
                    <div class="bg-white p-6 rounded-b-xl shadow-sm border border-t-0 border-slate-200">
                        <div id="faq-content" class="faq-forms-tab-content"></div>
                        <div id="forms-content" class="faq-forms-tab-content hidden"></div>
                        <div id="newsletters-content" class="faq-forms-tab-content hidden"></div>
                        <div id="quicklinks-content" class="faq-forms-tab-content hidden"></div>
                    </div>
                </div>

                <div id="live-event" class="tab-content">
                    </div>
                
                <div id="calendar" class="tab-content">
                     <h2 class="text-3xl font-bold text-slate-900 mb-6">School Calendar</h2>
                     <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <iframe src="https://calendar.google.com/calendar/embed?src=svaschool.org_us4ga4j1cfs27epj0f2dfegcl0%40group.calendar.google.com&ctz=America/Los_Angeles" style="border: 0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
                    </div>
                </div>
            </main>
            
            <footer class="bg-white mt-12 border-t border-slate-200">
                 <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-slate-500 text-sm"><p>&copy; 2025 BMNS. All Rights Reserved - (parent.portal@svaschool.org)</p></div>
            </footer>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw3iy8-OGJ-ZeS93jP1LGjTE_6yQIiw1fZvuJ7yheYXCCl6D1Z6QBSJFJLSJxTQnqJN/exec';
        const NEWSLETTER_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdZkNNppgbr_FdH2FOAztYpujc9A4URAsQIlWnADSypDlb5_KnCiVP3EImRK96jWK3Yg/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";
        let ID_TOKEN = null;
        let portalData = {};
        let currentStudentId = null; // Track which student's orders are being viewed
        let pendingOrders = {}; // Store {studentId: {date: itemId, ...}}
        
        // --- GLOBAL HELPER FUNCTIONS ---
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
        function showLoginScreen(screenId) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('passkey-verify-screen').classList.add('hidden');
            if (document.getElementById(screenId)) {
                document.getElementById(screenId).classList.remove('hidden');
            }
        }
        // --- END GLOBAL HELPERS ---

        // --- GOOGLE SIGN-IN & LOGIN LOGIC ---
        function handleCredentialResponse(response) {
            handleLoginSuccess(response.credential);
        }

        /**
         * Handles the final stage of login for both Google Sign-In and Passkey.
         * @param {string} idToken - A valid JWT (from Google or our backend).
         */
        function handleLoginSuccess(idToken) {
            ID_TOKEN = idToken;
            localStorage.setItem('sva_id_token', idToken); // <-- SAVE THE TOKEN
            const profile = JSON.parse(atob(ID_TOKEN.split('.')[1]));
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            // Use placeholder for picture if not provided (for passkey)
            const picture = profile.picture || `https://placehold.co/100x100/E2E8F0/4A5568?text=${profile.email[0].toUpperCase()}`;
            const name = profile.name || profile.email;
            const userInfoHtml = `<div class="flex items-center"><img class="h-8 w-8 rounded-full" src="${picture}" alt=""><div class="ml-3"><div class="text-base font-medium text-slate-800">${name}</div><div class="text-sm font-medium text-slate-500">${profile.email}</div></div></div>`;
            document.getElementById('user-info-desktop').innerHTML = userInfoHtml;
            document.getElementById('user-info-mobile').innerHTML = userInfoHtml;
            document.getElementById('login-error-msg').classList.add('hidden'); // Hide any previous errors

            fetchData(ID_TOKEN);
            fetchAndRenderResources();
            addEventListeners(); // Event listeners are added *after* login
        }

        /**
         * NEW: Handles an expired or invalid token.
         * Clears storage and shows the login screen with an error.
         */
        function handleTokenExpired(message) {
            localStorage.removeItem('sva_id_token'); // Clear the bad token
            ID_TOKEN = null;
            portalData = {};

            // Hide portal, show login screen
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('portal-container').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            showLoginScreen('login-screen'); // Make sure the main login screen is visible

            // Display the error message
            document.getElementById('login-error-text').textContent = message || "Your session has expired. Please log in again to continue.";
            document.getElementById('login-error-msg').classList.remove('hidden');
        }

        function signOut() {
            google.accounts.id.disableAutoSelect();
            localStorage.removeItem('sva_id_token'); // <-- CLEAR THE TOKEN
            ID_TOKEN = null;
            portalData = {};
            window.location.href = window.location.pathname; // Reload to a clean login page
        }
        
        // --- DATA FETCH & RENDER ---
        function fetchData(token) {
            fetch(`${WEB_APP_URL}?token=${token}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    if (data.status !== 'success' || !data.data) {
                        // Check for explicit auth failure from backend
                        if (data.error && data.error.includes("Authentication failed")) {
                           return handleTokenExpired(data.error);
                        }
                        throw new Error(data.error || 'Invalid data from backend.');
                    }
                    portalData = data.data;
                    document.getElementById('portal-container').classList.remove('hidden');
                    
                    // Initialize Hot Lunch System
                    if (portalData.students.length > 0) {
                        currentStudentId = portalData.students[0].uniqueStudentId;
                        renderHotLunchUI(); 
                    }

                    renderDashboard(portalData.students);
                    renderActionsTab(portalData.students);
                    populateEventFilter(portalData.allEvents);
                    applyAndRenderFilters(); 
                    renderMySignups(portalData.volunteerProgress);
                    renderMySignupsList(portalData.mySignups);
                    renderMobileMenu();
                    if (typeof phosphor !== 'undefined') phosphor.replace();
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    let errorMsg = String(error.message);

                    if (errorMsg.includes('Authentication failed')) {
                        handleTokenExpired(errorMsg);
                    } else {
                        const loadingOverlay = document.getElementById('loading-overlay');
                        if (loadingOverlay) loadingOverlay.innerHTML = `<div class="text-center"><i class="ph-x-circle text-6xl text-red-500 mx-auto"></i><h2 class="text-2xl font-semibold text-slate-700 mt-4">Failed to Load Portal</h2><p class="text-slate-500">${errorMsg}</p></div>`;
                    }
                });
        }
        
        function fetchAndRenderResources() {
            fetch(`${NEWSLETTER_WEB_APP_URL}?token=${ID_TOKEN}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderFAQ(data.data.faq);
                        renderForms(data.data.forms);
                        renderNewsletters(data.data.newsletters);
                        renderQuickLinks(data.data.quickLinks);
                        renderLiveEvent(data.data.liveEvent);
                    } else { throw new Error(data.error); }
                })
                .catch(error => {
                    console.error('Resources Fetch Error:', error);
                    if (document.getElementById('newsletters-content')) document.getElementById('newsletters-content').innerHTML = '<p class="text-red-500">Could not load newsletters.</p>';
                    if (document.getElementById('quicklinks-content')) document.getElementById('quicklinks-content').innerHTML = '<p class="text-red-500">Could not load quick links.</p>';
                });
        }
        
        // --- HOT LUNCH LOGIC ---

        function getStudentName(id) {
            return portalData.students.find(s => s.uniqueStudentId === id)?.studentName || 'Unknown Student';
        }

        function getMenuName(itemId) {
            return portalData.hotLunchMenu.find(m => m.itemId === itemId)?.name || 'Not Selected';
        }

        function getMenuItemPrice(itemId) {
            // Assume $5.00 if itemId is not found, or use the centralized MENU_PRICES structure if it were in the backend.
            return 5.00;
        }

        function calculateOrderSummary() {
            let totalCost = 0;
            let orderDetails = [];
            let ordersFound = false;

            for (const studentId in pendingOrders) {
                const studentName = getStudentName(studentId);
                for (const date in pendingOrders[studentId]) {
                    const itemId = pendingOrders[studentId][date];
                    if (itemId) {
                        const cost = getMenuItemPrice(itemId); // Use $5.00 assumption
                        totalCost += cost;
                        ordersFound = true;
                        orderDetails.push({ studentName, date, itemName: getMenuName(itemId), itemId, cost });
                    }
                }
            }

            const currentCredit = parseFloat(portalData.familyCredit || 0);
            const remainingCredit = currentCredit - totalCost;

            document.getElementById('pending-cost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('remaining-credit').textContent = `$${remainingCredit.toFixed(2)}`;
            
            const reviewBtn = document.getElementById('review-order-btn');
            
            if (ordersFound && remainingCredit >= 0) {
                reviewBtn.disabled = false;
                reviewBtn.textContent = `Review & Place Order`;
            } else if (remainingCredit < 0) {
                reviewBtn.disabled = true;
                reviewBtn.textContent = `Insufficient Credit ($${Math.abs(remainingCredit).toFixed(2)} needed)`;
            } else {
                reviewBtn.disabled = true;
                reviewBtn.textContent = `Review & Place Order`;
            }

            return { totalCost, remainingCredit, orderDetails };
        }

        function handleOrderSubmission() {
            const summary = calculateOrderSummary();
            if (summary.orderDetails.length === 0) return;
            if (summary.remainingCredit < 0) return;

            const confirmBtn = document.getElementById('confirm-order-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Submitting...';

            // Flatten pendingOrders into a list of {studentId, date, itemId}
            let ordersToSend = [];
            for (const studentId in pendingOrders) {
                for (const date in pendingOrders[studentId]) {
                    const itemId = pendingOrders[studentId][date];
                    if (itemId) {
                        ordersToSend.push({ studentId, date, itemId });
                    }
                }
            }

            const payload = {
                action: 'placeHotLunchOrder',
                orders: ordersToSend,
                totalCost: summary.totalCost,
                token: ID_TOKEN
            };

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                alert(`Order placed successfully! Confirmation email sent. The portal will now refresh.`);
                closeModal('order-review-modal');
                fetchData(ID_TOKEN); // Refreshes all data
            })
            .catch(error => {
                console.error('Order Submission Error:', error);
                alert(`An error occurred while placing the order. Please check your credit and try again.`);
            })
            .finally(() => {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Order & Pay';
                pendingOrders = {}; // Clear pending orders after submission attempt
            });
        }
        
        function handleMenuItemClick(studentId, date, itemId) {
            // Get the current student's orders, or initialize
            if (!pendingOrders[studentId]) {
                pendingOrders[studentId] = {};
            }

            // Determine if this item is being selected or deselected
            const isSelected = pendingOrders[studentId][date] === itemId;
            const menuCard = document.querySelector(`.menu-card[data-date="${date}"][data-item-id="${itemId}"]`);
            
            // Clear existing selection for this date and student in the UI
            document.querySelectorAll(`.hotlunch-day-card[data-date="${date}"] .menu-card`).forEach(card => {
                 card.classList.remove('ring-4', 'ring-teal-500');
            });


            if (isSelected) {
                // Deselect: set to null and remove highlight
                pendingOrders[studentId][date] = null;
            } else {
                // Select: set new item and add highlight
                pendingOrders[studentId][date] = itemId;
                menuCard.classList.add('ring-4', 'ring-teal-500');
            }
            
            // Re-calculate the cost and update the cart display
            calculateOrderSummary();
        }

        function renderHotLunchUI() {
            // 1. Render Student Tabs
            const selector = document.getElementById('student-selector');
            selector.innerHTML = portalData.students.map((student, index) => {
                // Set default student ID on first load
                if (currentStudentId === null) {
                    currentStudentId = student.uniqueStudentId;
                }
                const isActive = student.uniqueStudentId === currentStudentId;
                return `<button class="student-tab py-3 px-6 text-sm hover:text-teal-600 transition duration-150 ${isActive ? 'student-tab-active' : 'text-slate-600'}" data-student-id="${student.uniqueStudentId}">
                    ${student.studentName}
                </button>`;
            }).join('');

            // 2. Render Calendar
            renderHotLunchCalendar();

            // 3. Render Credit Balance
            document.getElementById('credit-balance').textContent = `$${parseFloat(portalData.familyCredit || 0).toFixed(2)}`;
            calculateOrderSummary();
        }
        
        function renderHotLunchCalendar() {
            const calendarContainer = document.getElementById('hotlunch-order-calendar');
            calendarContainer.innerHTML = '';
            
            // Map the menu data for easy lookup by slot number
            const menuMap = portalData.hotLunchMenu.reduce((acc, item) => {
                if (!acc[item.slot]) acc[item.slot] = [];
                acc[item.slot].push(item);
                return acc;
            }, {});

            // Map events for easy lookup by date
            const eventMap = portalData.upcomingEvents.reduce((acc, event) => {
                const dateKey = new Date(event.date).toISOString().split('T')[0];
                acc[dateKey] = event.name;
                return acc;
            }, {});
            
            // Map existing orders for the current student
            const existingOrders = portalData.studentOrders[currentStudentId] || {};
            
            // Array of 14 days starting today
            const days = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 14; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                days.push(date);
            }
            
            const calendarHtml = days.map(date => {
                const dayOfWeek = date.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Determine the lunch slot based on the day of the week
                let slot = 0;
                if (dayOfWeek === 5) slot = 1; // Friday (Slot 1)
                else if (dayOfWeek === 3) slot = 2; // Wednesday (Slot 2)
                else if (dayOfWeek === 1) slot = 3; // Monday (Slot 3)
                
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const eventName = eventMap[dateKey];
                
                const isOrderDay = slot > 0;
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                let menuCardsHtml = '';
                if (isOrderDay) {
                    const menuItems = menuMap[slot] || [];
                    
                    // Determine the current selection: existing order, or pending order?
                    const currentItemId = pendingOrders[currentStudentId]?.[dateKey] || existingOrders[dateKey] || null;

                    menuCardsHtml = menuItems.map(item => {
                        const isSelected = currentItemId === item.itemId;
                        
                        return `
                            <div class="menu-card cursor-pointer border border-slate-200 rounded-lg p-3 hover:bg-slate-50 transition ${isSelected ? 'ring-4 ring-teal-500' : ''}"
                                data-date="${dateKey}"
                                data-item-id="${item.itemId}"
                                onclick="handleMenuItemClick('${currentStudentId}', '${dateKey}', '${item.itemId}')">
                                <p class="font-semibold text-slate-900">${item.name}</p>
                                <p class="text-xs text-slate-500">${item.description}</p>
                                <span class="text-xs font-bold text-teal-600">$5.00</span>
                            </div>`;
                    }).join('');
                } else {
                    menuCardsHtml = `<p class="text-slate-500 text-sm">No lunch served today.</p>`;
                }
                
                let dayClasses = 'bg-white p-4 rounded-xl shadow-sm border border-slate-200';
                if (isWeekend) {
                    dayClasses += ' opacity-60 bg-slate-100';
                }

                return `
                    <div class="hotlunch-day-card ${dayClasses}" data-date="${dateKey}">
                        <div class="flex justify-between items-start border-b border-slate-100 pb-2 mb-3">
                            <div>
                                <p class="text-lg font-bold ${isWeekend ? 'text-slate-500' : 'text-slate-900'}">${dayName}, ${monthDay}</p>
                                ${eventName ? `<span class="inline-flex items-center text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800">${eventName}</span>` : ''}
                            </div>
                        </div>
                        <div class="space-y-3">
                            ${menuCardsHtml}
                        </div>
                    </div>`;
            }).join('');
            
            calendarContainer.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">${calendarHtml}</div>`;
        }


        // --- DATA PROCESSING & RENDERING FUNCTIONS (rest of the file) ---

        function renderFAQ(faqItems) { /* ... same as before ... */ }
        function renderForms(forms) { /* ... same as before ... */ }
        function renderNewsletters(newsletters) { /* ... same as before ... */ }
        function renderQuickLinks(links) { /* ... same as before ... */ }
        function renderLiveEvent(liveEventData) { /* ... same as before ... */ }
        function renderDashboard(students) { /* ... same as before ... */ }
        function renderEventItem(event, student, index) { /* ... same as before ... */ }
        function renderMobileMenu() { /* ... same as before ... */ }
        function renderActionsTab(students) { /* ... same as before ... */ }
        function renderVolunteering(opportunities) { /* ... same as before ... */ }
        function applyAndRenderFilters() { /* ... same as before ... */ }
        function populateEventFilter(events) { /* ... same as before ... */ }
        

        // --- EVENT LISTENERS ---
       function addEventListeners() {
            // Hot Lunch Student Tabs
            document.getElementById('student-selector').addEventListener('click', e => {
                const tab = e.target.closest('.student-tab');
                if (tab) {
                    document.querySelectorAll('.student-tab').forEach(t => t.classList.remove('student-tab-active', 'text-slate-600'));
                    tab.classList.add('student-tab-active');
                    currentStudentId = tab.dataset.studentId;
                    renderHotLunchCalendar();
                    calculateOrderSummary();
                }
            });
            
            // Review Order Button
            document.getElementById('review-order-btn').addEventListener('click', () => {
                const summary = calculateOrderSummary();
                const reviewContent = document.getElementById('order-review-content');
                
                if (summary.orderDetails.length === 0) {
                    alert("Please select at least one hot lunch item before reviewing.");
                    return;
                }

                let detailsHtml = `<p class="font-bold text-lg mb-3">Orders for ${portalData.students.length > 1 ? 'Multiple Students' : getStudentName(currentStudentId)}</p><ul class="space-y-2">`;
                
                summary.orderDetails.forEach(order => {
                    detailsHtml += `<li class="flex justify-between border-b pb-1"><span class="font-semibold">${order.studentName} (${order.date.slice(5)})</span><span class="text-slate-700">${order.itemName}</span><span class="text-teal-600 font-bold">$${order.cost.toFixed(2)}</span></li>`;
                });

                detailsHtml += `</ul><div class="mt-4 pt-3 border-t font-bold">
                                    <div class="flex justify-between"><span>Subtotal:</span><span>$${summary.totalCost.toFixed(2)}</span></div>
                                    <div class="flex justify-between text-red-600"><span>Deducted from Credit:</span><span>-$${summary.totalCost.toFixed(2)}</span></div>
                                    <div class="flex justify-between text-teal-700 text-xl mt-2"><span>NEW CREDIT:</span><span>$${summary.remainingCredit.toFixed(2)}</span></div>
                                </div>`;
                
                reviewContent.innerHTML = detailsHtml;
                openModal('order-review-modal');
            });

            // Confirm Order Button (inside modal)
            document.getElementById('confirm-order-btn').addEventListener('click', handleOrderSubmission);

            // Note: Login form listeners are now in window.onload
            document.body.addEventListener('click', function(event) {
                const target = event.target;
                const button = target.closest('button');
                const sidebarLink = target.closest('.sidebar-link');
                
                // --- Card expand/collapse (Check this first!) ---
                const header = target.closest('.volunteer-card-header');
                if (header) {
                    const content = document.getElementById(header.dataset.target);
                    const icon = header.querySelector('i');
                    if (content) {
                        content.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                    }
                    return; // Action handled, exit
                }

                // --- Sidebar Navigation ---
                if (sidebarLink) {
                    event.preventDefault();
                    document.querySelectorAll('.tab-btn, .sidebar-link').forEach(l => l.classList.remove('tab-active', 'active'));
                    
                    const tabId = sidebarLink.dataset.tab;
                    document.querySelectorAll(`.sidebar-link[data-tab="${tabId}"]`).forEach(l => l.classList.add('active'));
                    document.querySelectorAll(`.tab-btn[data-tab="${tabId}"]`).forEach(l => l.classList.add('tab-active'));

                    document.getElementById('page-title').textContent = sidebarLink.textContent.trim();
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('tab-content-active'));
                    document.getElementById(tabId).classList.add('tab-content-active');

                    // Close mobile sidebar if open
                    document.getElementById('mobile-menu').style.display = 'none';
                    document.getElementById('menu-icon-open').classList.remove('hidden');
                    document.getElementById('menu-icon-close').classList.add('hidden');
                    return; // Action handled, exit
                }

                // --- Button Checks ---
                if (!button) {
                    // Close modal ONLY if clicking the modal backdrop itself
                    if (event.target.classList.contains('modal')) {
                        closeModal(event.target.id);
                    }
                    return; // Not a button, sidebar link, or backdrop click, exit
                }

                if (button && button.matches('.withdraw-btn')) {
                    if (!confirm('Are you sure you want to withdraw from this event?')) return;
                    const signupId = button.dataset.signupId;
                    button.textContent = 'Withdrawing...';
                    button.disabled = true;
                    fetch(WEB_APP_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'withdraw', signupId: signupId, token: ID_TOKEN }),
                        headers: {'Content-Type': 'application/json'}
                    }).then(() => {
                        alert('Withdrawal successful! The portal will now refresh.');
                        fetchData(ID_TOKEN); 
                    }).catch(error => {
                        console.error('Withdrawal Error:', error);
                        alert(`An error occurred during withdrawal: Load failed`);
                        button.textContent = 'Withdraw';
                        button.disabled = false;
                    });
                }

                if (button && button.matches('.add-to-calendar-btn')) {
                    event.stopPropagation();
                    const dropdown = button.closest('.relative').querySelector('.event-dropdown');
                    if (dropdown) {
                        document.querySelectorAll('.event-dropdown').forEach(d => { if (d !== dropdown) d.classList.add('hidden'); });
                        const eventData = { name: button.dataset.eventName, date: button.dataset.eventDate };
                        const googleLink = dropdown.querySelector('.google-cal-link');
                        const iCalLink = dropdown.querySelector('.ical-link');
                        googleLink.href = generateGoogleCalendarLink(eventData); googleLink.target = "_blank";
                        iCalLink.href = generateICalLink(eventData); iCalLink.download = `${eventData.name}.ics`;
                        dropdown.classList.toggle('hidden');
                    }
                } else if (!target.closest('.event-dropdown')) {
                    document.querySelectorAll('.event-dropdown').forEach(dropdown => dropdown.classList.add('hidden'));
                }

                if (button && button.matches('.report-absence-nav-btn')) {
                    const studentId = button.dataset.studentId;
                    switchToTab('actions');
                    document.getElementById('student-select').value = studentId;
                }

                if (button && button.matches('.signup-btn')) {
                    const opportunityId = button.dataset.id;
                    button.textContent = 'Signing up...';
                    button.disabled = true;
                    fetch(WEB_APP_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'signup', opportunityId: opportunityId, token: ID_TOKEN }),
                        headers: {'Content-Type': 'application/json'}
                    }).then(() => {
                       alert('Signup successful! The portal will now refresh.');
                       fetchData(ID_TOKEN); 
                    }).catch(error => {
                        console.error('Signup Error:', error);
                        alert(`An error occurred during signup: Load failed`);
                        button.textContent = 'Sign Up';
                        button.disabled = false;
                    });
                }

                if (button && button.matches('.show-qr-btn')) {
                    const signupId = button.dataset.signupId;
                    const qrCodeContainer = document.getElementById('qrcode');
                    qrCodeContainer.innerHTML = '';
                    const checkinUrl = `https://approve.svaportal.com/?signupId=${signupId}`;
                    const qr = qrcode(0, 'M'); qr.addData(checkinUrl); qr.make();
                    qrCodeContainer.innerHTML = qr.createImgTag(6);
                    document.getElementById('qr-code-modal').classList.remove('hidden');
                }

                if (button && (button.matches('#close-qr-modal-btn') || button.parentElement.parentElement.parentElement === document.getElementById('qr-code-modal'))) {
                    document.getElementById('qr-code-modal').classList.add('hidden');
                }

                if (button && button.matches('.tab-btn')) { switchToTab(button.dataset.tab); }
                
                if (button && button.matches('.faq-forms-tab-btn')) {
                    const tabName = button.dataset.tab;
                    document.querySelectorAll('.faq-forms-tab-btn').forEach(btn => {
                        btn.classList.remove('tab-active'); btn.classList.add('text-slate-500');
                    });
                    button.classList.add('tab-active'); button.classList.remove('text-slate-500');
                    document.querySelectorAll('.faq-forms-tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');
                }

                if (target.closest('#mobile-menu-button')) {
                    const mobileMenu = document.getElementById('mobile-menu');
                    const isOpen = mobileMenu.style.display === 'block';
                    mobileMenu.style.display = isOpen ? 'none' : 'block';
                    document.getElementById('menu-icon-open').classList.toggle('hidden', isOpen);
                    document.getElementById('menu-icon-close').classList.toggle('hidden', !isOpen);
                }

                if (button && button.matches('.volunteer-for-event-btn')) {
                    const eventId = button.dataset.eventId;
                    switchToTab('volunteering');
                    document.getElementById('filter-event').value = eventId;
                    applyAndRenderFilters();
                }

                if(target.matches('input[name="report-type"]')) {
                    const isTardy = target.value === 'tardy';
                    document.getElementById('tardy-fields').style.display = isTardy ? 'grid' : 'none';
                    document.getElementById('absence-fields').style.display = isTardy ? 'none' : 'grid';
                }
               
                if (button && button.matches('.show-more-events-btn, .show-more-teachers-btn')) {
                    const studentId = button.dataset.studentId;
                    const type = button.matches('.show-more-events-btn') ? 'events' : 'teachers';
                    const moreDiv = document.getElementById(`more-${type}-${studentId}`);
                    if (moreDiv) {
                        const isHidden = moreDiv.classList.contains('hidden');
                        moreDiv.classList.toggle('hidden');
                        button.textContent = isHidden ? 'Show Less' : 'Show More';
                    }
                }
            });
            
            document.body.addEventListener('submit', function(event) {
                if (event.target.id === 'self-report-form') {
                    event.preventDefault();
                    const button = document.getElementById('self-report-btn');
                    const payload = {
                        action: 'selfReportHours', token: ID_TOKEN,
                        opportunityId: document.getElementById('report-duration').value,
                        date: document.getElementById('report-date').value,
                        description: document.getElementById('report-description').value
                    };
                    if (!payload.date || !payload.description) { alert("Please fill out the date and description for your activity."); return; }
                    button.textContent = 'Submitting...'; button.disabled = true;
                    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        alert('Your hours have been submitted for approval! The portal will now refresh to show the pending item.');
                        fetchData(ID_TOKEN);
                        document.getElementById('self-report-form').reset();
                    })
                    .catch(error => console.error('Self-report Error:', error))
                    .finally(() => { button.textContent = 'Submit for Approval'; button.disabled = false; });
                } else if (event.target.id === 'absence-form') {
                    event.preventDefault();
                    const button = document.getElementById('send-notification-btn');
                    button.textContent = 'Sending...'; button.disabled = true;
                    const studentId = document.getElementById('student-select').value;
                    const student = portalData.students.find(s => s.uniqueStudentId == studentId);
                    const reportType = document.querySelector('input[name="report-type"]:checked').value;
                    const startDate = document.getElementById('absence-start').value, endDate = document.getElementById('absence-end').value;
                    const tardyStartTime = document.getElementById('tardy-start-time').value, tardyEndTime = document.getElementById('tardy-end-time').value;
                    let reason = document.getElementById('absence-reason').value;
                    if (reason === 'Other') reason = document.getElementById('other-reason-text').value;
                    let comments = document.getElementById('absence-comments').value;
                    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'sendAbsenceEmail', student: student, reportType, startDate, endDate, tardyStartTime, tardyEndTime, reason, comments, token: ID_TOKEN })
                    })
                    .then(() => alert('Absence/Tardy notification sent successfully!'))
                    .catch(error => { console.error('Email Send Error:', error); alert(`An error occurred while sending the email: Load failed`); })
                    .finally(() => { button.textContent = 'Send Notification'; button.disabled = false; });
                } else if (event.target.id === 'pickup-form') {
                     event.preventDefault();
                     const button = document.getElementById('send-pickup-btn');
                     const selectedStudentIds = Array.from(document.querySelectorAll('.pickup-student-checkbox:checked')).map(cb => cb.value);
                     if (selectedStudentIds.length === 0) { alert("Please select at least one student."); return; }
                     const selectedStudents = portalData.students.filter(s => selectedStudentIds.includes(String(s.uniqueStudentId)));
                     const payload = {
                        action: 'sendPickupEmail', token: ID_TOKEN,
                        students: selectedStudents,
                        pickupName: document.getElementById('pickup-name').value,
                        relationship: document.getElementById('pickup-relationship').value,
                        pickupEmail: document.getElementById('pickup-email').value,
                        reason: document.getElementById('pickup-reason').value,
                        date: document.getElementById('pickup-date').value
                    };
                    if (!payload.pickupName || !payload.relationship || !payload.date) { alert("Please fill out the Authorized Person's Name, Relationship, and the Pickup Date."); return; }
                    button.textContent = 'Sending...'; button.disabled = true;
                    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        alert('Pickup notification sent successfully!');
                        event.target.reset();
                    })
                    .catch(error => { console.error('Pickup Send Error:', error); alert('An error occurred. Please try again.'); })
                    .finally(() => { button.textContent = 'Send Pickup Notification'; button.disabled = false; });
                }
            });

            document.body.addEventListener('change', function(event) {
                 if (event.target.matches('#absence-reason')) {
                    document.getElementById('other-reason-container').style.display = (event.target.value === 'Other') ? 'block' : 'none';
                 } else if (event.target.matches('.filter-control')) {
                    applyAndRenderFilters();
                 }
            });
        }

        // --- INITIALIZATION ---
         window.onload = function() {
            const hashToken = window.location.hash.startsWith('#token=') ? window.location.hash.substring(7) : null;
            const storedToken = localStorage.getItem('sva_id_token'); // <-- CHECK FOR STORED TOKEN

            if (hashToken) {
                // 1. User just clicked a magic link. Save the new token.
                window.history.replaceState({}, document.title, window.location.pathname); // Clean the URL
                handleLoginSuccess(hashToken);
            } else if (storedToken) {
                // 2. User is returning. Log them in with the stored token.
                handleLoginSuccess(storedToken);
            } else {
                // 3. User is new or logged out, show the login screen.
                try {
                    google.accounts.id.initialize({
                      client_id: CLIENT_ID,
                      callback: handleCredentialResponse
                    });
                    google.accounts.id.renderButton(
                      document.getElementById('google-signin-button-container'),
                      { theme: "outline", size: "large", width: "300" } 
                    );
                    // Add login form listeners here
                    document.getElementById('passkey-request-form').addEventListener('submit', handleRequestPasskey);
                    // document.getElementById('passkey-verify-form').addEventListener('submit', handleVerifyPasskey); // This form is gone
                    document.getElementById('go-back-btn').addEventListener('click', () => showLoginScreen('login-screen'));
                } catch (error) {
                    console.error("Google Sign-In initialization failed:", error);
                    document.getElementById('login-screen').innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-lg text-red-600"><p>Could not initialize Google Sign-In.</p></div>`;
                }
            }
        };

        // --- NEW: Passkey Login Functions ---
        /**
         * Handles Step 1 of passkey login: Requesting the code.
         */
        function handleRequestPasskey(e) {
            e.preventDefault();
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value;
            const button = document.getElementById('request-passkey-btn');
            
            button.disabled = true;
            button.textContent = 'Sending...';

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', // Use no-cors
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Use text/plain
                body: JSON.stringify({ action: 'requestLoginPasskey', email: email })
            })
            .then(() => {
                // FIX: Don't read the response. Just show the next screen.
                document.getElementById('passkey-email-display').textContent = email;
                showLoginScreen('passkey-verify-screen');
            })
            .catch(err => {
                console.error("Passkey Request Error:", err);
                alert(`A network error occurred. Please try again.`);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Send Login Link';
            });
        }
        
        /**
         * This function is no longer used for verification, as the magic link
         * is handled by the doGet in the backend and the window.onload function here.
         */
        function handleVerifyPasskey(e) {
            e.preventDefault();
             alert("Please check your email for the login link.");
        }
    </script>
</body>
</html>
