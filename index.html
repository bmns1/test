   <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicon Valley Academy Parent Portal (beta)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <!-- PayPal SDK - REPLACE 'test' WITH YOUR LIVE CLIENT ID -->
    <!--<script src="https://www.paypal.com/sdk/js?client-id=AbiIIQaGjjsKptfoxNWoHVZj8emb1OrShMOwN5CxdrirjAZ6Vz8DBRAWHSuQPdgh3RqDMySAsEmGQDH9&currency=USD"></script>-->
    <script src="https://www.paypal.com/sdk/js?client-id=AbiIIQaGjjsKptfoxNWoHVZj8emb1OrShMOwN5CxdrirjAZ6Vz8DBRAWHSuQPdgh3RqDMySAsEmGQDH9&currency=USD&enable-funding=venmo,applepay&components=buttons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A softer slate-50 background */
        }
        .tab-active {
            border-bottom: 2px solid #0d9488; /* teal-600 */
            color: #0d9488; /* teal-600 */
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        #mobile-menu { display: none; }
        /* Simple animation for accordion */
        .rotate-180 { transform: rotate(180deg); }
        .transition-transform { transition: transform 0.2s ease-in-out; }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        .student-tab-active {
            border-bottom: 3px solid #0d9488;
            color: #0d9488;
            font-weight: 600;
        }
        /* Custom Scrollbar for Agreements */
        .agreement-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .agreement-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .agreement-scroll::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        .agreement-scroll::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-100 p-4">
        <!-- Screen 1: Main Login Choice -->
        <div id="login-screen" class="text-center p-8 bg-white rounded-xl shadow-lg max-w-md w-full">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
            <h1 class="text-3xl font-bold text-slate-900 mt-4">Silicon Valley Academy</h1>
            <p class="text-lg text-slate-600 mb-6">Parent Portal (beta)</p>
            <p class="text-sm text-slate-500 mb-8">Please log in with your SVA-associated student email. For assistance or password issues, please contact: <a href="mailto:parent.portal@svaschool.org" class="font-medium text-teal-600 hover:underline">parent.portal@svaschool.org</a></p>
            
            <!-- Error Message Area -->
            <div id="login-error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 text-left" role="alert">
                <strong class="font-bold">Login Failed:</strong>
                <span class="block sm:inline" id="login-error-text"></span>
            </div>

            <!-- Google Sign-In Button -->
            <div id="google-signin-button-container" class="flex justify-center"></div>
            
            <!-- Divider -->
            <div class="my-6 flex items-center justify-center">
                <span class="border-b border-slate-300 w-full"></span>
                <span class="mx-4 text-sm font-medium text-slate-500">OR</span>
                <span class="border-b border-slate-300 w-full"></span>
            </div>
            
            <!-- Passkey Login Form -->
            <form id="passkey-request-form" class="space-y-4">
                <div>
                    <label for="email-input" class="sr-only">Student Email</label>
                    <input type="email" id="email-input" placeholder="Enter your student email" class="w-full px-4 py-3 rounded-md border-slate-300 shadow-sm" required>
                </div>
                <button type="submit" id="request-passkey-btn" class="w-full bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 transition">
                    Send Login Link
                </button>
            </form>
        </div>

        <!-- Screen 2: "Check Email" Screen (Hidden by default) -->
        <div id="passkey-verify-screen" class="hidden text-center p-8 bg-white rounded-xl shadow-lg max-w-md w-full">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
            <h2 class="text-2xl font-bold text-slate-900">Check Your Email</h2>
            <p class="text-slate-600 my-4">A secure login link has been sent to parents email associated with the following student <strong id="passkey-email-display">your email</strong>.</p>
             <p class="text-sm text-slate-500">Please click the link in that email to log in. The link will expire in 10 minutes. You may need to check your spam folder.</p>
            
            <button type="button" id="go-back-btn" class="w-full text-sm text-slate-600 hover:text-slate-900 hover:underline mt-6">
                &larr; Go Back
            </button>
        </div>
    </div>


    <div id="loading-overlay" class="fixed inset-0 bg-slate-100 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <i id="loading-icon" class="ph-spinner-gap text-6xl text-teal-600 mx-auto animate-spin"></i>
            <h2 id="loading-title" class="text-2xl font-semibold text-slate-700 mt-4">Loading Portal Data...</h2>
            <p id="loading-message" class="text-slate-500">Please wait a moment.</p>
        </div>
    </div>
    
    <div id="portal-container" class="hidden">
        
        <!-- QR Code Modal -->
        <div id="qr-code-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Event Check-in QR Code</h3>
                    <div class="mt-2 px-7 py-3">
                        <div id="qrcode" class="mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-4">Have an admin scan this code when you arrive at the event to get credit for your hours.</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-qr-modal-btn" class="px-4 py-2 bg-teal-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-400">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RE-ENROLLMENT WIZARD MODAL -->
        <div id="enrollment-modal" class="fixed inset-0 bg-gray-800 bg-opacity-90 overflow-y-auto h-full w-full hidden z-[60] flex items-center justify-center">
             <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col my-6 mx-4">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-teal-600 rounded-t-xl">
                    <h3 class="text-xl font-bold text-white">Re-enrollment 2026-2027</h3>
                    <button onclick="closeEnrollmentWizard()" class="text-teal-100 hover:text-white">
                        <i class="ph-x text-2xl"></i>
                    </button>
                </div>
                
                <!-- Content Area (Scrollable) -->
                <div class="flex-1 overflow-y-auto p-6" id="enrollment-wizard-content">
                    
                    <!-- Step 1: Start -->
                    <div id="step-start" class="wizard-step">
                        <h4 class="text-2xl font-bold text-slate-800 mb-4">Welcome to Re-enrollment</h4>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-blue-800">
                                <strong>Priority Window Ends:</strong> <span id="priority-countdown" class="font-mono font-bold text-red-600">Loading...</span>
                                <br><span class="text-sm">Deadline: February 16, 2026 at 8:30am PST</span>
                            </p>
                        </div>
                        <p class="mb-4 text-slate-700">Thank you for enrolling your student at Silicon Valley Academy for the 2026-2027 school year.</p>
                        <p class="mb-4 text-slate-600 text-sm">
                            Do note that if you require additional time for the Physician's Report (PreK), Health Report (KG), Oral Health Report (KG), or to obtain an updated Immunization Record (PreK, KG, 7th, & New Students), you have until May 1, 2026 to email them to SVA’s registrar. All other documents are required at the time you submit the online application in order for your child’s registration to be processed.
                        </p>
                        
                        <h5 class="font-bold text-lg text-slate-800 mb-3">Select students to re-enroll:</h5>
                        <div id="enrollment-student-list" class="space-y-3 mb-6"></div>
                        <p id="enrollment-error" class="text-red-500 hidden mb-2">Please select at least one student.</p>
                        
                        <div class="text-right">
                            <button onclick="wizardNext('contacts')" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700">Next &rarr;</button>
                        </div>
                    </div>

                    <!-- Step 2: Contacts -->
                    <div id="step-contacts" class="wizard-step hidden">
                        <h4 class="text-2xl font-bold text-slate-800 mb-4">Review Contact Information</h4>
                        <p class="mb-4 text-slate-600">Please review the information below. If any information is incorrect, please select "Incorrect" and you will be instructed to update it in GradeLink.</p>
                        
                        <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><span class="font-bold text-slate-700">Father:</span> <span id="contact-father">Loading...</span></div>
                            <div><span class="font-bold text-slate-700">Mother:</span> <span id="contact-mother">Loading...</span></div>
                            <div><span class="font-bold text-slate-700">Phone 1:</span> <span id="contact-phone1">Loading...</span></div>
                            <div><span class="font-bold text-slate-700">Phone 2:</span> <span id="contact-phone2">Loading...</span></div>
                            <div><span class="font-bold text-slate-700">Phone 3:</span> <span id="contact-phone3">Loading...</span></div>
                            <div><span class="font-bold text-slate-700">Emails:</span> <span id="contact-emails">Loading...</span></div>
                            <div class="md:col-span-2 border-t border-slate-200 pt-2 mt-2">
                                <span class="font-bold text-slate-700">Address:</span> <br>
                                <span id="contact-address">Loading...</span>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="font-bold text-slate-800 block mb-2">Is the information above correct and up to date?</label>
                            <div class="space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="contact-verify" value="Reviewed" class="form-radio text-teal-600">
                                    <span class="ml-2">Yes, it is correct.</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="contact-verify" value="Needs_Review" class="form-radio text-red-600">
                                    <span class="ml-2">No, it is incorrect.</span>
                                </label>
                            </div>
                            <div id="contact-update-msg" class="hidden mt-3 p-3 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded text-sm">
                                Please note: You must log in to your <strong>GradeLink</strong> account to update your contact information immediately after submitting this form.
                            </div>
                        </div>

                        <div class="flex justify-between">
                            <button onclick="wizardPrev('start')" class="text-slate-500 hover:text-slate-800">Back</button>
                            <button onclick="wizardNext('info')" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700">Next &rarr;</button>
                        </div>
                    </div>

                    <!-- Step 3: Information & Volunteer -->
                    <div id="step-info" class="wizard-step hidden">
                        <h4 class="text-2xl font-bold text-slate-800 mb-4">Parent Volunteer Agreement</h4>
                        <div class="prose prose-sm text-slate-600 max-w-none mb-6">
                            <p>Silicon Valley Academy strongly encourages parents to have a high level of involvement in their child(ren)’s education. Volunteer hours are critical to the success of SVA’s programs. We encourage parents to volunteer each semester. This can include volunteering for PTO activities and events, working for teachers and staff, contributing to school operations, or contributing to other work for the benefit of SVA. Please note, volunteer hours do not carry over between semesters or years nor are they prorated. In addition, parents who do not fulfill their volunteer hours will be required to pay a volunteer fee per semester.</p>
                            <p class="font-bold text-slate-800 mt-2">2026-2027 Volunteer Hours Requirement:</p>
                            <ul class="list-disc pl-5">
                                <li>1 child enrolled: 10 hours per semester</li>
                                <li>2 or more children enrolled: 20 hours per semester</li>
                            </ul>
                            <p class="mt-2">In order to match parents with volunteer opportunities related to their expertise and skill set, please mark an X next to all areas below in which you have experience and/or interest and specify where necessary. We look forward to your contribution to SVA for the benefit of the children.</p>
                        </div>
                        
                        <!-- Volunteer Interests -->
                        <div class="grid grid-cols-2 gap-2 mb-6 text-sm">
                            <label><input type="checkbox" class="vol-interest mr-2" value="Classroom Helper"> Classroom Helper</label>
                            <label><input type="checkbox" class="vol-interest mr-2" value="Event Planning"> Event Planning</label>
                            <label><input type="checkbox" class="vol-interest mr-2" value="Traffic Duty"> Traffic/Safety</label>
                            <label><input type="checkbox" class="vol-interest mr-2" value="Fundraising"> Fundraising</label>
                            <label><input type="checkbox" class="vol-interest mr-2" value="Lunch Duty"> Lunch Duty</label>
                            <label><input type="checkbox" class="vol-interest mr-2" value="Field Trips"> Field Trips</label>
                        </div>

                        <div class="bg-slate-100 p-5 rounded-lg border border-slate-200 mb-6">
                            <h5 class="font-bold text-slate-800 mb-3">Volunteer Opt-Out</h5>
                            <p class="text-sm text-slate-600 mb-3">Parents may choose to opt out of volunteering for the 2026-2027 academic year. To opt out of volunteering for either semester and pay the volunteer fee up front, please check below.</p>
                            
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="checkbox" id="opt-out-s1" class="mt-1 mr-2 text-teal-600 focus:ring-teal-500">
                                    <span class="text-sm">I intend to not volunteer during the <strong>first semester</strong> of the 2026-2027 academic year and choose to pay up front on Gradelink the volunteer fee of $350 due 7/1/26.</span>
                                </label>
                                <label class="flex items-start">
                                    <input type="checkbox" id="opt-out-s2" class="mt-1 mr-2 text-teal-600 focus:ring-teal-500">
                                    <span class="text-sm">I intend to not volunteer during the <strong>second semester</strong> of the 2026-2027 academic year and choose to pay up front on Gradelink the volunteer fee of $350 due 1/1/27.</span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-red-50 p-4 border-l-4 border-red-500 text-sm text-slate-700 mb-6">
                            <p class="font-bold mb-1">Fee Policy for Unfulfilled Hours:</p>
                            <p>Parents who choose to volunteer but do not fulfill their required hours each semester will be charged accordingly.</p>
                            <ul class="list-disc pl-5 mt-1">
                                <li>If the required volunteer hours from the first semester are not fulfilled by January 14, 2027, a volunteer fee of $450 will be charged to the family's statement in GradeLink.</li>
                                <li>If the required volunteer hours from the second semester are not fulfilled by June 4, 2027, a volunteer fee of $450 will be charged to the family's statement in GradeLink.</li>
                            </ul>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="volunteer-agree-check" class="mr-2 text-teal-600 focus:ring-teal-500 h-5 w-5">
                                <span class="font-bold text-slate-800">I understand the above requirements and agree to fulfill my volunteer obligation as a parent/guardian as described.</span>
                            </label>
                        </div>

                        <div class="flex justify-between">
                            <button onclick="wizardPrev('contacts')" class="text-slate-500 hover:text-slate-800">Back</button>
                            <button onclick="wizardNext('tuition')" id="btn-info-next" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed">Agree & Continue</button>
                        </div>
                    </div>

                    <!-- Step 4: Tuition (Dynamic Calculator) -->
                    <div id="step-tuition" class="wizard-step hidden">
                         <h4 class="text-2xl font-bold text-slate-800 mb-4">Tuition & Fees 2026-2027</h4>
                         <p class="mb-4 text-sm text-slate-600">Student tuition is an annual amount covering the academic year that can be paid in one lump sum or over a 10-month period starting June 1, 2026 to March 1, 2027.</p>
                         
                         <!-- Dynamic Calculation Area -->
                         <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6 shadow-sm">
                             <h5 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">Your Tuition Summary</h5>
                             <div id="tuition-calculation-container" class="space-y-2 mb-4">
                                 <!-- JS will inject rows here: Student Name | Grade | Cost | Discount? -->
                                 <p class="text-slate-500 italic">Calculating...</p>
                             </div>
                             <div class="flex justify-between items-center pt-3 border-t border-slate-200">
                                 <span class="font-bold text-slate-700">Total Annual Tuition:</span>
                                 <span id="tuition-grand-total" class="font-bold text-2xl text-teal-600">$0.00</span>
                             </div>
                             <p class="text-xs text-slate-500 mt-2">*Sibling discount (10%) applies to 2nd+ child in KG-8th grade (applied to lower tuition).</p>
                             <p class="text-xs text-slate-500">**Pre-K / Acc. HS students are not eligible for sibling discounts.</p>
                         </div>

                         <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                             <h5 class="font-bold text-slate-800 mb-3">Select Payment Plan</h5>
                             <p class="text-sm text-slate-600 mb-4">Monthly payments for those enrolling after June 1, 2026 will start based on the month enrolled and end on March 1, 2027.</p>
                             
                             <div class="space-y-3">
                                <label class="flex items-center p-3 border border-slate-200 rounded bg-white hover:bg-slate-50 cursor-pointer">
                                    <input type="radio" name="payment-plan" value="LumpSum" class="h-5 w-5 text-teal-600">
                                    <span class="ml-3 font-medium">Lump sum payment to be invoiced and due by June 1, 2026</span>
                                </label>
                                <label class="flex items-center p-3 border border-slate-200 rounded bg-white hover:bg-slate-50 cursor-pointer">
                                    <input type="radio" name="payment-plan" value="10Month" class="h-5 w-5 text-teal-600">
                                    <span class="ml-3 font-medium">10-monthly payments to be invoiced with due dates from June 1, 2026 to March 1, 2027</span>
                                </label>
                             </div>
                         </div>

                         <div class="flex justify-between mt-6">
                            <button onclick="wizardPrev('info')" class="text-slate-500 hover:text-slate-800">Back</button>
                            <button onclick="wizardNext('agreement')" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700">Next &rarr;</button>
                        </div>
                    </div>

                    <!-- Step 5: Tuition Agreement -->
                    <div id="step-agreement" class="wizard-step hidden">
                        <h4 class="text-2xl font-bold text-slate-800 mb-4">Tuition Agreement</h4>
                        <p class="mb-2 text-sm text-red-600">Please scroll to the bottom of the agreement to sign.</p>
                        
                        <div id="agreement-text-box" class="agreement-scroll border border-slate-300 rounded p-4 h-64 overflow-y-scroll bg-slate-50 text-sm text-slate-700 leading-relaxed mb-4">
                            <p class="font-bold">Silicon Valley Academy’s Tuition Policy requires that:</p>
                            <p>Tuition payments will be invoiced and paid through GradeLink. Accepted payment forms include ACH/checking account and credit card.</p>
                            <br>
                            <p>Once your child has been formally admitted for the 2026-2027 school year, you will be required to set-up an auto payment plan for the 2026-2027 tuition fees within two weeks to keep your child's admission active. Based on the payment option you selected during the enrollment process, you will need to either set up a one-time lump sum payment to be made on 6/1/26 or 10-monthly payments with the first payment starting on 6/1/26 in the parent GradeLink account. If an auto payment plan is not set up within two weeks, your child’s name will be removed from SVA enrollment and moved to the bottom of the waitlist.</p>
                            <br>
                            <p>At the time of registration, a $150 non-refundable registration fee is due per child.</p>
                            <br>
                            <p class="font-bold underline">Tuition Liability & Early Termination Policy</p>
                            <p><strong>1. Nature of the Financial Obligation:</strong> Enrollment at Silicon Valley Academy constitutes a binding financial contract for the entire academic year (or the remaining portion thereof for mid-year enrollees). The School’s expenses are fixed annually; therefore, the family’s financial obligation is for the full Total Contract Value, not on a "pay-as-you-go" basis. The School expressly reserves the legal right to demand and collect the full annual tuition balance regardless of the date of withdrawal.</p>
                            <p><strong>2. Voluntary Withdrawal & Settlement Calculation:</strong> Should the School agree to a settlement based on early termination, liability is determined strictly according to the 10-Month Fiscal Accrual Schedule (June 1 – April 1) as follows:</p>
                            <ul class="list-disc pl-5">
                                <li><strong>A. Minimum Earned Tuition (Non-Refundable Deposit):</strong> Immediately upon enrollment, 30% of the Total Contract Value is considered fully earned by the School. This portion represents reasonable liquidated damages for administrative overhead, seat reservation, and the initial billing quarter (June, July, August) and is non-refundable under any circumstances.</li>
                                <li><strong>B. Accrual of Instructional Tuition:</strong> Commencing on September 1st, tuition is earned by the School in monthly installments of 10%. Mid-Month Withdrawals: For any partial month of attendance, tuition is earned on a pro-rata basis calculated daily from the first day of that month through the date of withdrawal.</li>
                                <li><strong>C. Liquidated Damages for Early Termination:</strong> In recognition of the difficulty in filling vacancies mid-year, an Early Termination Fee equal to 20% of the remaining unearned contract balance will be assessed. This fee is agreed to be a reasonable estimate of the School’s damages and is not a penalty.</li>
                            </ul>
                            <p><strong>3. Contract Maturity (The "April 1st Lock"):</strong> By April 1st, the sum of the Minimum Earned Tuition and Accrued Instructional Tuition equals 100% of the Contract Value. Consequently, any withdrawal occurring on or after April 1st results in full financial liability for the entire annual tuition, with no refunds or adjustments permitted.</p>
                            <p><strong>4. Hardship & Compassionate Review:</strong> While the financial obligations outlined above are binding to ensure the School's operational stability, Silicon Valley Academy remains deeply committed to supporting our families. We understand that unforeseen life events occur. Appeal Process: In cases of severe, documented financial hardship (e.g., significant loss of income, medical emergency, or relocation due to employment), families may submit a formal written appeal to the Board of Directors regarding the Early Termination Fee. Discretionary Relief: Modifications to the liability policy are rare and granted solely at the Board's discretion on a case-by-case basis. This provision does not guarantee a waiver but ensures every family is heard with compassion.</p>
                            <br>
                            <p>We encourage parent(s)/guardian(s) to volunteer each semester. Families with one child enrolled are asked to volunteer 10 hours per semester. Families with two or more children enrolled are asked to volunteer 20 hours per semester. Please note, volunteer hours do not carry over between semesters or years nor are they prorated.</p>
                            <p>If a family chooses to opt out of volunteering upon enrollment for the first semester, a volunteer fee of $350 will be charged to the family’s Gradelink account and due 7/1/26.</p>
                            <p>If a family chooses to opt out of volunteering upon enrollment for the second semester, a volunteer fee of $350 will be charged to the family’s Gradelink account and due 1/1/27.</p>
                            <p>If a family’s required volunteer hours from the first semester are not fulfilled by January 14, 2027, a volunteer fee of $450 will be charged to the family’s February statement in GradeLink.</p>
                            <p>If a family’s required volunteer hours from the second semester are not fulfilled by June 4, 2027, a volunteer fee of $450 will be charged to the family’s July statement in GradeLink.</p>
                            <br>
                            <p>Parent(s)/guardian(s) will be assessed a $35 fee on any charge that is late or does not clear.</p>
                            <p>Parent(s)/guardian(s) will be assessed a 2.5% convenience fee for credit card payments.</p>
                        </div>
                        
                        <div class="mb-4">
                             <label class="flex items-center">
                                <input type="checkbox" id="tuition-agree-check" class="mr-2 text-teal-600 focus:ring-teal-500 h-5 w-5" disabled>
                                <span class="font-bold text-slate-800">I agree to the Tuition Policy and Liability terms above.</span>
                            </label>
                        </div>

                        <div class="flex justify-between">
                            <button onclick="wizardPrev('tuition')" class="text-slate-500 hover:text-slate-800">Back</button>
                            <button onclick="wizardNext('payment')" id="btn-agreement-next" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700 opacity-50 cursor-not-allowed" disabled>Agree & Continue</button>
                        </div>
                    </div>

                    <!-- Step 6: Payment -->
                    <div id="step-payment" class="wizard-step hidden">
                        <h4 class="text-2xl font-bold text-slate-800 mb-4">Finalize & Submit</h4>
                        
                        <div class="bg-yellow-50 p-4 rounded border border-yellow-200 mb-6">
                            <p class="text-sm text-yellow-800">Please download, read, and review <a href="#" class="underline font-bold">SVA's Parent Handbook</a> found at the parent portal with SVA's policies and procedures.</p>
                        </div>

                        <div class="mb-6">
                             <h5 class="font-bold text-slate-800 mb-2">Payment Required: <span id="payment-amount" class="text-teal-600">$0.00</span></h5>
                             <p class="text-sm text-slate-600 mb-4">Total for <span id="payment-student-count">0</span> student(s). This is a token verification payment ($1 per student).</p>
                             <div id="paypal-button-container"></div>
                             <div id="payment-completed-msg" class="hidden bg-green-100 text-green-800 p-3 rounded font-bold text-center">Payment Verified!</div>
                        </div>

                        <div class="mb-6">
                            <label class="block mb-2 font-bold text-slate-800">Initials:</label>
                            <input type="text" id="final-initials" class="border border-slate-300 rounded p-2 w-32 uppercase" placeholder="XX" maxlength="4">
                            <p class="text-xs text-slate-500 mt-1">By initialing here and pressing submit, I hereby agree to all Silicon Valley Academy policies and procedures, including but not limited to the tuition policy, parent-volunteer policy, parent honor code, and student disciplinary code.</p>
                        </div>

                        <p class="text-xs text-slate-500 mb-4">You will not be able to re-enter your student's registration once you press "submit." If you are unable to complete all parts of the registration, your information will be automatically saved and you can log in at a later time to complete the process.</p>

                        <div class="flex justify-between items-center">
                            <button onclick="wizardPrev('agreement')" class="text-slate-500 hover:text-slate-800">Back</button>
                            <button onclick="submitEnrollment()" id="btn-submit-enrollment" class="bg-teal-600 text-white px-8 py-3 rounded-lg hover:bg-teal-700 shadow-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>Submit Re-enrollment</button>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <div class="min-h-screen bg-slate-50">
            <header class="bg-white shadow-sm sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-12 w-auto">
                            </div>
                            <div class="ml-4">
                                <h1 class="text-2xl font-bold text-slate-900">Silicon Valley Academy</h1>
                                <p class="text-sm text-slate-500">Parent Portal (beta)</p>
                            </div>
                        </div>
                        <div class="hidden sm:flex items-center">
                            <div id="user-info-desktop" class="mr-4 text-right"></div>
                            <button onclick="signOut();" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300">Sign Out</button>
                        </div>
                        <div class="sm:hidden flex items-center">
                            <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-slate-500 hover:text-white hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                                <span class="sr-only">Open main menu</span>
                                <i id="menu-icon-open" class="ph-list text-2xl"></i>
                                <i id="menu-icon-close" class="ph-x text-2xl hidden"></i>
                            </button>
                        </div>
                    </div>
                </div>
                 <div class="sm:hidden" id="mobile-menu">
                    <div class="pt-4 pb-3 border-b border-slate-200">
                        <div id="user-info-mobile" class="px-5"></div>
                    </div>
                    <div id="main-nav-mobile" class="px-2 pt-2 pb-3 space-y-1"></div>
                    <div class="pt-4 pb-3 border-t border-slate-200">
                        <div class="px-2">
                             <button onclick="signOut();" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300">Sign Out</button>
                        </div>
                    </div>
                </div>
            </header>

            <nav class="hidden sm:block bg-white border-b border-slate-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div id="main-nav" class="flex justify-center -mb-px">
                        <button class="tab-btn tab-active text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="dashboard"><i class="ph-house mr-2"></i>Student Dashboard</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="actions"><i class="ph-bell-ringing mr-2"></i>Actions</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="volunteering"><i class="ph-hands-clapping mr-2"></i>Volunteering</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="signups"><i class="ph-list-checks mr-2"></i>My Signups</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="pto"><i class="ph-users-three mr-2"></i>PTO</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="faq-forms"><i class="ph-link mr-2"></i>Resources</button>
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="live-event"><i class="ph-video-camera-fill mr-2"></i>Live Events</button>  
                        <button class="tab-btn text-slate-600 hover:text-teal-600 py-4 px-5 block focus:outline-none text-sm font-medium" data-tab="calendar"><i class="ph-calendar mr-2"></i>Calendar</button>
                    </div>
                </div>
            </nav>

            <main class="max-w-7xl mx-auto py-8 sm:py-10 px-4 sm:px-6 lg:px-8">
                <div id="dashboard" class="tab-content tab-content-active">
                     <h2 class="text-3xl font-bold text-slate-900 mb-6">My Students</h2>
                    <div id="student-content-container" class="space-y-12"></div>
                </div>
                
                <div id="actions" class="tab-content">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">Actions</h2>
                    <!-- Added id to container for easy injection -->
                    <div id="actions-content-container" class="space-y-10"></div>
                </div>
                
                <!-- ... Other tabs (volunteering, signups, pto, faq, etc.) same as before ... -->
                <div id="volunteering" class="tab-content">
                     <h2 class="text-3xl font-bold text-slate-900 mb-6">Volunteering Opportunities</h2>
                    <div class="mb-6 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-2">Volunteering Objectives & Rules</h3>
                        <p class="text-slate-600 text-sm">
                            Our parent volunteer program is essential to the success of our school community. The primary objective is to foster a strong partnership between parents and the school, enriching our students' educational experience. We require each family to complete a set number of volunteer hours per school year, divided between two semesters. Please sign up for opportunities that match your interests and schedule. If you must withdraw from a commitment, please do so at least three weeks in advance to allow another parent to take the spot. Failure to show up for a signed-up event without prior cancellation will result in a penalty, increasing your total required hours. For safety reasons, we ask that you do not bring small children while volunteering. We recommend arranging childcare during your volunteer shift. Thank you for your dedication to our students and school!
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="filter-semester" class="block text-sm font-medium text-slate-700">Semester</label>
                                <select id="filter-semester" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="all">All</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-event" class="block text-sm font-medium text-slate-700">Filter by Event</label>
                                <select id="filter-event" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="all">All Events</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-time" class="block text-sm font-medium text-slate-700">Time of Day</label>
                                <select id="filter-time" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option>All</option>
                                    <option>Morning</option>
                                    <option>Afternoon</option>
                                    <option>Evening</option>
                                    <option>All Day</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-hours" class="block text-sm font-medium text-slate-700">Max Hours</label>
                                <select id="filter-hours" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="99">Any</option>
                                    <option value="2">Up to 2</option>
                                    <option value="4">Up to 4</option>
                                    <option value="8">Up to 8</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-location" class="block text-sm font-medium text-slate-700">Location</label>
                                <select id="filter-location" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option>All</option>
                                    <option>On-Campus</option>
                                    <option>Remote</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-sort" class="block text-sm font-medium text-slate-700">Sort By</label>
                                <select id="filter-sort" class="filter-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="default">Default</option>
                                    <option value="recent">Recently Added</option>
                                </select>
                            </div>
                        </div>
                    </div>
                     <div id="volunteering-list" class="space-y-6"><p>Loading volunteering opportunities...</p></div>
                </div>
                <div id="signups" class="tab-content"><h2 class="text-3xl font-bold text-slate-900 mb-6">My Volunteer Hours</h2><div id="my-signups-content"></div></div>
                <div id="pto" class="tab-content">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">Parent-Teacher Organization (PTO)</h2>
                    <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold text-teal-700 mb-2">Building a Strong School Community Together</h3>
                            <p class="text-slate-600 leading-relaxed">As-salamu alaykum! The SVA Parent-Teacher Organization (PTO) warmly welcomes all new and returning families. We believe that a high level of parent participation is critical to the success of our students' education, tarbiyah, and development. The PTO is a formal, volunteer-based organization of parents, teachers, and staff working together to enhance the SVA student experience.</p>
                        </div>
                        <div class="border-t border-slate-200 pt-6">
                            <h3 class="text-xl font-semibold text-teal-700 mb-3">Our Mission & Key Roles</h3>
                            <ul class="list-disc list-inside space-y-3 text-slate-600">
                                <li><strong>Organize Enriching Events:</strong> We plan and execute co-curricular events and activities like International Day, Book Fairs, Movie Nights, and the Hajj Simulation to enrich our children's education.</li>
                                <li><strong>Raise Funds:</strong> Through community efforts, we raise funds to support vital school programs, classroom needs, and new initiatives.</li>
                                <li><strong>Build Community:</strong> We strive to create a strong, collaborative, and supportive environment that connects parents, teachers, and staff.</li>
                                <li><strong>Shape the Educational Experience:</strong> The PTO provides a valuable opportunity for parents to have a voice and actively contribute to their children's journey at SVA.</li>
                            </ul>
                        </div>
                         <div class="border-t border-slate-200 pt-6">
                            <h3 class="text-xl font-semibold text-teal-700 mb-2">Get Involved</h3>
                            <p class="text-slate-600 mb-4">Every parent and guardian at SVA is automatically a member of the PTO! We encourage you to get involved. You can sign up to be a committee member for a specific event or support year-long school programs.</p>
                            <div class="bg-teal-50 p-5 rounded-lg border border-teal-200">
                                <h4 class="font-semibold text-slate-800">2025-26 PTO Volunteering Leads:</h4>
                                <ul class="list-disc list-inside mt-2 text-slate-700">
                                    <li>Sara M.</li>
                                    <li>Rubeka A.</li>
                                    <li>Esraa El T.</li>
                                    <li>Ahmed S.</li>
                                </ul>
                                <p class="mt-4 text-sm">Interested in becoming a PTO lead, helping out, or have a question? To reach the PTO leadership, please email <a href="mailto:pto@svamail.com" class="text-teal-600 font-semibold hover:underline">pto@svamail.com</a>.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="faq-forms" class="tab-content"><h2 class="text-3xl font-bold text-slate-900 mb-6">Resources</h2><div id="faq-content"></div></div>
                <div id="live-event" class="tab-content"></div>
                <div id="calendar" class="tab-content"><h2 class="text-3xl font-bold text-slate-900 mb-6">Calendar</h2><div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><iframe src="https://calendar.google.com/calendar/embed?src=svaschool.org_us4ga4j1cfs27epj0f2dfegcl0%40group.calendar.google.com&ctz=America/Los_Angeles" style="border: 0" width="100%" height="600" frameborder="0" scrolling="no"></iframe></div></div>
            </main>
            
            <footer class="bg-white mt-12 border-t border-slate-200">
                 <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-slate-500 text-sm"><p>&copy; 2025 BMNS. All Rights Reserved - (parent.portal@svaschool.org)</p></div>
            </footer>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwQWDkjjXqT7V2x4N3ea9IvqBbvI7QJ2qaMLVyXbpg2pBJxsVl_5r00kaLZXJNDw_mw/exec';
        const NEWSLETTER_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdZkNNppgbr_FdH2FOAztYpujc9A4URAsQIlWnADSypDlb5_KnCiVP3EImRK96jWK3Yg/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";
        let ID_TOKEN = null;
        let portalData = {};
        let enrollmentState = { selectedStudents: [], contactStatus: '', volunteerOptOutS1: false, volunteerOptOutS2: false, paymentPlan: null, paymentID: null, totalAmount: 0, initials: '' };

        // --- ENROLLMENT WIZARD LOGIC ---
        function startEnrollment() {
            openModal('enrollment-modal');
            startCountdown();
            populateStudentSelection();
            wizardNext('start');
            
            // Populate contact info from the first eligible student record (as they share family info)
            // Note: Data now comes primarily from Enrollment sheet records in `students` array
            const student = portalData.students.find(s => s.enrollmentDetails);
            if(student && student.enrollmentDetails) {
                 const d = student.enrollmentDetails;
                 document.getElementById('contact-father').textContent = d.father || 'Not listed';
                 document.getElementById('contact-mother').textContent = d.mother || 'Not listed';
                 document.getElementById('contact-phone1').textContent = d.phone1 || 'Not listed';
                 document.getElementById('contact-phone2').textContent = d.phone2 || 'Not listed';
                 document.getElementById('contact-phone3').textContent = d.phone3 || 'Not listed';
                 document.getElementById('contact-emails').textContent = d.emails || 'Not listed';
                 document.getElementById('contact-address').innerHTML = `${d.street || ''}<br>${d.city || ''}, ${d.state || ''} ${d.zip || ''}`;
            }
        }

        function populateStudentSelection() {
            const container = document.getElementById('enrollment-student-list');
            container.innerHTML = '';
            
            // Show all students associated with the family
            // Enabled only if NOT already enrolled (Timestamp is empty)
            portalData.students.forEach(s => {
                const details = s.enrollmentDetails || {};
                const isEnrolled = details.timestamp && details.timestamp !== '';
                
                const div = document.createElement('div');
                div.className = `flex items-center p-3 border rounded ${isEnrolled ? 'bg-green-50 border-green-200' : 'hover:bg-slate-50 border-slate-200'} cursor-pointer`;
                
                div.innerHTML = `
                    <label class="flex items-center w-full ${isEnrolled ? 'cursor-not-allowed opacity-75' : 'cursor-pointer'}">
                        <input type="checkbox" class="enroll-student-check form-checkbox h-5 w-5 text-teal-600" value="${s.uniqueStudentId}" ${isEnrolled ? 'disabled' : 'checked'}>
                        <div class="ml-3 flex-1">
                            <span class="font-bold text-slate-800">${s.studentName}</span>
                            <span class="text-slate-500 text-sm ml-2">Next: ${details.nextgradelevel || 'N/A'}</span>
                            ${isEnrolled ? '<span class="ml-2 text-green-700 font-bold text-xs uppercase bg-green-200 px-2 py-1 rounded">Enrolled</span>' : ''}
                        </div>
                    </label>
                `;
                container.appendChild(div);
            });
            
            // If all are enrolled
            if (portalData.students.every(s => s.enrollmentDetails && s.enrollmentDetails.timestamp)) {
                container.innerHTML = '<p class="text-green-600 font-bold p-4 bg-green-50 rounded text-center">All eligible students have been re-enrolled!</p>';
            }
        }
        
        function calculateTuition(selectedIds) {
            const students = portalData.students.filter(s => selectedIds.includes(String(s.uniqueStudentId)));
            const container = document.getElementById('tuition-calculation-container');
            container.innerHTML = '';
            
            let items = [];
            
            // 1. Identify Rates & Categories
            students.forEach(s => {
                const grade = String(s.enrollmentDetails?.nextgradelevel || '').toUpperCase();
                let rate = 0;
                let category = 'OTHER'; // KG-8, PREK, HS
                
                // Rate Logic
                if (['K', 'KG', '0', '1', '2', '3', '4', '5'].includes(grade)) { rate = 12800; category = 'KG-8'; }
                else if (['6', '7', '8'].includes(grade)) { rate = 14200; category = 'KG-8'; }
                else if (grade.includes('PK') || grade.includes('PRE')) { rate = 17700; category = 'PREK'; } // Default to School-Day
                else { rate = 10500; category = 'HS'; }
                
                items.push({ name: s.studentName, grade: grade, baseRate: rate, category: category, finalRate: rate, discount: 0 });
            });

            // 2. Apply Discount (KG-8 Only, applied to lower tuitions)
            // Sort KG-8 students by Base Rate Descending
            const kg8Students = items.filter(i => i.category === 'KG-8');
            kg8Students.sort((a, b) => b.baseRate - a.baseRate);
            
            // First one pays full, rest get 10%
            kg8Students.forEach((item, index) => {
                if (index > 0) {
                    item.discount = item.baseRate * 0.10;
                    item.finalRate = item.baseRate - item.discount;
                }
            });
            
            // 3. Render
            let grandTotal = 0;
            items.forEach(item => {
                grandTotal += item.finalRate;
                const discountBadge = item.discount > 0 ? `<span class="text-green-600 text-xs font-bold ml-2">(-$${item.discount.toLocaleString()})</span>` : '';
                const row = document.createElement('div');
                row.className = "flex justify-between items-center text-sm border-b border-slate-100 py-2 last:border-0";
                row.innerHTML = `
                    <div><span class="font-semibold text-slate-700">${item.name}</span> <span class="text-slate-400 text-xs">(${item.grade})</span></div>
                    <div><span class="font-medium text-slate-800">$${item.finalRate.toLocaleString()}</span> ${discountBadge}</div>
                `;
                container.appendChild(row);
            });
            
            document.getElementById('tuition-grand-total').textContent = `$${grandTotal.toLocaleString()}`;
        }

        function wizardNext(stepId) {
            if (stepId === 'contacts') {
                const selected = document.querySelectorAll('.enroll-student-check:checked');
                if (selected.length === 0) { document.getElementById('enrollment-error').classList.remove('hidden'); return; }
                enrollmentState.selectedStudents = Array.from(selected).map(cb => cb.value);
                document.getElementById('enrollment-error').classList.add('hidden');
            }
            if (stepId === 'info') {
                 const verify = document.querySelector('input[name="contact-verify"]:checked');
                 if (!verify) { alert("Please indicate if the contact information is correct."); return; }
                 enrollmentState.contactStatus = verify.value;
            }
            if (stepId === 'tuition') {
                const agreed = document.getElementById('volunteer-agree-check').checked;
                if (!agreed) { alert("Please agree to the volunteer obligation."); return; }
                enrollmentState.volunteerOptOutS1 = document.getElementById('opt-out-s1').checked;
                enrollmentState.volunteerOptOutS2 = document.getElementById('opt-out-s2').checked;
                
                // Calculate Total for display
                calculateTuition(enrollmentState.selectedStudents);
            }
            if (stepId === 'agreement') {
                const plan = document.querySelector('input[name="payment-plan"]:checked');
                if (!plan) { alert("Please select a payment plan."); return; }
                enrollmentState.paymentPlan = plan.value;
                 setTimeout(() => {
                    const box = document.getElementById('agreement-text-box');
                    const check = document.getElementById('tuition-agree-check');
                    const btn = document.getElementById('btn-agreement-next');
                    box.onscroll = function() { if (box.scrollTop + box.offsetHeight >= box.scrollHeight - 20) { check.disabled = false; } };
                    check.onchange = function() { btn.disabled = !check.checked; btn.classList.toggle('opacity-50', !check.checked); btn.classList.toggle('cursor-not-allowed', !check.checked); }
                }, 100);
            }
            if (stepId === 'payment') {
                enrollmentState.totalAmount = enrollmentState.selectedStudents.length * 1.00;
                document.getElementById('payment-student-count').textContent = enrollmentState.selectedStudents.length;
                document.getElementById('payment-amount').textContent = `$${enrollmentState.totalAmount.toFixed(2)}`;
                renderPayPalButton();
            }

            document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
            document.getElementById('step-' + stepId).classList.remove('hidden');
        }

        function renderPayPalButton() {
            const container = document.getElementById('paypal-button-container');
            container.innerHTML = '';
            if (enrollmentState.paymentID) { container.innerHTML = '<p class="text-green-600 font-bold">Payment already completed.</p>'; return; }
            paypal.Buttons({
                style: {
                    shape: 'rect',
                    color: 'gold',
                    layout: 'vertical',
                    label: 'pay'
                },
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: enrollmentState.totalAmount.toFixed(2) },
                            description: "SVA Enrollment Fee Collection"
                        }],
                        application_context: {
                            shipping_preference: 'NO_SHIPPING', // Removes shipping address requirement
                            brand_name: 'Silicon Valley Academy',
                            user_action: 'PAY_NOW'
                        }
                    });
                },
                onApprove: function(data, actions) { return actions.order.capture().then(function(details) {
                    enrollmentState.paymentID = details.id;
                    document.getElementById('payment-completed-msg').classList.remove('hidden');
                    document.getElementById('btn-submit-enrollment').disabled = false;
                    document.getElementById('paypal-button-container').classList.add('hidden');
                }); }
            }).render('#paypal-button-container');
        }

        function submitEnrollment() {
            const initials = document.getElementById('final-initials').value.trim();
            if (initials.length < 2) { alert("Please provide your initials."); return; }
            if (!enrollmentState.paymentID) { alert("Please complete the payment."); return; }
            const btn = document.getElementById('btn-submit-enrollment');
            btn.textContent = 'Submitting...'; btn.disabled = true;

            const selectedStudentObjs = portalData.students.filter(s => enrollmentState.selectedStudents.includes(String(s.uniqueStudentId)));

            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'enrollmentSubmit', token: ID_TOKEN,
                    students: selectedStudentObjs,
                    contactStatus: enrollmentState.contactStatus,
                    volunteerS1: enrollmentState.volunteerOptOutS1,
                    volunteerS2: enrollmentState.volunteerOptOutS2,
                    paymentPlan: enrollmentState.paymentPlan,
                    paymentID: enrollmentState.paymentID,
                    initials: initials
                })
            }).then(() => {
                alert('Re-enrollment submitted successfully! A confirmation email has been sent.');
                closeModal('enrollment-modal');
                fetchData(ID_TOKEN);
            }).catch(err => {
                console.error(err);
                alert("Submission failed. Please contact support.");
                btn.disabled = false; btn.textContent = 'Submit Re-enrollment';
            });
        }
        
        // --- STANDARD APP LOGIC (Minified/Condensed where unchanged) ---
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function showLoginScreen(screenId) { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('passkey-verify-screen').classList.add('hidden'); if (document.getElementById(screenId)) { document.getElementById(screenId).classList.remove('hidden'); } }
        function formatDate(dateString) { if (!dateString) return 'N/A'; const date = new Date(dateString); return !isNaN(date.getTime()) ? date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : dateString; }
        function decodeGrade(grade) { const gradeStr = String(grade).toUpperCase(); if (gradeStr === 'P') return 'Pre-K'; if (gradeStr === '0' || gradeStr === 'K' ) return 'KG'; return `Grade ${gradeStr}`; }
        function switchToTab(tabName) { document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active')); document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active')); document.querySelectorAll(`.tab-btn[data-tab="${tabName}"]`).forEach(b => b.classList.add('tab-active')); document.getElementById(tabName).classList.add('tab-content-active'); }
        function wizardPrev(stepId) { document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden')); document.getElementById('step-' + stepId).classList.remove('hidden'); }
        function startCountdown() { const dest = new Date("Feb 16, 2026 08:30:00").getTime(); setInterval(function() { const now = new Date().getTime(); const diff = dest - now; if (diff < 0) { document.getElementById("priority-countdown").innerHTML = "Priority Window Closed"; } else { const days = Math.floor(diff / (1000 * 60 * 60 * 24)); document.getElementById("priority-countdown").innerHTML = days + "d " + Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)) + "h " + Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)) + "m"; } }, 1000); }
        function handleCredentialResponse(response) { handleLoginSuccess(response.credential); }
        function handleLoginSuccess(idToken) { ID_TOKEN = idToken; localStorage.setItem('sva_id_token', idToken); document.getElementById('login-container').classList.add('hidden'); document.getElementById('loading-overlay').classList.remove('hidden'); const profile = JSON.parse(atob(ID_TOKEN.split('.')[1])); const userInfoHtml = `<div class="flex items-center"><img class="h-8 w-8 rounded-full" src="${profile.picture}" alt=""><div class="ml-3"><div class="text-base font-medium text-slate-800">${profile.name}</div><div class="text-sm font-medium text-slate-500">${profile.email}</div></div></div>`; document.getElementById('user-info-desktop').innerHTML = userInfoHtml; document.getElementById('user-info-mobile').innerHTML = userInfoHtml; fetchData(ID_TOKEN); fetchAndRenderResources(); addEventListeners(); }
        function handleTokenExpired(message) { localStorage.removeItem('sva_id_token'); ID_TOKEN = null; document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('portal-container').classList.add('hidden'); document.getElementById('login-container').classList.remove('hidden'); document.getElementById('login-error-text').textContent = message; document.getElementById('login-error-msg').classList.remove('hidden'); }
        function signOut() { google.accounts.id.disableAutoSelect(); localStorage.removeItem('sva_id_token'); window.location.href = window.location.pathname; }
        
        // --- HELPER FUNCTIONS ---
        function formatGoogleDate(date) { return date.toISOString().split('T')[0].replace(/-/g, ''); }
        
        function generateICalLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const reminder1Date = new Date(startDate);
            reminder1Date.setDate(reminder1Date.getDate() - 22);
            const reminder1Trigger = `${formatGoogleDate(reminder1Date)}T090000`;
            const reminder1 = `BEGIN:VALARM\nTRIGGER;VALUE=DATE-TIME:${reminder1Trigger}\nACTION:DISPLAY\nDESCRIPTION:Last chance to withdraw from this event is tomorrow\nEND:VALARM`;
            const reminder2Date = new Date(startDate);
            reminder2Date.setDate(reminder2Date.getDate() - 7);
            const reminder2Trigger = `${formatGoogleDate(reminder2Date)}T090000`;
            const reminder2 = `BEGIN:VALARM\nTRIGGER;VALUE=DATE-TIME:${reminder2Trigger}\nACTION:DISPLAY\nDESCRIPTION:Your event is a week away!\nEND:VALARM`;
            const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nURL:${document.location.href}\nDTSTART;VALUE=DATE:${formatGoogleDate(startDate)}\nDTEND;VALUE=DATE:${formatGoogleDate(endDate)}\nSUMMARY:${event.name || event.title}\nDESCRIPTION:Event: ${event.name || event.title}\nLOCATION:Silicon Valley Academy\n${reminder1}\n${reminder2}\nEND:VEVENT\nEND:VCALENDAR`;
            return `data:text/calendar;charset=utf-8,${encodeURIComponent(icsContent)}`;
        }

        function generateGoogleCalendarLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const reminderText1 = "Reminder: The last day to withdraw from this event is 21 days prior.";
            const reminderText2 = "Reminder: This event is one week from today.";
            const description = `For more details, visit the school portal.\n\n--- Reminders ---\n${reminderText1}\n${reminderText2}`;
            const baseUrl = 'https://www.google.com/calendar/render?action=TEMPLATE';
            const title = `&text=${encodeURIComponent(event.name || event.title)}`;
            const dates = `&dates=${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
            const details = `&details=${encodeURIComponent(description)}`;
            const location = `&location=${encodeURIComponent('Silicon Valley Academy')}`;
            return `${baseUrl}${title}${dates}${details}${location}`;
        }
        
        function fetchData(token) {
            fetch(`${WEB_APP_URL}?token=${token}`).then(r => r.json()).then(data => {
                document.getElementById('loading-overlay').classList.add('hidden');
                if (data.status !== 'success' || !data.data) { if (data.error?.includes("Authentication")) return handleTokenExpired(data.error); throw new Error(data.error); }
                portalData = data.data;
                document.getElementById('portal-container').classList.remove('hidden');
                renderDashboard(portalData.students); renderActionsTab(portalData.students);
                populateEventFilter(portalData.allEvents);
                applyAndRenderFilters(); 
                renderMySignups(portalData.volunteerProgress);
                renderMySignupsList(portalData.mySignups);
                renderMobileMenu();
                if (typeof phosphor !== 'undefined') phosphor.replace();
            }).catch(e => { console.error(e); handleTokenExpired(e.message); });
        }

        function fetchAndRenderResources() {
            fetch(`${NEWSLETTER_WEB_APP_URL}?token=${ID_TOKEN}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderFAQ(data.data.faq);
                        renderForms(data.data.forms);
                        renderNewsletters(data.data.newsletters);
                        renderQuickLinks(data.data.quickLinks);
                        renderLiveEvent(data.data.liveEvent);
                    } else { throw new Error(data.error); }
                })
                .catch(error => {
                    console.error('Resources Fetch Error:', error);
                    if (document.getElementById('newsletters-content')) document.getElementById('newsletters-content').innerHTML = '<p class="text-red-500">Could not load newsletters.</p>';
                    if (document.getElementById('quicklinks-content')) document.getElementById('quicklinks-content').innerHTML = '<p class="text-red-500">Could not load quick links.</p>';
                });
        }
        
        function renderFAQ(faqItems) {
            const container = document.getElementById('faq-content');
            if (!container) return;
            if (!faqItems || faqItems.length === 0) {
                container.innerHTML = '<p class="text-slate-500">No FAQ items found.</p>';
                return;
            }
            container.innerHTML = faqItems.map(item => `
                <div class="mb-4 py-2 border-b border-slate-200 last:border-b-0">
                    <h4 class="font-bold text-slate-800">Q: ${item.question}</h4>
                    <p class="text-slate-600 mt-1">A: ${item.answer}</p>
                </div>
            `).join('');
        }

        function renderForms(forms) {
            const container = document.getElementById('forms-content');
            if (!container) return;
            if (!forms || forms.length === 0) {
                container.innerHTML = '<p class="text-slate-500">No forms found.</p>';
                return;
            }
            container.innerHTML = `<ul class="space-y-4">` + forms.map(form => `
                <li class="border-b border-slate-200 pb-3 last:border-b-0">
                    <a href="${form.link}" target="_blank" class="text-teal-600 hover:underline font-semibold">${form.title}</a>
                    <p class="text-sm text-slate-600 mt-1">${form.description}</p>
                </li>
            `).join('') + `</ul>`;
        }

        function renderNewsletters(newsletters) {
            const container = document.getElementById('newsletters-content');
            if (!container) return;

            let listItems = '';
            if (!newsletters || newsletters.length === 0) {
                listItems = '<li><p class="text-slate-500">No newsletters found.</p></li>';
            } else {
                listItems = newsletters.map(n => 
                    `<li class="border-b border-slate-200 pb-2 last:border-b-0"><a href="${n.link}" target="_blank" class="text-teal-600 hover:underline">${n.title}</a></li>`
                ).join('');
            }
            container.innerHTML = `<ul class="space-y-3">${listItems}</ul>`;
        }

        function renderQuickLinks(links) {
            const container = document.getElementById('quicklinks-content');
            if (!container) return;

            let listItems = '';
            if (!links || links.length === 0) {
                listItems = '<li><p class="text-slate-500">No links found.</p></li>';
            } else {
                listItems = links.map(l => 
                    `<li class="border-b border-slate-200 pb-2 last:border-b-0"><a href="${l.link}" target="_blank" class="text-teal-600 hover:underline">${l.title}</a></li>`
                ).join('');
            }
            container.innerHTML = `<ul class="space-y-3">${listItems}</ul>`;
        }

        function renderLiveEvent(liveEventData) {
    const container = document.getElementById('live-event');
    if (!container) return;
    if (liveEventData && liveEventData.length > 0) {
        const eventsHtml = liveEventData.map(liveEvent => {
            if (!liveEvent.link) return ''; 
            let embedUrl = '';
            if (liveEvent.link.includes('vimeo.com/')) {
                try {
                    const url = new URL(liveEvent.link);
                    url.searchParams.set('autoplay', '1');
                    url.searchParams.set('title', '0');
                    url.searchParams.set('byline', '0');
                    url.searchParams.set('portrait', '0');
                    embedUrl = url.toString();
                } catch (e) { embedUrl = liveEvent.link; }
            }
            if (embedUrl) {
                return `
                    <div class="mb-8 -mx-4 sm:mx-0">
                        <div class="bg-white sm:rounded-lg shadow-sm overflow-hidden">
                            <div class="relative w-full h-[600px] sm:h-0 sm:pb-[56.25%]">
                                <iframe 
                                    src="${embedUrl}" 
                                    frameborder="0" 
                                    allow="autoplay; fullscreen; picture-in-picture" 
                                    allowfullscreen 
                                    style="position:absolute;top:0;left:0;width:100%;height:100%;" 
                                    class="sm:rounded-t-lg">
                                </iframe>
                            </div>
                            <div class="p-4 sm:p-6">
                                 <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">${liveEvent.title || 'Live School Event'}</h2>
                            </div>
                        </div>
                    </div>
                `;
            }
            return '';
        }).join('');
        container.innerHTML = eventsHtml || `<h2 class="text-3xl font-bold text-slate-900 mb-6">Live Events</h2><div class="bg-white p-8 rounded-xl shadow-sm border text-center"><p class="text-red-500">No valid live event links available. Please check again later.</p></div>`;
    } else {
        container.innerHTML = `
            <h2 class="text-3xl font-bold text-slate-900 mb-6">Live Event</h2>
            <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 text-center">
                <i class="ph-video-camera-slash text-6xl text-slate-400"></i>
                <p class="mt-4 text-slate-600">There are no live events currently scheduled.</p>
            </div>
        `;
    }
}
        
        function renderDashboard(students) {
            const contentContainer = document.getElementById('student-content-container');
            contentContainer.innerHTML = ''; 
            if (!students || students.length === 0) {
                contentContainer.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-center text-slate-600">No students found for this parent account.</p></div>'; 
                return; 
            }
            
            students.forEach(student => {
                if (!student || !student.studentName) return;
                const studentCard = document.createElement('div');
                
                // Teachers List
                let teachersHtml = '';
                if (student.teachers && student.teachers.length > 0) {
                    const visibleTeachers = student.teachers.slice(0, 3);
                    teachersHtml = visibleTeachers.map(t => `
                        <li class="flex items-center justify-between py-3 border-b border-slate-100 last:border-b-0">
                            <div class="flex items-center">
                                <img class="h-10 w-10 rounded-full mr-4" src="${t.photoUrl}" alt="${t.teacherName}">
                                <div>
                                    <p class="font-semibold text-slate-800">${t.teacherName}</p>
                                    <p class="text-sm text-slate-500">${t.role}</p>
                                </div>
                            </div>
                            <a href="mailto:${t.email}" class="text-teal-600 hover:underline text-sm font-medium">${t.email}</a>
                        </li>
                    `).join('');
                } else { 
                    teachersHtml = '<li><p class="text-slate-500 py-3">No teachers listed for this student.</p></li>'; 
                }

                // Events List
                let eventsHtml = '';
                if (student.events && student.events.length > 0) {
                    const today = new Date(); 
                    today.setHours(0, 0, 0, 0);
                    const upcomingEvents = student.events.filter(event => new Date(event.date) >= today);
                    const visibleEvents = upcomingEvents.slice(0, 4);
                    
                    if (visibleEvents.length > 0) {
                        eventsHtml = visibleEvents.map((event) => `
                            <li class="flex justify-between items-start py-2 border-b border-slate-100 last:border-b-0">
                                <div class="flex-1 pr-2">
                                    <p class="font-semibold text-slate-800">${event.name}</p>
                                    <p class="text-sm text-slate-500">${formatDate(event.date)}</p>
                                </div>
                            </li>
                        `).join('');
                    } else {
                        eventsHtml = '<li><p class="text-slate-500 py-3">No upcoming events for this student.</p></li>';
                    }
                } else { 
                    eventsHtml = '<li><p class="text-slate-500 py-3">No upcoming events for this student.</p></li>'; 
                }

                const studentInitials = student.studentName.split(" ").map(n=>n[0]).join("");
                
                studentCard.innerHTML = `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border border-slate-200">
                        <div class="p-6 bg-slate-50 border-b border-slate-200">
                            <div class="flex items-center">
                                <img class="h-16 w-16 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=${studentInitials}" alt="Student Photo">
                                <div class="ml-4">
                                    <h3 class="text-2xl font-bold text-slate-900">${student.studentName}</h3>
                                    <p class="text-slate-600">${decodeGrade(student.grade)} - Classroom ${student.classroom || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3">
                            <div class="lg:col-span-2 p-6">
                                <div class="mb-8">
                                    <h4 class="font-semibold text-lg text-slate-700 mb-3">Quick Actions</h4>
                                    <div class="flex flex-wrap gap-3">
                                        <button data-student-id="${student.uniqueStudentId}" class="report-absence-nav-btn inline-flex items-center bg-teal-100 text-teal-800 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200 transition-colors">
                                            Report Absence/Tardy
                                        </button>
                                        <button onclick="switchToTabAndSubTab('faq-forms', 'quicklinks-content');" class="inline-flex items-center bg-slate-100 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition-colors">
                                            View Student Handbook
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-lg text-slate-700 mb-2">Teachers</h4>
                                    <ul class="space-y-0 divide-y divide-slate-100">
                                        ${teachersHtml}
                                    </ul>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-6 lg:border-l border-slate-200">
                                <h4 class="font-semibold text-lg text-slate-700 mb-2">Upcoming Events</h4>
                                <ul class="space-y-4">
                                    ${eventsHtml}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                contentContainer.appendChild(studentCard);
            });
        }
        
        function renderActionsTab(students) { 
            const container = document.getElementById('actions-content-container');
            if (!students || students.length === 0) { container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow"><p>No students found.</p></div>`; return; }
            
            // Enrollment Card
            const enrollmentCardHtml = `
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">2026-2027 Re-enrollment</h3>
                        <p class="text-slate-600 mt-1">Secure your child's spot for the upcoming academic year.</p>
                        <div class="mt-2 text-sm text-red-600 font-semibold">Priority Deadline: Feb 16, 2026</div>
                    </div>
                    <div class="bg-teal-100 p-3 rounded-full"><i class="ph-student text-2xl text-teal-600"></i></div>
                </div>
                <div class="mt-6">
                    <button onclick="startEnrollment()" class="w-full sm:w-auto bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition">Start Re-enrollment</button>
                </div>
            </div>`;

            // Absence Form
            const studentOptions = students.map(s => `<option value="${s.uniqueStudentId}">${s.studentName}</option>`).join('');
            const absenceFormHtml = `<form id="absence-form" class="mt-8"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 max-w-2xl mx-auto"><h3 class="font-semibold text-lg text-slate-800 mb-4">Report Absence or Tardy</h3><div class="space-y-5"><div class="mb-4"><label class="block text-sm font-medium text-slate-700">Student</label><select id="student-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500">${studentOptions}</select></div><div><fieldset><legend class="text-sm font-medium text-slate-700">Report Type</legend><div class="mt-2 flex space-x-4"><label class="inline-flex items-center"><input type="radio" class="form-radio text-teal-600 focus:ring-teal-500" name="report-type" value="absent" checked> <span class="ml-2">Absence</span></label><label class="inline-flex items-center"><input type="radio" class="form-radio text-teal-600 focus:ring-teal-500" name="report-type" value="tardy"> <span class="ml-2">Tardy</span></label></div></fieldset></div><div id="absence-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="absence-start" class="block text-sm font-medium text-slate-700">Absence Start Date</label><input type="date" id="absence-start" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><div><label for="absence-end" class="block text-sm font-medium text-slate-700">Absence End Date</label><input type="date" id="absence-end" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div></div><div id="tardy-fields" class="hidden grid-cols-1 md:grid-cols-2 gap-4"><div><label for="tardy-start-time" class="block text-sm font-medium text-slate-700">Expected Arrival</label><input type="time" id="tardy-start-time" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><div><label for="tardy-end-time" class="block text-sm font-medium text-slate-700"> Date</label><input type="date" id="tardy-end-time" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div></div><div><label for="absence-reason" class="block text-sm font-medium text-slate-700">Reason</label><select id="absence-reason" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"><option>Sick</option><option>Travel</option><option>Appointment</option><option>Other</option></select></div><div id="other-reason-container" class="hidden"><label for="other-reason-text" class="block text-sm font-medium text-slate-700">Please specify:</label><textarea id="other-reason-text" rows="2" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></textarea></div><div><label for="absence-comments" class="block text-sm font-medium text-slate-700">Optional Comments</label><textarea id="absence-comments" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></textarea></div><div class="border-t border-slate-200 pt-5"><button id="send-notification-btn" type="submit" class="w-full sm:w-auto inline-flex items-center justify-center bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-slate-400">Send Notification</button></div></div></div></form>`;
            
            const eligibleStudents = students.filter(s => ['K', '0', '1', '2', '3', '4', '5', '6', '7', '8'].includes(String(s.grade)));
            let pickupFormHtml = '';
            if (eligibleStudents.length > 0) {
                 const studentCheckboxes = eligibleStudents.map(s => `<label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-5 w-5 rounded border-slate-300 text-teal-600 focus:ring-teal-500 pickup-student-checkbox" value="${s.uniqueStudentId}"><span class="ml-2 text-slate-700">${s.studentName} (${decodeGrade(s.grade)})</span></label>`).join('');
                pickupFormHtml = `<form id="pickup-form" class="mt-8"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 max-w-2xl mx-auto"><h3 class="font-semibold text-lg text-slate-800 mb-2">One-Time Authorized Pickup</h3><p class="text-sm text-slate-500 mb-4">For students in KG to 8th Grade only. Please notify the office for any permanent changes.</p><div class="space-y-5"><div><label class="block text-sm font-medium text-slate-700">Select Student(s)</label><div class="mt-2 space-y-2">${studentCheckboxes}</div></div><div><label for="pickup-name" class="block text-sm font-medium text-slate-700">Authorized Person's Full Name (must match ID)</label><input type="text" id="pickup-name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><div><label for="pickup-relationship" class="block text-sm font-medium text-slate-700">Relationship to Student(s)</label><input type="text" id="pickup-relationship" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><div><label for="pickup-email" class="block text-sm font-medium text-slate-700">Authorized Person's Email (Optional)</label><input type="email" id="pickup-email" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><div><label for="pickup-date" class="block text-sm font-medium text-slate-700">Pickup Date</label><input type="date" id="pickup-date" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><div><label for="pickup-reason" class="block text-sm font-medium text-slate-700">Reason / Comment (Optional)</label><textarea id="pickup-reason" rows="2" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></textarea></div><div class="border-t border-slate-200 pt-5"><button id="send-pickup-btn" type="submit" class="w-full sm:w-auto inline-flex justify-center items-center bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-slate-400">Send Pickup Notification</button></div></div></div></form>`;
            }
            container.innerHTML = enrollmentCardHtml + absenceFormHtml + pickupFormHtml;
        }

        function renderVolunteering(opportunities) {
            const list = document.getElementById('volunteering-list');
            list.innerHTML = '';
            if (!opportunities || opportunities.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 bg-white p-6 rounded-lg shadow-sm border border-slate-200">No volunteering opportunities match your current filters.</div>';
                return;
            }
            const groupedByEvent = opportunities.reduce((acc, opp) => {
                const eventName = portalData.allEvents.find(e => e.id === opp.eventid)?.name || 'General Opportunities';
                if (!acc[eventName]) { acc[eventName] = []; }
                acc[eventName].push(opp);
                return acc;
            }, {});
            Object.keys(groupedByEvent).forEach((eventName, index) => {
                const opportunitiesInEvent = groupedByEvent[eventName];
                const groupedByTitle = opportunitiesInEvent.reduce((acc, opp) => {
                    const key = opp.title;
                    if (!acc[key]) { acc[key] = { ...opp, timeSlots: [] }; }
                    acc[key].timeSlots.push(opp);
                    return acc;
                }, {});
                const eventContentHtml = Object.values(groupedByTitle).map(group => {
                    const timeSlotsHtml = group.timeSlots.map(slot => `<div class="flex justify-between items-center border-t border-slate-100 py-3"><div class="pr-4"><p class="font-semibold text-slate-800">${slot.time}</p><p class="text-sm text-slate-500">${slot.signedUp} of ${slot.needed} spots filled</p></div><button data-id="${slot.id}" class="signup-btn inline-flex items-center justify-center bg-teal-100 text-teal-800 font-bold py-2 px-4 rounded-lg hover:bg-teal-200 transition duration-300 text-sm flex-shrink-0 disabled:opacity-50" ${slot.signedUp >= slot.needed ? 'disabled' : ''}>${slot.signedUp >= slot.needed ? 'Full' : 'Sign Up'}</button></div>`).join('');
                    return `<div class="px-6 py-4 border-t border-slate-200"><h4 class="text-lg font-bold text-slate-800">${group.title}</h4><p class="mt-1 text-sm text-slate-600">${group.description}</p><div class="mt-3 flex flex-wrap gap-x-4 gap-y-1 text-xs text-slate-500"><span class="flex items-center"><i class="ph-calendar-blank mr-1"></i> ${formatDate(group.date)}</span><span class="flex items-center"><i class="ph-map-pin mr-1"></i> ${group.location}</span><span class="flex items-center"><i class="ph-star mr-1"></i> Semester: ${group.semester}</span></div><div class="mt-3"><h5 class="font-semibold text-slate-700 mb-1 text-sm">Available Time Slots:</h5><div class="space-y-1">${timeSlotsHtml}</div></div></div>`;
                }).join('');
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-slate-200';
                card.innerHTML = `<div class="p-4 cursor-pointer flex justify-between items-center volunteer-card-header" data-target="event-group-${index}"><h3 class="text-xl font-bold text-slate-900">${eventName}</h3><i class="ph-caret-down text-2xl transition-transform"></i></div><div id="event-group-${index}" class="hidden">${eventContentHtml}</div>`;
                list.appendChild(card);
            });
        }
        
        function applyAndRenderFilters() {
            if (!portalData.volunteering || !document.getElementById('filter-time')) {
                if(portalData.volunteering) renderVolunteering(portalData.volunteering);
                return;
            }
            const signedUpOppIds = portalData.mySignups.filter(signup => signup.status !== 'Withdrawn').map(signup => signup.opportunityId);
            let filteredOpportunities = [...portalData.volunteering];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            filteredOpportunities = filteredOpportunities.filter(opp => new Date(opp.date) >= today);
            const eventFilterValue = document.getElementById('filter-event').value;
            const semesterFilter = document.getElementById('filter-semester').value;
            const timeFilter = document.getElementById('filter-time').value;
            const hoursFilter = parseInt(document.getElementById('filter-hours').value, 10);
            const locationFilter = document.getElementById('filter-location').value;
            const sortFilter = document.getElementById('filter-sort').value;
            if (eventFilterValue !== 'all') filteredOpportunities = filteredOpportunities.filter(opp => opp.eventid === eventFilterValue);
            if (semesterFilter !== 'all') filteredOpportunities = filteredOpportunities.filter(opp => String(opp.semester) === semesterFilter);
            if (timeFilter !== 'All') filteredOpportunities = filteredOpportunities.filter(opp => opp.timeOfDay === timeFilter);
            if (hoursFilter !== 99) filteredOpportunities = filteredOpportunities.filter(opp => opp.hours <= hoursFilter);
            if (locationFilter !== 'All') filteredOpportunities = filteredOpportunities.filter(opp => opp.locationType === locationFilter);
            filteredOpportunities = filteredOpportunities.filter(opp => !signedUpOppIds.includes(opp.id));
            if (sortFilter === 'recent') filteredOpportunities.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            renderVolunteering(filteredOpportunities);
        }

        function populateEventFilter(events) {
            const eventFilter = document.getElementById('filter-event');
            if (!eventFilter || !events) return;
            const uniqueEvents = new Map();
            events.forEach(event => { if (event.id && !uniqueEvents.has(event.id)) uniqueEvents.set(event.id, event.name); });
            while (eventFilter.options.length > 1) eventFilter.remove(1);
            uniqueEvents.forEach((name, id) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                eventFilter.appendChild(option);
            });
        }
        
        function getMatchingInfoHtml(signups) {
            if (!signups) return '';
            const twoMonthsAgo = new Date();
            twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
            twoMonthsAgo.setHours(0,0,0,0);
            const validSignups = signups.filter(s => {
                const d = new Date(s.date);
                return s.status === 'Completed' && d >= twoMonthsAgo && d <= new Date();
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
            const rows = validSignups.length > 0 ? validSignups.map(s => `
                <tr class="border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap text-slate-700">${formatDate(s.date)}</td>
                    <td class="px-4 py-3 text-slate-700 font-medium">${s.title}</td>
                    <td class="px-4 py-3 font-bold text-teal-600">${s.hours || '-'} hrs</td> 
                </tr>
            `).join('') : `<tr><td colspan="3" class="px-4 py-4 text-center text-slate-500 italic">No completed volunteer hours found in the last 2 months.</td></tr>`;
            return `
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-8">
                <div class="flex flex-col md:flex-row items-start gap-6">
                    <div class="p-4 bg-teal-100 rounded-full text-teal-600 flex-shrink-0">
                         <i class="ph-currency-dollar text-3xl"></i>
                    </div>
                    <div class="flex-grow w-full">
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Double Your Impact with Corporate Matching!</h3>
                        <p class="text-slate-600 mb-4 leading-relaxed">
                            Did you know many employers match volunteer hours with monetary donations? You could generate up to <strong>$25 per hour</strong> for SVA just by logging the hours you've already volunteered! Your contribution goes a long way in supporting our school's programs and facilities. JazakAllahu Khairan!
                        </p>
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6 text-sm text-slate-700">
                            <p class="font-semibold mb-1">Instructions:</p>
                            <ul class="list-disc list-inside space-y-1 ml-1">
                                <li>Submit your hours to your employer's portal using the table below as a reference.</li>
                                <li>For the verifying person, please use: <span class="font-semibold">Rubeka Alam (<a href="mailto:pto@svamail.com" class="text-teal-600 hover:underline">pto@svamail.com</a>)</span></li>
                            </ul>
                        </div>
                        <h4 class="font-semibold text-slate-800 mb-3 border-b border-slate-200 pb-2">Your Completed Hours (Last 2 Months)</h4>
                        <div class="overflow-x-auto rounded-lg border border-slate-200">
                            <table class="min-w-full text-left text-sm">
                                <thead class="bg-slate-50 text-xs uppercase font-semibold text-slate-500">
                                    <tr>
                                        <th class="px-4 py-3">Date</th>
                                        <th class="px-4 py-3">Activity</th>
                                        <th class="px-4 py-3">Hours</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 bg-white">
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderMySignups(progress) {
            const container = document.getElementById('my-signups-content');
            const selfReportFormHtml = `<form id="self-report-form"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8"><h3 class="text-xl font-semibold text-slate-800 mb-2">Self-Report Off-Portal Hours</h3><p class="text-sm text-slate-600 mb-4">Did you volunteer for a task not listed in the portal (e.g., driving for a field trip, at-home prep)? Please submit the details below for approval.</p><div class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="report-date" class="block text-sm font-medium text-slate-700">Date of Activity</label><input type="date" id="report-date" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required></div><div><label for="report-duration" class="block text-sm font-medium text-slate-700">Duration</label><select id="report-duration" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required><option value="CUST-30M">30 Minutes</option><option value="CUST-1H">1 Hour</option><option value="CUST-2H">2 Hours</option><option value="CUST-3H">3 Hours</option><option value="CUST-4H">4 Hours</option><option value="CUST-5H">5 Hours</option><option value="CUST-6H">6 Hours</option><option value="CUST-7H">7 Hours</option><option value="CUST-8H">8 Hours</option></select></div></div><div><label for="report-description" class="block text-sm font-medium text-slate-700">Brief Description of Activity and Who Can Verify It</label><textarea id="report-description" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required></textarea></div><button type="submit" id="self-report-btn" class="w-full sm:w-auto inline-flex items-center justify-center bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-slate-400">Submit for Approval</button></div></div></form>`;
            const progressBarsHtml = `<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8"><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 class="text-lg font-semibold text-slate-800">Semester 1 Progress</h3><div class="mt-4"><div class="flex justify-between mb-1"><span class="text-base font-medium text-teal-700">Completed Hours</span><span class="text-sm font-medium text-teal-700" id="progress-text-s1"></span></div><div class="w-full bg-slate-200 rounded-full h-5 relative overflow-hidden"><div id="progress-bar-s1-inprogress" class="bg-orange-400 h-5 rounded-full" style="width: 0%"></div><div id="progress-bar-s1-completed" class="bg-teal-600 h-5 rounded-full absolute top-0 left-0" style="width: 0%"></div></div><div class="flex justify-between text-xs text-slate-500 mt-2"><span id="in-progress-text-s1"></span><span id="penalty-text-s1" class="text-red-600 font-semibold"></span></div></div></div><div><h3 class="text-lg font-semibold text-slate-800">Semester 2 Progress</h3><div class="mt-4"><div class="flex justify-between mb-1"><span class="text-base font-medium text-teal-700">Completed Hours</span><span class="text-sm font-medium text-teal-700" id="progress-text-s2"></span></div><div class="w-full bg-slate-200 rounded-full h-5 relative overflow-hidden"><div id="progress-bar-s2-inprogress" class="bg-orange-400 h-5 rounded-full" style="width: 0%"></div><div id="progress-bar-s2-completed" class="bg-teal-600 h-5 rounded-full absolute top-0 left-0" style="width: 0%"></div></div><div class="flex justify-between text-xs text-slate-500 mt-2"><span id="in-progress-text-s2"></span><span id="penalty-text-s2" class="text-red-600 font-semibold"></span></div></div></div></div></div>`;
            const signupListsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 class="text-xl font-semibold text-slate-700 mb-2">Upcoming Signups</h3><p class="text-sm text-slate-600 mb-4">You may withdraw up to 3 weeks (21 days) before the event.</p><div id="upcoming-signups-list" class="space-y-4"></div></div><div><h3 class="text-xl font-semibold text-slate-700 mb-4">Completed & Past Signups</h3><div id="completed-signups-list" class="space-y-4"></div></div></div>`;
            const matchingInfoHtml = getMatchingInfoHtml(portalData.mySignups);
            container.innerHTML = selfReportFormHtml + progressBarsHtml + signupListsHtml + matchingInfoHtml;

            if (progress) {
                const s1 = progress.semester1;
                const s1_req = s1.totalRequired || 1;
                const s1_completed_p = s1_req > 0 ? (s1.completed / s1_req) * 100 : 0;
                const s1_inprogress_p = s1_req > 0 ? (s1.inProgress / s1_req) * 100 : 0;
                document.getElementById('progress-bar-s1-completed').style.width = `${Math.min(s1_completed_p, 100)}%`;
                document.getElementById('progress-bar-s1-inprogress').style.width = `${Math.min(s1_completed_p + s1_inprogress_p, 100)}%`;
                document.getElementById('progress-text-s1').textContent = `${s1.completed} of ${s1.baseRequired} hours`;
                document.getElementById('in-progress-text-s1').textContent = `${s1.inProgress || 0} hours in progress`;
                document.getElementById('penalty-text-s1').textContent = s1.penalty > 0 ? `+ ${s1.penalty} penalty hours` : '';
                const s2 = progress.semester2;
                const s2_req = s2.totalRequired || 1;
                const s2_completed_p = s2_req > 0 ? (s2.completed / s2_req) * 100 : 0;
                const s2_inprogress_p = s2_req > 0 ? (s2.inProgress / s2_req) * 100 : 0;
                document.getElementById('progress-bar-s2-completed').style.width = `${Math.min(s2_completed_p, 100)}%`;
                document.getElementById('progress-bar-s2-inprogress').style.width = `${Math.min(s2_completed_p + s2_inprogress_p, 100)}%`;
                document.getElementById('progress-text-s2').textContent = `${s2.completed} of ${s2.baseRequired} hours`;
                document.getElementById('in-progress-text-s2').textContent = `${s2.inProgress || 0} hours in progress`;
                document.getElementById('penalty-text-s2').textContent = s2.penalty > 0 ? `+ ${s2.penalty} penalty hours` : '';
            }
        }
        
        function renderMySignupsList(signups) {
            const upcomingList = document.getElementById('upcoming-signups-list');
            const completedList = document.getElementById('completed-signups-list');
            upcomingList.innerHTML = '';
            completedList.innerHTML = '';
            const upcomingSignups = signups.filter(s => s.status === 'In Progress' || s.status === 'Pending Approval');
            const pastSignups = signups.filter(s => s.status === 'Completed' || s.status === 'Penalty' || s.status === 'Withdrawn');

            if (upcomingSignups.length === 0) upcomingList.innerHTML = '<div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 text-slate-500">No upcoming volunteer signups.</div>';
            else {
                upcomingSignups.forEach((signup, index) => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-5 rounded-lg shadow-sm border border-slate-200';
                    const eventDate = new Date(signup.date);
                    const daysUntilEvent = (eventDate - new Date()) / (1000 * 60 * 60 * 24);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    
                    let actionButtonsHtml = '';
                    if (signup.status === 'Pending Approval') {
                        actionButtonsHtml = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">Pending Approval</span>`;
                    } else {
                        const withdrawButtonHtml = daysUntilEvent > 21 ? `<button data-signup-id="${signup.signupId}" class="withdraw-btn w-full text-sm bg-red-100 text-red-800 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition">Withdraw</button>` : `<button class="w-full text-sm bg-slate-200 text-slate-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed" disabled>Withdrawal ended</button>`;
                        let qrButtonHtml = '';
                        if (eventDate <= today) {
                            qrButtonHtml = `<button data-signup-id="${signup.signupId}" class="show-qr-btn w-full text-sm bg-slate-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-700 transition">Show Check-in Code</button>`;
                        } else {
                            qrButtonHtml = `<button class="w-full text-sm bg-slate-200 text-slate-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed" disabled>Code not yet available</button>`;
                        }
                        const calendarButtonHtml = `<div class="relative"><button type="button" class="add-to-calendar-btn w-full inline-flex items-center justify-center rounded-md border border-slate-300 shadow-sm px-3 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none" data-event-name="${signup.title}" data-event-date="${signup.date}"><i class="ph-plus-circle mr-2"></i> Add to Calendar</button><div class="event-dropdown origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10"><div class="py-1"><a href="#" class="google-cal-link text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100">Google Calendar</a><a href="#" class="ical-link text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100">iCal/Outlook</a></div></div></div>`;
                        actionButtonsHtml = `<div class="mt-4 sm:mt-0 sm:ml-6 flex-shrink-0 flex flex-col space-y-2 w-full sm:w-48">${qrButtonHtml}${calendarButtonHtml}${withdrawButtonHtml}</div>`;
                    }
                    
                    item.innerHTML = `<div class="flex flex-col sm:flex-row justify-between"><div class="flex-grow"><h4 class="text-lg font-bold text-slate-900">${signup.title}</h4><div class="mt-2 space-y-1"><div class="flex items-center text-sm text-slate-500"><i class="ph-info mr-2"></i><p>${signup.description || 'No description provided.'}</p></div><div class="flex items-center text-sm text-slate-500"><i class="ph-calendar-blank mr-2"></i><p>${formatDate(signup.date)} at ${signup.time}</p></div><div class="flex items-center text-sm text-slate-500"><i class="ph-map-pin mr-2"></i><p>${signup.location}</p></div></div></div>${actionButtonsHtml}</div>`;
                    upcomingList.appendChild(item);
                });
            }

            if (pastSignups.length === 0) completedList.innerHTML = '<div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 text-slate-500">No completed or past signups.</div>';
            else {
                pastSignups.forEach(signup => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200';
                    const statusColor = signup.status === 'Completed' ? 'text-green-700 bg-green-100' : signup.status === 'Penalty' ? 'text-red-700 bg-red-100' : 'text-slate-700 bg-slate-100';
                    item.innerHTML = `<div class="flex flex-col sm:flex-row justify-between"><div><h4 class="text-md font-bold text-slate-900">${signup.title}</h4><p class="mt-1 text-sm text-slate-600">${signup.description || ''}</p><div class="mt-2 text-sm text-slate-500"><p><i class="ph-calendar-blank mr-1"></i> ${formatDate(signup.date)} at ${signup.time}</p></div></div><div class="mt-3 sm:mt-0 sm:ml-6 flex-shrink-0 text-left sm:text-right"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">${signup.status}</span></div></div>`;
                    completedList.appendChild(item);
                });
            }
        }

        function renderMobileMenu() {
            const desktopNav = document.getElementById('main-nav');
            const mobileNavContainer = document.getElementById('main-nav-mobile');
            mobileNavContainer.innerHTML = "";
            desktopNav.querySelectorAll('.tab-btn').forEach(button => {
                const newBtn = button.cloneNode(true);
                newBtn.classList.remove('py-4', 'px-5', 'text-sm');
                newBtn.classList.add('block', 'px-3', 'py-2', 'rounded-md', 'text-base', 'font-medium');
                mobileNavContainer.appendChild(newBtn);
            });
        }

        // --- EVENT LISTENERS ---
       function addEventListeners() {
            document.body.addEventListener('click', function(event) {
                const target = event.target;
                const button = target.closest('button');
                const sidebarLink = target.closest('.sidebar-link');
                
                const header = target.closest('.volunteer-card-header');
                if (header) {
                    const content = document.getElementById(header.dataset.target);
                    const icon = header.querySelector('i');
                    if (content) {
                        content.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                    }
                    return; 
                }

                if (sidebarLink) {
                    event.preventDefault();
                    document.querySelectorAll('.tab-btn, .sidebar-link').forEach(l => l.classList.remove('tab-active', 'active'));
                    const tabId = sidebarLink.dataset.tab;
                    document.querySelectorAll(`.sidebar-link[data-tab="${tabId}"]`).forEach(l => l.classList.add('active'));
                    document.querySelectorAll(`.tab-btn[data-tab="${tabId}"]`).forEach(l => l.classList.add('tab-active'));
                    document.getElementById('page-title').textContent = sidebarLink.textContent.trim();
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('tab-content-active'));
                    document.getElementById(tabId).classList.add('tab-content-active');
                    document.getElementById('mobile-menu').style.display = 'none';
                    document.getElementById('menu-icon-open').classList.remove('hidden');
                    document.getElementById('menu-icon-close').classList.add('hidden');
                    return; 
                }

                if (!button) {
                    if (event.target.classList.contains('modal') && event.target.id !== 'enrollment-modal') {
                        closeModal(event.target.id);
                    }
                    return; 
                }

                if (button && button.matches('.withdraw-btn')) {
                    if (!confirm('Are you sure you want to withdraw from this event?')) return;
                    const signupId = button.dataset.signupId;
                    button.textContent = 'Withdrawing...';
                    button.disabled = true;
                    fetch(WEB_APP_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'withdraw', signupId: signupId, token: ID_TOKEN }),
                        headers: {'Content-Type': 'application/json'}
                    }).then(() => {
                        alert('Withdrawal successful! The portal will now refresh.');
                        fetchData(ID_TOKEN); 
                    }).catch(error => {
                        console.error('Withdrawal Error:', error);
                        alert(`An error occurred during withdrawal: Load failed`);
                        button.textContent = 'Withdraw';
                        button.disabled = false;
                    });
                }

                if (button && button.matches('.add-to-calendar-btn')) {
                    event.stopPropagation();
                    const dropdown = button.closest('.relative').querySelector('.event-dropdown');
                    if (dropdown) {
                        document.querySelectorAll('.event-dropdown').forEach(d => { if (d !== dropdown) d.classList.add('hidden'); });
                        const eventData = { name: button.dataset.eventName, date: button.dataset.eventDate };
                        const googleLink = dropdown.querySelector('.google-cal-link');
                        const iCalLink = dropdown.querySelector('.ical-link');
                        googleLink.href = generateGoogleCalendarLink(eventData); googleLink.target = "_blank";
                        iCalLink.href = generateICalLink(eventData); iCalLink.download = `${eventData.name}.ics`;
                        dropdown.classList.toggle('hidden');
                    }
                } else if (!target.closest('.event-dropdown')) {
                    document.querySelectorAll('.event-dropdown').forEach(dropdown => dropdown.classList.add('hidden'));
                }

                if (button && button.matches('.report-absence-nav-btn')) {
                    const studentId = button.dataset.studentId;
                    switchToTab('actions');
                    document.getElementById('student-select').value = studentId;
                }

                if (button && button.matches('.signup-btn')) {
                    const opportunityId = button.dataset.id;
                    button.textContent = 'Signing up...';
                    button.disabled = true;
                    fetch(WEB_APP_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'signup', opportunityId: opportunityId, token: ID_TOKEN }),
                        headers: {'Content-Type': 'application/json'}
                    }).then(() => {
                       alert('Signup successful! The portal will now refresh.');
                       fetchData(ID_TOKEN); 
                    }).catch(error => {
                        console.error('Signup Error:', error);
                        alert(`An error occurred during signup: Load failed`);
                        button.textContent = 'Sign Up';
                        button.disabled = false;
                    });
                }

                if (button && button.matches('.show-qr-btn')) {
                    const signupId = button.dataset.signupId;
                    const qrCodeContainer = document.getElementById('qrcode');
                    qrCodeContainer.innerHTML = '';
                    const checkinUrl = `https://approve.svaportal.com/?signupId=${signupId}`;
                    const qr = qrcode(0, 'M'); qr.addData(checkinUrl); qr.make();
                    qrCodeContainer.innerHTML = qr.createImgTag(6);
                    document.getElementById('qr-code-modal').classList.remove('hidden');
                }

                if (button && (button.matches('#close-modal-btn') || button.parentElement.parentElement.parentElement === document.getElementById('qr-code-modal'))) {
                    document.getElementById('qr-code-modal').classList.add('hidden');
                }

                if (button && button.matches('.tab-btn')) { switchToTab(button.dataset.tab); }
                
                if (button && button.matches('.faq-forms-tab-btn')) {
                    const tabName = button.dataset.tab;
                    document.querySelectorAll('.faq-forms-tab-btn').forEach(btn => {
                        btn.classList.remove('tab-active'); btn.classList.add('text-slate-500');
                    });
                    button.classList.add('tab-active'); button.classList.remove('text-slate-500');
                    document.querySelectorAll('.faq-forms-tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');
                }

                if (target.closest('#mobile-menu-button')) {
                    const mobileMenu = document.getElementById('mobile-menu');
                    const isOpen = mobileMenu.style.display === 'block';
                    mobileMenu.style.display = isOpen ? 'none' : 'block';
                    document.getElementById('menu-icon-open').classList.toggle('hidden', isOpen);
                    document.getElementById('menu-icon-close').classList.toggle('hidden', !isOpen);
                }

                if (button && button.matches('.volunteer-for-event-btn')) {
                    const eventId = button.dataset.eventId;
                    switchToTab('volunteering');
                    document.getElementById('filter-event').value = eventId;
                    applyAndRenderFilters();
                }

                if(target.matches('input[name="report-type"]')) {
                    const isTardy = event.target.value === 'tardy';
                    document.getElementById('tardy-fields').style.display = isTardy ? 'grid' : 'none';
                    document.getElementById('absence-fields').style.display = isTardy ? 'none' : 'grid';
                }
               
                if (button && button.matches('.show-more-events-btn, .show-more-teachers-btn')) {
                    const studentId = button.dataset.studentId;
                    const type = button.matches('.show-more-events-btn') ? 'events' : 'teachers';
                    const moreDiv = document.getElementById(`more-${type}-${studentId}`);
                    if (moreDiv) {
                        const isHidden = moreDiv.classList.contains('hidden');
                        moreDiv.classList.toggle('hidden');
                        button.textContent = isHidden ? 'Show Less' : 'Show More';
                    }
                }
            });
            
            document.body.addEventListener('submit', function(event) {
                if (event.target.id === 'self-report-form') {
                    event.preventDefault();
                    const button = document.getElementById('self-report-btn');
                    const payload = {
                        action: 'selfReportHours', token: ID_TOKEN,
                        opportunityId: document.getElementById('report-duration').value,
                        date: document.getElementById('report-date').value,
                        description: document.getElementById('report-description').value
                    };
                    if (!payload.date || !payload.description) { alert("Please fill out the date and description for your activity."); return; }
                    button.textContent = 'Submitting...'; button.disabled = true;
                    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        alert('Your hours have been submitted for approval! The portal will now refresh to show the pending item.');
                        fetchData(ID_TOKEN);
                        document.getElementById('self-report-form').reset();
                    })
                    .catch(error => console.error('Self-report Error:', error))
                    .finally(() => { button.textContent = 'Submit for Approval'; button.disabled = false; });
                } else if (event.target.id === 'absence-form') {
                    event.preventDefault();
                    const button = document.getElementById('send-notification-btn');
                    button.textContent = 'Sending...'; button.disabled = true;
                    const studentId = document.getElementById('student-select').value;
                    const student = portalData.students.find(s => s.uniqueStudentId == studentId);
                    const reportType = document.querySelector('input[name="report-type"]:checked').value;
                    const startDate = document.getElementById('absence-start').value, endDate = document.getElementById('absence-end').value;
                    const tardyStartTime = document.getElementById('tardy-start-time').value, tardyEndTime = document.getElementById('tardy-end-time').value;
                    let reason = document.getElementById('absence-reason').value;
                    if (reason === 'Other') reason = document.getElementById('other-reason-text').value;
                    let comments = document.getElementById('absence-comments').value;
                    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'sendAbsenceEmail', student: student, reportType, startDate, endDate, tardyStartTime, tardyEndTime, reason, comments, token: ID_TOKEN })
                    })
                    .then(() => alert('Absence/Tardy notification sent successfully!'))
                    .catch(error => { console.error('Email Send Error:', error); alert(`An error occurred while sending the email: Load failed`); })
                    .finally(() => { button.textContent = 'Send Notification'; button.disabled = false; });
                } else if (event.target.id === 'pickup-form') {
                     event.preventDefault();
                     const button = document.getElementById('send-pickup-btn');
                     const selectedStudentIds = Array.from(document.querySelectorAll('.pickup-student-checkbox:checked')).map(cb => cb.value);
                     if (selectedStudentIds.length === 0) { alert("Please select at least one student."); return; }
                     const selectedStudents = portalData.students.filter(s => selectedStudentIds.includes(String(s.uniqueStudentId)));
                     const payload = {
                        action: 'sendPickupEmail', token: ID_TOKEN,
                        students: selectedStudents,
                        pickupName: document.getElementById('pickup-name').value,
                        relationship: document.getElementById('pickup-relationship').value,
                        pickupEmail: document.getElementById('pickup-email').value,
                        reason: document.getElementById('pickup-reason').value,
                        date: document.getElementById('pickup-date').value
                    };
                    if (!payload.pickupName || !payload.relationship || !payload.date) { alert("Please fill out the Authorized Person's Name, Relationship, and the Pickup Date."); return; }
                    button.textContent = 'Sending...'; button.disabled = true;
                    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        alert('Pickup notification sent successfully!');
                        event.target.reset();
                    })
                    .catch(error => { console.error('Pickup Send Error:', error); alert('An error occurred. Please try again.'); })
                    .finally(() => { button.textContent = 'Send Pickup Notification'; button.disabled = false; });
                }
            });

            document.body.addEventListener('change', function(event) {
                if (event.target.name === 'report-type') {
                    const isTardy = event.target.value === 'tardy';
                    const tardyFields = document.getElementById('tardy-fields');
                    const absenceFields = document.getElementById('absence-fields');
                    if (tardyFields && absenceFields) {
                        tardyFields.style.display = isTardy ? 'grid' : 'none';
                        absenceFields.style.display = isTardy ? 'none' : 'grid';
                    }
                }
                if (event.target.matches('#absence-reason')) {
                    document.getElementById('other-reason-container').style.display = (event.target.value === 'Other') ? 'block' : 'none';
                } else if (event.target.matches('.filter-control')) {
                    applyAndRenderFilters();
                }
            });
        }

        // --- INITIALIZATION ---
         window.onload = function() {
            const hashToken = window.location.hash.startsWith('#token=') ? window.location.hash.substring(7) : null;
            const storedToken = localStorage.getItem('sva_id_token');

            if (hashToken) {
                window.history.replaceState({}, document.title, window.location.pathname);
                handleLoginSuccess(hashToken);
            } else if (storedToken) {
                handleLoginSuccess(storedToken);
            } else {
                try {
                    google.accounts.id.initialize({
                      client_id: CLIENT_ID,
                      callback: handleCredentialResponse
                    });
                    google.accounts.id.renderButton(
                      document.getElementById('google-signin-button-container'),
                      { theme: "outline", size: "large", width: "300" } 
                    );
                    document.getElementById('passkey-request-form').addEventListener('submit', handleRequestPasskey);
                    document.getElementById('go-back-btn').addEventListener('click', () => showLoginScreen('login-screen'));
                } catch (error) {
                    console.error("Google Sign-In initialization failed:", error);
                    document.getElementById('login-screen').innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-lg text-red-600"><p>Could not initialize Google Sign-In.".</p></div>`;
                }
            }
        };

        function handleRequestPasskey(e) {
            e.preventDefault();
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value;
            const button = document.getElementById('request-passkey-btn');
            
            button.disabled = true;
            button.textContent = 'Sending...';

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'requestLoginPasskey', email: email })
            })
            .then(() => {
                document.getElementById('passkey-email-display').textContent = email;
                showLoginScreen('passkey-verify-screen');
            })
            .catch(err => {
                console.error("Passkey Request Error:", err);
                alert(`A network error occurred. Please try again.`);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Send Login Link';
            });
        }
    </script>
</body>
</html>
