<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicon Valley Academy Parent Portal</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom: 2px solid #0d9488; color: #0d9488; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        .rotate-180 { transform: rotate(180deg); }
        .transition-transform { transition: transform 0.2s; }
        
        /* Enrollment Wizard Styles */
        .enrollment-step { display: none; }
        .enrollment-step.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tuition-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 0.9rem; }
        .tuition-table th, .tuition-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
        .tuition-table th { background-color: #f8fafc; font-weight: 600; color: #334155; }
        
        .scrollable-agreement { 
            height: 300px; overflow-y: scroll; background-color: #fff; 
            border: 1px solid #cbd5e1; padding: 16px; font-size: 0.85rem; 
            line-height: 1.6; margin-bottom: 15px; border-radius: 6px; color: #334155;
        }
        .scrollable-agreement p { margin-bottom: 10px; }
        .wizard-dot { height: 8px; width: 8px; background-color: #cbd5e1; border-radius: 50%; display: inline-block; margin: 0 4px; }
        .wizard-dot.active { background-color: #0d9488; transform: scale(1.2); }
    </style>
</head>
<body class="min-h-screen">

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden border border-slate-100">
            <div class="bg-teal-700 p-8 text-center">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="ph-graduation-cap text-4xl text-teal-700"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Welcome Back</h1>
                <p class="text-teal-100 mt-2">Silicon Valley Academy Parent Portal</p>
            </div>
            
            <div class="p-8">
                <div id="login-view-email">
                    <p class="text-slate-600 mb-6 text-center">Enter your email address to sign in.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                            <input type="email" id="login-email-input" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-3" placeholder="parent@example.com">
                        </div>
                        <button id="request-passkey-btn" onclick="handleRequestPasskey()" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 transition-colors shadow-md hover:shadow-lg">
                            Send Login Link
                        </button>
                    </div>
                </div>

                <div id="passkey-verify-screen" class="hidden text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="ph-envelope-simple-open text-3xl text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Check your inbox</h3>
                    <p class="text-slate-600 mb-6">We've sent a secure login link to <br><strong id="passkey-email-display" class="text-slate-800"></strong></p>
                    <p class="text-sm text-slate-500">Click the link in the email to access your account.</p>
                    <button onclick="location.reload()" class="mt-8 text-teal-600 font-medium hover:text-teal-800">Back to Login</button>
                </div>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
                 <p class="text-xs text-slate-500">&copy; 2026 Silicon Valley Academy</p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden max-w-4xl mx-auto pb-20">
        <header class="bg-white sticky top-0 z-40 border-b border-slate-200 shadow-sm">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="ph-graduation-cap text-3xl text-teal-700 mr-2"></i>
                        <span class="font-bold text-xl text-slate-800 tracking-tight">SVA Portal</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-name-display" class="text-sm font-medium text-slate-600 hidden sm:block"></span>
                        <button onclick="handleSignOut()" class="text-slate-500 hover:text-red-600 transition-colors">
                            <i class="ph-sign-out text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <nav class="flex space-x-8 -mb-px overflow-x-auto no-scrollbar">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dashboard</button>
                    <button onclick="switchTab('actions')" id="tab-actions" class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300">Actions</button>
                    <button onclick="switchTab('resources')" id="tab-resources" class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300">Resources</button>
                </nav>
            </div>
        </header>

        <main class="p-4 sm:p-6 space-y-6">
            
            <div id="dashboard-content" class="tab-content tab-content-active">
                <div id="students-container" class="space-y-6">
                    <div class="animate-pulse space-y-4">
                        <div class="h-48 bg-white rounded-xl"></div>
                        <div class="h-48 bg-white rounded-xl"></div>
                    </div>
                </div>
            </div>

            <div id="actions-content" class="tab-content">
                <div id="actions-content-container">
                    </div>
            </div>

            <div id="resources-content" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <a href="#" class="block p-6 bg-white border border-slate-200 rounded-xl hover:shadow-md transition-shadow">
                        <div class="flex items-center mb-2">
                            <i class="ph-book-open text-2xl text-teal-600 mr-3"></i>
                            <h3 class="font-semibold text-slate-800">Parent Handbook</h3>
                        </div>
                        <p class="text-slate-500 text-sm">View the 2025-2026 handbook.</p>
                    </a>
                    <a href="#" class="block p-6 bg-white border border-slate-200 rounded-xl hover:shadow-md transition-shadow">
                        <div class="flex items-center mb-2">
                            <i class="ph-calendar text-2xl text-teal-600 mr-3"></i>
                            <h3 class="font-semibold text-slate-800">Academic Calendar</h3>
                        </div>
                        <p class="text-slate-500 text-sm">Key dates and holidays.</p>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyiXpPzUeU-vE5JqD9P_wXn_ZqWv_gNqV_K9_X_n_ExampleID/exec"; 
        
        // --- STATE ---
        let currentUserEmail = "";
        let globalStudentData = [];
        let ID_TOKEN = "";
        
        // --- LOGIN FLOW ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                // Magic Link Login
                ID_TOKEN = token;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                fetchData(token);
            } else {
                // Show Login Screen
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };

        function handleRequestPasskey() {
            const emailInput = document.getElementById('login-email-input');
            const email = emailInput.value.trim();
            if (!email) { alert("Please enter your email."); return; }

            const btn = document.getElementById('request-passkey-btn');
            btn.disabled = true; btn.textContent = "Sending...";

            // Send request to backend
            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'requestLoginPasskey', email: email })
            }).then(() => {
                document.getElementById('passkey-email-display').textContent = email;
                document.getElementById('login-view-email').classList.add('hidden');
                document.getElementById('passkey-verify-screen').classList.remove('hidden');
            }).catch(err => {
                console.error(err); alert("Error sending link. Please try again.");
                btn.disabled = false; btn.textContent = "Send Login Link";
            });
        }

        function handleSignOut() {
            ID_TOKEN = "";
            window.location.href = window.location.pathname; // Clear URL params
        }

        // --- DATA FETCHING ---
        function fetchData(token) {
            // Using 'action=getData' with token authentication
            const scriptUrl = `${WEB_APP_URL}?action=getData&token=${encodeURIComponent(token)}`;
            
            fetch(scriptUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentUserEmail = data.email;
                        globalStudentData = data.data;
                        document.getElementById('user-name-display').textContent = currentUserEmail;
                        renderDashboard(globalStudentData);
                        renderActionsTab(globalStudentData);
                    } else {
                        alert("Session expired or invalid. Please login again.");
                        handleSignOut();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Failed to load data.");
                });
        }

        // --- RENDER DASHBOARD ---
        function renderDashboard(students) {
            const container = document.getElementById('students-container');
            if (!students || students.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-500">No student records found.</div>';
                return;
            }

            container.innerHTML = students.map(student => {
                // Teachers HTML
                const teachersHtml = student.teachers.map(t => `
                    <div class="flex items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <img src="${t.photoUrl}" class="w-10 h-10 rounded-full mr-3 border border-slate-200">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">${t.teacherName}</p>
                            <p class="text-xs text-slate-500">${t.role} &bull; ${t.email}</p>
                        </div>
                    </div>`).join('');
                
                // Volunteering HTML (Summary)
                const volunteerHtml = `
                    <div class="mt-4 p-4 bg-orange-50 rounded-xl border border-orange-100">
                        <h4 class="font-semibold text-orange-800 mb-2 flex items-center"><i class="ph-hand-heart mr-2"></i>Volunteering Opportunities</h4>
                        <div class="space-y-2">
                             ${student.events.slice(0, 2).map(e => `
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-700">${e.name}</span>
                                    <span class="text-xs bg-white px-2 py-1 rounded border border-orange-200 text-orange-600">${e.totalNeeded - e.totalSignedUp} spots left</span>
                                </div>`).join('')}
                        </div>
                        <button onclick="switchTab('actions')" class="w-full mt-3 text-sm text-orange-700 font-medium hover:text-orange-900 text-center">View all & Sign up</button>
                    </div>`;

                return `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-teal-700 p-4 text-white flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold">${student.studentName}</h2>
                            <p class="text-teal-100 text-sm">Grade ${decodeGrade(student.grade)} &bull; ${student.classroom}</p>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                            <span class="font-bold">${student.studentName.charAt(0)}</span>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Teachers</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${teachersHtml}</div>
                        </div>
                        ${volunteerHtml}
                    </div>
                </div>`;
            }).join('');
        }

        // --- RENDER ACTIONS & ENROLLMENT ---
        let enrollmentState = {
            selectedStudents: [],
            volunteerOption: 'None',
            contactStatus: 'Needs_Review',
            paymentPlan: 'Once',
            regFee: 0,
            paymentId: ''
        };

        function renderActionsTab(students) {
            const container = document.getElementById('actions-content-container');
            
            // 1. Enrollment Wizard
            const enrollmentHtml = renderReEnrollmentWizard(students);

            // 2. Absence Form (Existing logic simplified for space)
            const studentOptions = students.map(s => `<option value="${s.uniqueStudentId}">${s.studentName}</option>`).join('');
            const absenceForm = `
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 max-w-2xl mx-auto mb-8">
                <h3 class="font-semibold text-lg text-slate-800 mb-4">Report Absence</h3>
                <form onsubmit="event.preventDefault(); alert('Absence reported (Simulated)');">
                     <select class="w-full mb-3 rounded-md border-slate-300 shadow-sm">${studentOptions}</select>
                     <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded">Submit Report</button>
                </form>
            </div>`;

            container.innerHTML = enrollmentHtml + absenceForm;
            
            // Initialize Timer
            startPriorityCountdown();
        }

        function renderReEnrollmentWizard(students) {
            const familyInfo = students[0] || {}; 
            
            // Generate Student Checkboxes with Next Grade Logic
            const studentCheckboxes = students.map(s => {
                const currentGrade = String(s.grade).trim();
                let nextGrade = 'KG';
                // Simple next grade logic for Display
                if (currentGrade === 'Pre-K' || currentGrade === 'PK') nextGrade = 'KG';
                else if (currentGrade === 'K' || currentGrade === 'KG') nextGrade = '1';
                else {
                    const g = parseInt(currentGrade);
                    nextGrade = isNaN(g) ? 'KG' : String(g + 1);
                }

                return `
                <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg mb-2 bg-slate-50">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" class="enrollment-checkbox form-checkbox h-5 w-5 rounded border-slate-300 text-teal-600 focus:ring-teal-500" 
                            value="${s.uniqueStudentId}" 
                            data-current-grade="${currentGrade}"
                            data-next-grade="${nextGrade}"
                            data-name="${s.studentName}">
                        <div class="ml-3">
                            <span class="block font-medium text-slate-800">${s.studentName}</span>
                            <span class="block text-xs text-slate-500">Current: ${decodeGrade(currentGrade)} &rarr; Next: ${decodeGrade(nextGrade)}</span>
                        </div>
                    </label>
                </div>`;
            }).join('');

            return `
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 max-w-2xl mx-auto mb-8 border-t-4 border-t-teal-600">
                <h3 class="font-bold text-xl text-slate-800 mb-4">2026-2027 Re-enrollment</h3>
                
                <div id="enrollment-wizard-container">
                    
                    <div id="step-start" class="enrollment-step active">
                        <p class="text-slate-600 mb-4">Thank you for enrolling your student at Silicon Valley Academy for the 2026-2027 school year.</p>
                        <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200 text-sm text-yellow-800 mb-6">
                            <strong>Note:</strong> Additional time is available for Physician's Reports (PreK), Health/Oral Reports (KG), and Immunization Records until <strong>May 1, 2026</strong>. All other documents are required now.
                        </div>
                        
                        <h4 class="font-semibold text-slate-700 mb-2">Select students to re-enroll:</h4>
                        <div class="mb-6">${studentCheckboxes}</div>
                        
                        <div class="bg-teal-50 p-4 rounded-lg text-center mb-6 border border-teal-100">
                            <span class="text-xs font-bold text-teal-600 uppercase tracking-wide">Priority Window Ends In</span>
                            <div id="priority-countdown" class="text-3xl font-mono font-bold text-teal-800 my-1">Loading...</div>
                            <span class="text-xs text-slate-500">February 16, 2026 at 8:30am PST</span>
                        </div>
                        <button onclick="enrollmentNext('step-contacts')" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 shadow-sm">Next</button>
                    </div>

                    <div id="step-contacts" class="enrollment-step">
                        <h4 class="font-bold text-lg text-slate-800 mb-4">Review Contact Information</h4>
                        <div class="space-y-3 text-sm text-slate-700 bg-slate-50 p-5 rounded-lg border border-slate-200 mb-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div><p class="text-xs text-slate-500 uppercase">Father</p><p class="font-medium">${familyInfo.fatherName || '-'}</p></div>
                                <div><p class="text-xs text-slate-500 uppercase">Mother</p><p class="font-medium">${familyInfo.motherName || '-'}</p></div>
                                <div><p class="text-xs text-slate-500 uppercase">Phone 1</p><p class="font-medium">${familyInfo.phone1 || '-'}</p></div>
                                <div><p class="text-xs text-slate-500 uppercase">Phone 2</p><p class="font-medium">${familyInfo.phone2 || '-'}</p></div>
                                <div class="col-span-2"><p class="text-xs text-slate-500 uppercase">Email</p><p class="font-medium">${familyInfo.parentEmail || '-'}</p></div>
                                <div class="col-span-2"><p class="text-xs text-slate-500 uppercase">Address</p><p class="font-medium">${familyInfo.street || ''}<br>${familyInfo.city || ''}, ${familyInfo.state || ''} ${familyInfo.zip || ''}</p></div>
                            </div>
                        </div>
                        <p class="text-slate-600 text-sm mb-4 font-medium">Is this information correct?</p>
                        <div class="flex gap-4">
                            <button onclick="handleContactVerification(false)" class="flex-1 bg-white border border-slate-300 text-slate-700 font-semibold py-2 rounded-lg hover:bg-slate-50">No, I'll update in Gradelink</button>
                            <button onclick="handleContactVerification(true)" class="flex-1 bg-teal-600 text-white font-semibold py-2 rounded-lg hover:bg-teal-700">Yes, Correct</button>
                        </div>
                    </div>

                    <div id="step-volunteer" class="enrollment-step">
                        <h4 class="font-bold text-lg text-slate-800 mb-2">Parent Volunteer Agreement</h4>
                        <div class="scrollable-agreement h-64">
                            <p>Silicon Valley Academy strongly encourages parents to have a high level of involvement in their child(ren)’s education. Volunteer hours are critical to the success of SVA’s programs...</p>
                            <p class="font-bold mt-2">2026-2027 Volunteer Hours Requirement:</p>
                            <ul class="list-disc pl-5 mb-2">
                                <li>1 child enrolled: 10 hours per semester</li>
                                <li>2 or more children enrolled: 20 hours per semester</li>
                            </ul>
                            <p>Parents may choose to opt out of volunteering for the 2026-2027 academic year by paying the fee upfront.</p>
                            
                            <div class="my-4 bg-slate-100 p-3 rounded">
                                <label class="flex items-start space-x-2 mb-2">
                                    <input type="checkbox" id="vol-opt-s1" class="mt-1 form-checkbox text-teal-600" onchange="updateVolunteerState()">
                                    <span class="text-sm">I intend to <strong>not volunteer</strong> during the <strong>first semester</strong> and choose to pay up front on Gradelink the volunteer fee of $350 due 7/1/26.</span>
                                </label>
                                <label class="flex items-start space-x-2">
                                    <input type="checkbox" id="vol-opt-s2" class="mt-1 form-checkbox text-teal-600" onchange="updateVolunteerState()">
                                    <span class="text-sm">I intend to <strong>not volunteer</strong> during the <strong>second semester</strong> and choose to pay up front on Gradelink the volunteer fee of $350 due 1/1/27.</span>
                                </label>
                            </div>
                            
                            <p class="text-red-600 text-xs italic">
                                Note: If you choose to volunteer but do not fulfill hours, a fee of $450/semester will be charged.
                            </p>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="vol-agree-chk" class="form-checkbox text-teal-600 w-5 h-5">
                                <span class="text-sm font-semibold text-slate-800">I understand the above requirements and agree to fulfill my volunteer obligation.</span>
                            </label>
                        </div>
                        <button onclick="validateVolunteerAndNext()" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700">Agree and Continue</button>
                    </div>

                    <div id="step-tuition" class="enrollment-step">
                        <h4 class="font-bold text-lg text-slate-800 mb-2">Tuition Plan (2026-2027)</h4>
                        <p class="text-sm text-slate-600 mb-4">The following calculations are based on the selected students.</p>
                        
                        <div id="calculated-tuition-display" class="mb-6 overflow-x-auto"></div>

                        <div class="space-y-3 mb-6">
                            <h5 class="text-sm font-bold text-slate-700">Select Payment Plan:</h5>
                            <label class="flex items-center p-4 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                <input type="radio" name="pay-plan" value="Once" class="form-radio text-teal-600 h-5 w-5" checked onchange="enrollmentState.paymentPlan='Once'">
                                <div class="ml-3">
                                    <span class="block font-medium text-slate-800">Lump Sum Payment</span>
                                    <span class="block text-xs text-slate-500">Invoiced and due by June 1, 2026</span>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                <input type="radio" name="pay-plan" value="10Month" class="form-radio text-teal-600 h-5 w-5" onchange="enrollmentState.paymentPlan='10Month'">
                                <div class="ml-3">
                                    <span class="block font-medium text-slate-800">10-Monthly Payments</span>
                                    <span class="block text-xs text-slate-500">June 1, 2026 to March 1, 2027</span>
                                </div>
                            </label>
                        </div>
                        <button onclick="enrollmentNext('step-agreement')" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700">Next</button>
                    </div>

                    <div id="step-agreement" class="enrollment-step">
                        <h4 class="font-bold text-lg text-slate-800 mb-2">Tuition Agreement</h4>
                        <div class="scrollable-agreement">
                            <p><strong>Silicon Valley Academy’s Tuition Policy requires that:</strong></p>
                            <p>Tuition payments will be invoiced and paid through GradeLink. Accepted payment forms include ACH/checking account and credit card.</p>
                            <p>Once your child has been formally admitted for the 2026-2027 school year, you will be required to set-up an auto payment plan within two weeks. If not set up, your child's name will be removed from enrollment.</p>
                            <p>At the time of registration, a $150 non-refundable registration fee is due per child.</p>
                            <hr class="my-4">
                            <p class="font-bold">Tuition Liability & Early Termination Policy</p>
                            <p><strong>1. Nature of the Financial Obligation:</strong> Enrollment constitutes a binding financial contract for the entire academic year...</p>
                            <p><strong>2. Voluntary Withdrawal & Settlement Calculation:</strong></p>
                            <p>A. Minimum Earned Tuition (Non-Refundable Deposit): Immediately upon enrollment, 30% of the Total Contract Value is considered fully earned...</p>
                            <p>B. Accrual of Instructional Tuition: Commencing Sept 1st, tuition is earned in monthly installments of 10%.</p>
                            <p>C. Liquidated Damages for Early Termination: 20% of the remaining unearned contract balance.</p>
                            <p><strong>3. Contract Maturity (The "April 1st Lock"):</strong> Any withdrawal on or after April 1st results in full financial liability.</p>
                            <p><strong>4. Hardship & Compassionate Review:</strong> Appeals may be submitted to the Board of Directors.</p>
                            <p>Parent(s)/guardian(s) will be assessed a $35 fee on any late charge and a 2.5% convenience fee for credit cards.</p>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="tuition-agree-chk" class="form-checkbox text-teal-600 w-5 h-5">
                                <span class="text-sm font-semibold text-slate-800">I have read and agree to the Tuition Policy and Terms above.</span>
                            </label>
                        </div>
                        <button onclick="validateTuitionAgreement()" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700">Agree and Continue</button>
                    </div>

                    <div id="step-payment" class="enrollment-step">
                        <h4 class="font-bold text-lg text-slate-800 mb-4">Registration Payment</h4>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800 mb-6">
                            <i class="ph-info mr-1"></i> Please download, read, and review SVA's Parent Handbook found at the portal resources.
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl border border-slate-200 text-center mb-8 shadow-sm">
                            <p class="text-slate-600 mb-1">Total Registration Fee Due:</p>
                            <p id="final-reg-fee-display" class="text-4xl font-bold text-teal-700 mb-2">$0.00</p>
                            <p class="text-xs text-red-500">Note: If you have a balance due on Gradelink, enrollment will be put on hold.</p>
                        </div>

                        <div id="paypal-container" class="mb-8 text-center">
                            <button onclick="mockPayPalPayment()" id="mock-pay-btn" class="bg-[#003087] text-white font-bold py-3 px-8 rounded-full hover:bg-[#001c64] transition-colors shadow-md w-full sm:w-auto flex items-center justify-center mx-auto">
                                <i class="ph-paypal-logo text-xl mr-2"></i> Pay Now with PayPal
                            </button>
                            <div id="payment-success-msg" class="hidden bg-green-50 text-green-700 p-3 rounded-lg border border-green-200 mt-2">
                                <i class="ph-check-circle weight-fill text-lg align-middle"></i> 
                                <strong>Payment Successful!</strong><br>
                                <span class="text-xs">Transaction ID: <span id="trans-id"></span></span>
                            </div>
                        </div>

                        <div class="mb-6 border-t pt-6">
                            <label class="flex items-start space-x-3 mb-3">
                                <input type="checkbox" id="final-submit-chk" class="mt-1 form-checkbox text-teal-600 w-5 h-5" disabled>
                                <span class="text-sm text-slate-600 leading-snug">By initialing here and pressing submit, I hereby agree to all Silicon Valley Academy policies and procedures, including but not limited to the tuition policy, parent-volunteer policy, parent honor code, and student disciplinary code.</span>
                            </label>
                            <div class="flex items-center">
                                <span class="text-sm font-bold text-slate-700 mr-2">Initials:</span>
                                <input type="text" id="initials-input" placeholder="XYZ" class="w-24 border-slate-300 rounded-md shadow-sm uppercase font-mono text-center" maxlength="4" disabled>
                            </div>
                        </div>

                        <button onclick="submitEnrollment()" id="final-submit-btn" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 disabled:bg-slate-300 disabled:text-slate-500 disabled:cursor-not-allowed transition-colors" disabled>Submit Enrollment</button>
                        <p class="text-xs text-center text-slate-400 mt-3">You will not be able to re-enter registration once submitted.</p>
                    </div>

                    <div id="step-confirmation" class="enrollment-step text-center py-8">
                        <div class="h-20 w-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="ph-check text-4xl"></i>
                        </div>
                        <h4 class="font-bold text-2xl text-slate-800 mb-2">Registration Completed!</h4>
                        <p class="text-slate-600 mb-6">You have successfully re-enrolled:</p>
                        <div class="inline-block text-left bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
                            <ul id="enrolled-students-list" class="space-y-2 text-slate-800 font-medium"></ul>
                        </div>
                        <p class="text-sm text-slate-500">New sibling enrollment window opens on <strong>2/16/2026 at 8:30am PST</strong>.</p>
                        <button onclick="location.reload()" class="mt-8 text-teal-600 hover:text-teal-800 font-medium">Return to Dashboard</button>
                    </div>

                </div>
            </div>`;
        }

        // --- ENROLLMENT WIZARD LOGIC ---

        function enrollmentNext(nextStepId) {
            // Logic to transition steps
            if(nextStepId === 'step-contacts') {
                const checkboxes = document.querySelectorAll('.enrollment-checkbox:checked');
                if(checkboxes.length === 0) { alert("Please select at least one student."); return; }
                enrollmentState.selectedStudents = Array.from(checkboxes).map(cb => ({
                    id: cb.value,
                    nextGrade: cb.dataset.nextGrade,
                    name: cb.dataset.name
                }));
                calculateTuition();
            }

            document.querySelectorAll('.enrollment-step').forEach(s => s.classList.remove('active'));
            document.getElementById(nextStepId).classList.add('active');
            window.scrollTo(0,0);
        }

        function startPriorityCountdown() {
            const endDate = new Date("February 16, 2026 08:30:00 PST").getTime();
            const elem = document.getElementById("priority-countdown");
            if(!elem) return;

            const timer = setInterval(function() {
                const now = new Date().getTime();
                const distance = endDate - now;
                if (distance < 0) {
                    clearInterval(timer);
                    elem.innerHTML = "EXPIRED";
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                elem.innerHTML = `${days}d ${hours}h ${minutes}m`;
            }, 60000);
            
            // Initial calc
            const now = new Date().getTime();
            const distance = endDate - now;
            if(distance > 0) {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                elem.innerHTML = `${days}d ...`;
            }
        }

        function handleContactVerification(isCorrect) {
            enrollmentState.contactStatus = isCorrect ? 'Reviewed' : 'Needs_Review';
            if(!isCorrect) alert("Please note: You will need to update your information in Gradelink.");
            enrollmentNext('step-volunteer');
        }

        function updateVolunteerState() {
            const s1 = document.getElementById('vol-opt-s1').checked;
            const s2 = document.getElementById('vol-opt-s2').checked;
            if(s1 && s2) enrollmentState.volunteerOption = 'None'; 
            else if (s1) enrollmentState.volunteerOption = 'S2';
            else if (s2) enrollmentState.volunteerOption = 'S1';
            else enrollmentState.volunteerOption = 'S1&2';
        }

        function validateVolunteerAndNext() {
            if(!document.getElementById('vol-agree-chk').checked) {
                alert("You must agree to the volunteer obligation.");
                return;
            }
            updateVolunteerState(); // Ensure state is fresh
            enrollmentNext('step-tuition');
        }

        function calculateTuition() {
            const rates = {
                'ES': 12800, 'MS': 14200, 'HS': 10500, 
                'PreK': 17700 // Using School-Day as base
            };
            let regFeeTotal = 0;
            let items = [];

            enrollmentState.selectedStudents.forEach(s => {
                regFeeTotal += 150;
                let cost = 0; 
                let type = '';
                const g = String(s.nextGrade).toUpperCase();

                if(['K','0','1','2','3','4','5'].includes(g)) { cost = rates.ES; type = 'Elementary (KG-5)'; }
                else if(['6','7','8'].includes(g)) { cost = rates.MS; type = 'Middle School (6-8)'; }
                else if(parseInt(g) >= 9) { cost = rates.HS; type = 'High School'; }
                else { cost = rates.PreK; type = 'Pre-Kindergarten'; }

                items.push({ name: s.name, grade: g, cost: cost, type: type, discount: 0 });
            });

            // Sibling Discount: 10% off lowest tuition(s) for K-8 only
            // Sort by cost descending
            items.sort((a,b) => b.cost - a.cost);
            let discountEligibleCount = 0;
            
            items.forEach(item => {
                const isK8 = item.type.includes('Elementary') || item.type.includes('Middle');
                if(isK8) {
                    if(discountEligibleCount > 0) {
                        item.discount = item.cost * 0.10; // 10% Discount
                    }
                    discountEligibleCount++;
                }
            });

            let table = `<table class="tuition-table"><thead><tr><th>Student</th><th>Grade</th><th>Tuition</th><th>Discount</th><th>Net</th></tr></thead><tbody>`;
            items.forEach(i => {
                table += `<tr>
                    <td>${i.name}</td>
                    <td>${decodeGrade(i.grade)}</td>
                    <td>$${i.cost.toLocaleString()}</td>
                    <td class="text-green-600">${i.discount > 0 ? '-$'+i.discount.toLocaleString() : '-'}</td>
                    <td class="font-bold">$${(i.cost - i.discount).toLocaleString()}</td>
                </tr>`;
            });
            table += `</tbody></table>`;
            
            document.getElementById('calculated-tuition-display').innerHTML = table;
            document.getElementById('final-reg-fee-display').textContent = `$${regFeeTotal.toLocaleString()}`;
            enrollmentState.regFee = regFeeTotal;
        }

        function validateTuitionAgreement() {
            if(!document.getElementById('tuition-agree-chk').checked) {
                alert("You must agree to the Tuition Policy."); return;
            }
            enrollmentNext('step-payment');
        }

        function mockPayPalPayment() {
            const btn = document.getElementById('mock-pay-btn');
            btn.innerHTML = '<i class="ph-spinner animate-spin"></i> Processing...'; btn.disabled = true;
            
            setTimeout(() => {
                enrollmentState.paymentId = 'PAY-' + Math.floor(10000000 + Math.random() * 90000000);
                btn.classList.add('hidden');
                document.getElementById('payment-success-msg').classList.remove('hidden');
                document.getElementById('trans-id').textContent = enrollmentState.paymentId;
                
                document.getElementById('final-submit-chk').disabled = false;
                document.getElementById('initials-input').disabled = false;
                document.getElementById('final-submit-btn').disabled = false;
            }, 1500);
        }

        function submitEnrollment() {
            const initials = document.getElementById('initials-input').value.trim();
            if(!document.getElementById('final-submit-chk').checked || initials.length < 2) {
                alert("Please agree to the policies and sign with your initials."); return;
            }

            const btn = document.getElementById('final-submit-btn');
            btn.textContent = 'Submitting...'; btn.disabled = true;

            const payload = {
                action: 'enrollment',
                token: ID_TOKEN,
                students: enrollmentState.selectedStudents,
                contactStatus: enrollmentState.contactStatus,
                volunteerOption: enrollmentState.volunteerOption,
                paymentPlan: enrollmentState.paymentPlan,
                paymentId: enrollmentState.paymentId,
                timestamp: new Date().toISOString()
            };

            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify(payload),
                headers: {'Content-Type': 'application/json'}
            }).then(() => {
                enrollmentNext('step-confirmation');
                const list = document.getElementById('enrolled-students-list');
                enrollmentState.selectedStudents.forEach(s => {
                    list.innerHTML += `<li class="flex items-center"><i class="ph-check-circle text-green-500 mr-2"></i> ${s.name}</li>`;
                });
            }).catch(err => {
                console.error(err);
                alert("Submission failed. Please try again or contact support.");
                btn.disabled = false; btn.textContent = 'Submit Enrollment';
            });
        }

        // --- UTILS ---
        function switchTab(tabId) {
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active', 'border-b-2');
                b.classList.add('border-transparent', 'text-slate-500');
            });
            document.getElementById('tab-' + tabId).classList.add('tab-active', 'border-b-2');
            document.getElementById('tab-' + tabId).classList.remove('border-transparent', 'text-slate-500');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('tab-content-active'));
            document.getElementById(tabId + '-content').classList.add('tab-content-active');
        }

        function decodeGrade(g) {
            const map = { '0': 'KG', 'K': 'KG', '-1': 'PK' };
            return map[String(g).trim()] || String(g);
        }
    </script>
</body>
</html>
