<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicon Valley Academy Parent Portal</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>

    <script src="https://www.paypal.com/sdk/js?client-id=AYReVExwdQDLVcYme5sm02-tqJnyoQ5v05C7roBQyzjZiJmSScrDHYM0DzmSyfpx8Va4W2pSmfShNL-o&currency=USD&enable-funding=venmo,applepay&components=buttons"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-active { border-bottom: 2px solid #0d9488; color: #0d9488; font-weight: 600; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content-active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-100 p-4">
        <div id="login-screen" class="text-center p-10 bg-white rounded-2xl shadow-xl max-w-md w-full border border-slate-200">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-24 w-auto mx-auto mb-6">
            <h1 class="text-3xl font-bold text-slate-900">Parent Portal</h1>
            <p class="text-slate-500 mb-8 mt-2">Silicon Valley Academy</p>
            
            <div id="login-error-msg" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded mb-6 text-left text-sm"></div>

            <div id="google-signin-button-container" class="flex justify-center h-[44px]"></div>
            
            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-slate-400">Or sign in with email</span></div>
            </div>
            
            <form id="passkey-request-form" class="space-y-4">
                <div>
                    <label class="sr-only">Student Email</label>
                    <input type="email" id="email-input" placeholder="Enter student email (@svaschool.org)" class="w-full px-4 py-3 rounded-lg border-slate-300 border focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition" required>
                </div>
                <button type="submit" id="request-passkey-btn" class="w-full bg-slate-800 text-white font-semibold py-3 px-6 rounded-lg hover:bg-slate-900 transition shadow-lg">
                    Send Login Link
                </button>
            </form>
        </div>

        <div id="passkey-verify-screen" class="hidden text-center p-10 bg-white rounded-2xl shadow-xl max-w-md w-full">
            <div class="mb-6"><i class="ph-envelope-simple-open text-6xl text-teal-600"></i></div>
            <h2 class="text-2xl font-bold text-slate-900">Check Your Email</h2>
            <p class="text-slate-600 my-4">We sent a secure login link to the parent email associated with: <br><strong id="passkey-email-display" class="text-slate-800"></strong></p>
            <p class="text-xs text-slate-400 mt-6">Link expires in 10 minutes. Check spam if not received.</p>
            <button id="go-back-btn" class="mt-6 text-sm text-teal-600 hover:text-teal-800 font-medium">‚Üê Back to Login</button>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-slate-50/90 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <i id="loading-icon" class="ph-circle-notch text-6xl text-teal-600 animate-spin"></i>
            <h2 id="loading-title" class="text-xl font-semibold text-slate-700 mt-4">Loading...</h2>
        </div>
    </div>
    
    <div id="portal-container" class="hidden">
        
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center gap-4">
                        <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-10 w-auto">
                        <div>
                            <h1 class="text-xl font-bold text-slate-900 leading-none">Silicon Valley Academy</h1>
                            <span class="text-xs text-slate-500 font-medium tracking-wide uppercase">Parent Portal Beta</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="user-info-desktop" class="hidden sm:block text-right"></div>
                        <button onclick="signOut()" class="text-slate-500 hover:text-red-600 transition"><i class="ph-sign-out text-2xl"></i></button>
                        <button id="mobile-menu-button" class="sm:hidden p-2 text-slate-500"><i id="menu-icon-open" class="ph-list text-2xl"></i></button>
                    </div>
                </div>
            </div>
            <div class="sm:hidden hidden bg-white border-t border-slate-100 absolute w-full shadow-lg" id="mobile-menu">
                <div id="main-nav-mobile" class="p-2 space-y-1"></div>
            </div>
        </header>

        <nav class="hidden sm:block bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="main-nav" class="flex space-x-1 overflow-x-auto">
                    <button class="tab-btn tab-active py-4 px-4 text-sm font-medium transition-colors border-b-2 border-transparent hover:text-teal-600 whitespace-nowrap" data-tab="dashboard"><i class="ph-house mr-2"></i>Dashboard</button>
                    <button class="tab-btn py-4 px-4 text-sm font-medium text-slate-500 hover:text-teal-600 transition-colors border-b-2 border-transparent whitespace-nowrap" data-tab="actions"><i class="ph-lightning mr-2"></i>Actions & Enrollment</button>
                    <button class="tab-btn py-4 px-4 text-sm font-medium text-slate-500 hover:text-teal-600 transition-colors border-b-2 border-transparent whitespace-nowrap" data-tab="volunteering"><i class="ph-hands-clapping mr-2"></i>Volunteering</button>
                    <button class="tab-btn py-4 px-4 text-sm font-medium text-slate-500 hover:text-teal-600 transition-colors border-b-2 border-transparent whitespace-nowrap" data-tab="signups"><i class="ph-list-checks mr-2"></i>My Hours</button>
                    <button class="tab-btn py-4 px-4 text-sm font-medium text-slate-500 hover:text-teal-600 transition-colors border-b-2 border-transparent whitespace-nowrap" data-tab="pto"><i class="ph-users-three mr-2"></i>PTO</button>
                    <button class="tab-btn py-4 px-4 text-sm font-medium text-slate-500 hover:text-teal-600 transition-colors border-b-2 border-transparent whitespace-nowrap" data-tab="faq-forms"><i class="ph-files mr-2"></i>Resources</button>
                    <button class="tab-btn py-4 px-4 text-sm font-medium text-slate-500 hover:text-teal-600 transition-colors border-b-2 border-transparent whitespace-nowrap" data-tab="calendar"><i class="ph-calendar-blank mr-2"></i>Calendar</button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            
            <div id="dashboard" class="tab-content tab-content-active">
                 <h2 class="text-2xl font-bold text-slate-800 mb-6">Student Overview</h2>
                <div id="student-content-container" class="space-y-8"></div>
            </div>
            
            <div id="actions" class="tab-content">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Enrollment & Quick Actions</h2>
                <div id="actions-content-container" class="max-w-4xl mx-auto space-y-6"></div>
            </div>

            <div id="volunteering" class="tab-content">
                 <h2 class="text-2xl font-bold text-slate-800 mb-6">Opportunities</h2>
                 <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs font-semibold text-slate-500 uppercase">Event</label>
                        <select id="filter-event" class="filter-control w-full mt-1 border-slate-300 rounded-md text-sm"><option value="all">All Events</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-500 uppercase">Time</label>
                        <select id="filter-time" class="filter-control w-full mt-1 border-slate-300 rounded-md text-sm">
                            <option>All</option><option>Morning</option><option>Afternoon</option><option>Evening</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-500 uppercase">Sort</label>
                        <select id="filter-sort" class="filter-control w-full mt-1 border-slate-300 rounded-md text-sm">
                            <option value="default">Default</option><option value="recent">Recently Added</option>
                        </select>
                    </div>
                    <input type="hidden" id="filter-semester" value="all">
                    <input type="hidden" id="filter-hours" value="99">
                    <input type="hidden" id="filter-location" value="All">
                 </div>
                 <div id="volunteering-list" class="space-y-6"></div>
            </div>

            <div id="signups" class="tab-content">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">My Volunteer Log</h2>
                <div id="my-signups-content"></div>
            </div>

            <div id="pto" class="tab-content">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="bg-teal-100 p-3 rounded-full"><i class="ph-users-three text-3xl text-teal-600"></i></div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">SVA PTO</h2>
                            <p class="text-slate-500">Parent-Teacher Organization</p>
                        </div>
                    </div>
                    <div class="prose text-slate-600 max-w-none">
                        <p>As-salamu alaykum! The PTO works to enhance the educational experience of our students through events, fundraising, and community building.</p>
                        <h3 class="text-lg font-bold text-slate-800 mt-6">Get Involved</h3>
                        <p>Contact <strong>pto@svamail.com</strong> to join a committee.</p>
                    </div>
                </div>
            </div>

            <div id="faq-forms" class="tab-content">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Resources</h2>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="flex border-b border-slate-100 bg-slate-50">
                        <button class="faq-forms-tab-btn flex-1 py-3 text-sm font-medium text-slate-600 hover:bg-white" data-tab="faq-content">FAQ</button>
                        <button class="faq-forms-tab-btn flex-1 py-3 text-sm font-medium text-slate-400 hover:bg-white" data-tab="forms-content">Forms</button>
                        <button class="faq-forms-tab-btn flex-1 py-3 text-sm font-medium text-slate-400 hover:bg-white" data-tab="newsletters-content">Newsletters</button>
                        <button class="faq-forms-tab-btn flex-1 py-3 text-sm font-medium text-slate-400 hover:bg-white" data-tab="quicklinks-content">Quick Links</button>
                    </div>
                    <div class="p-6">
                        <div id="faq-content" class="faq-forms-tab-content"></div>
                        <div id="forms-content" class="faq-forms-tab-content hidden"></div>
                        <div id="newsletters-content" class="faq-forms-tab-content hidden"></div>
                        <div id="quicklinks-content" class="faq-forms-tab-content hidden"></div>
                    </div>
                </div>
            </div>

            <div id="calendar" class="tab-content">
                 <h2 class="text-2xl font-bold text-slate-800 mb-6">School Calendar</h2>
                 <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-1">
                    <iframe src="https://calendar.google.com/calendar/embed?src=svaschool.org_us4ga4j1cfs27epj0f2dfegcl0%40group.calendar.google.com&ctz=America/Los_Angeles" style="border: 0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
                </div>
            </div>
        </main>
        
        <footer class="bg-white mt-12 border-t border-slate-200 py-8">
             <div class="max-w-7xl mx-auto px-4 text-center">
                 <p class="text-slate-400 text-sm">&copy; 2025 Silicon Valley Academy. All Rights Reserved.</p>
                 <a href="mailto:parent.portal@svaschool.org" class="text-teal-600 text-xs hover:underline mt-2 inline-block">parent.portal@svaschool.org</a>
             </div>
        </footer>
    </div>

    <div id="enrollment-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm overflow-y-auto h-full w-full hidden z-[60] flex items-center justify-center transition-opacity duration-300">
         <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col my-6 mx-4 overflow-hidden">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-white">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Re-enrollment 2026-2027</h3>
                    <p class="text-xs text-slate-500">Current Student Priority Window</p>
                </div>
                <button onclick="closeEnrollmentWizard(true)" class="text-slate-400 hover:text-slate-600 transition bg-slate-100 p-2 rounded-full"><i class="ph-x text-lg"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8 bg-slate-50" id="enrollment-wizard-content">
                <div id="step-start" class="wizard-step">
                    <div class="bg-white p-6 rounded-xl border-l-4 border-amber-500 shadow-sm mb-6">
                        <div class="flex items-start gap-4">
                            <div class="bg-amber-100 p-2 rounded-full text-amber-600"><i class="ph-clock-countdown text-2xl"></i></div>
                            <div>
                                <h4 class="font-bold text-amber-900">Discounted Fee Window</h4>
                                <p class="text-sm text-amber-800 mt-1">Priority Deadline: <span class="font-bold">Feb 16, 2026 at 8:30 AM PST</span></p>
                                <p class="text-xs text-amber-700 mt-2 font-mono bg-amber-50 inline-block px-2 py-1 rounded" id="priority-countdown">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="font-bold text-slate-700 mb-4">Select students to re-enroll ($150 each):</h5>
                    <div id="enrollment-student-list" class="space-y-3 mb-8"></div>
                    <p id="enrollment-error" class="text-red-500 hidden mb-4 text-sm font-medium"><i class="ph-warning-circle mr-1"></i> Please select at least one student.</p>
                    
                    <div class="flex justify-end">
                        <button onclick="wizardNext('payment')" id="btn-goto-payment" class="bg-slate-900 text-white px-8 py-3 rounded-xl hover:bg-slate-800 font-semibold shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
                            Continue to Payment <i class="ph-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <div id="step-payment" class="wizard-step hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 text-center">
                         <p class="text-slate-500 text-sm uppercase tracking-wide font-semibold mb-1">Total Due Now</p>
                         <h2 class="text-4xl font-bold text-slate-900 mb-2" id="payment-amount">$0.00</h2>
                         <p class="text-sm text-slate-500"><span id="payment-student-count">0</span> Student(s) selected</p>
                    </div>
                    
                    <div id="paypal-button-container" class="max-w-md mx-auto"></div>
                    
                    <div id="payment-completed-msg" class="hidden bg-green-50 border border-green-200 rounded-xl p-8 text-center">
                         <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><i class="ph-check text-3xl font-bold"></i></div>
                         <h3 class="text-xl font-bold text-green-900">Payment Successful!</h3>
                         <p class="text-green-800 mt-2 text-sm">Ref ID: <span id="success-payment-id" class="font-mono font-bold select-all"></span></p>
                         <div class="mt-6">
                             <a href="https://secure.gradelink.com/lkg/Gradelink.xml?contenttype=text%2Fhtml&Language=English&v=1.0" target="_blank" class="inline-block bg-teal-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-teal-700 shadow-lg transition">
                                 Complete Forms on Gradelink &rarr;
                             </a>
                         </div>
                    </div>

                    <div class="mt-8 text-center">
                        <button onclick="wizardPrev('start')" id="btn-back-to-start" class="text-slate-400 hover:text-slate-600 text-sm">Cancel / Back</button>
                    </div>
                </div>
            </div>
         </div>
    </div>

    <div id="sibling-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm overflow-y-auto h-full w-full hidden z-[60] flex items-center justify-center transition-opacity duration-300">
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col my-6 mx-4 overflow-hidden">
           <div class="px-8 py-5 border-b border-orange-100 flex justify-between items-center bg-white">
               <div class="flex items-center gap-3">
                   <div class="bg-orange-100 p-2 rounded-lg text-orange-600"><i class="ph-users-three text-xl"></i></div>
                   <h3 class="text-xl font-bold text-slate-800">Sibling Priority Enrollment</h3>
               </div>
               <button onclick="closeModal('sibling-modal')" class="text-slate-400 hover:text-slate-600 bg-slate-50 p-2 rounded-full transition"><i class="ph-x text-lg"></i></button>
           </div>
           
           <div class="p-8 bg-slate-50/50">
               <div id="sibling-step-1">
                   <p class="text-slate-600 mb-6">Enter details for <strong>new siblings</strong> you wish to enroll for 2026-2027 (PreK - 8th).</p>
                   
                   <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Number of New Siblings</label>
                   <select id="sibling-count" class="block w-full rounded-lg border-slate-300 shadow-sm p-3 border mb-6 focus:border-orange-500 focus:ring-orange-500" onchange="renderSiblingInputs()">
                       <option value="0">Select count...</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                   </select>
                   
                   <div id="sibling-inputs-container" class="space-y-4 mb-8"></div>
                   
                   <button onclick="submitSiblingEnrollment()" id="btn-submit-sibling" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl hover:bg-orange-700 hidden shadow-lg hover:shadow-orange-500/30 transition transform hover:-translate-y-0.5">Submit Request</button>
               </div>
               
               <div id="sibling-step-success" class="hidden text-center py-6">
                    <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6 animate-bounce">
                        <i class="ph-check text-4xl text-green-600"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-900">Request Submitted!</h3>
                    <p class="text-slate-500 mt-2 mb-8">Your priority spot is reserved.</p>

                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm text-left text-sm space-y-4 max-w-sm mx-auto">
                        <p class="font-semibold text-slate-800 border-b pb-2">Next Required Steps:</p>
                        <ol class="list-decimal pl-4 text-slate-600 space-y-2">
                            <li>Check email for confirmation.</li>
                            <li>Go to Gradelink to apply.</li>
                            <li>Pay the <strong>$250 Fee</strong> on Gradelink.</li>
                        </ol>
                        <div class="pt-2 text-xs text-orange-800 text-center font-bold">Conf ID: <span id="sibling-conf-id" class="font-mono select-all"></span></div>
                    </div>
                    
                    <div class="mt-8">
                        <a href="https://secure.gradelink.com/668/enrollment" target="_blank" class="inline-block bg-slate-900 text-white font-bold py-3 px-8 rounded-xl hover:bg-slate-800 shadow-lg transition">
                            Go to Gradelink &rarr;
                        </a>
                    </div>
               </div>
           </div>
        </div>
    </div>

    <div id="qr-code-modal" class="modal fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-slate-900">Event Check-in</h3>
            <div id="qrcode" class="mx-auto my-6"></div>
            <p class="text-sm text-slate-500 mb-6">Show this to an admin to log your hours.</p>
            <button id="close-qr-modal-btn" class="w-full bg-slate-100 text-slate-700 font-semibold py-3 rounded-lg hover:bg-slate-200">Close</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzS5IhdAZQBBPJPN4KEGYWr0tf5mg7i-ZvxrWmwJMxjuGOtB3SNb3FZwIzThQYt9mTx/exec'; 
        const NEWSLETTER_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdZkNNppgbr_FdH2FOAztYpujc9A4URAsQIlWnADSypDlb5_KnCiVP3EImRK96jWK3Yg/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";
        
        let ID_TOKEN = null;
        let portalData = {};
        let enrollmentState = { selectedStudents: [], totalAmount: 0 };

        // --- DATES CONFIGURATION ---
        const PRIORITY_DEADLINE = new Date('2026-02-11T08:30:00-08:00'); // Feb 16 8:30 AM
        const SIBLING_START     = new Date('2026-02-11T08:30:00-08:00'); // Feb 16 8:30 AM
        const SIBLING_END       = new Date('2026-02-23T08:30:00-08:00'); // Feb 23 8:30 AM

        // --- RENDER ACTIONS TAB (The Core Logic) ---
        function renderActionsTab(students) {
            const container = document.getElementById('actions-content-container');
            if (!students || students.length === 0) {
                container.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-sm text-center text-slate-500">No students found.</div>`;
                return;
            }

            const now = new Date();
            
            // 1. RE-ENROLLMENT CARD
            let enrollmentCardHtml = '';
            if (now < PRIORITY_DEADLINE) {
                // Active Priority
                enrollmentCardHtml = `
                <div class="bg-white p-6 rounded-xl border-l-4 border-amber-500 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-bl-lg">PRIORITY OPEN</div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-start gap-4">
                            <div class="p-3 bg-amber-50 rounded-lg text-amber-600 group-hover:bg-amber-100 transition-colors"><i class="ph-student text-3xl"></i></div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-900">2026-2027 Re-enrollment</h3>
                                <p class="text-slate-600 text-sm mt-1">Discounted Fee: <span class="font-bold text-green-600">$150</span> <span class="text-slate-400 line-through text-xs ml-1">$250</span></p>
                                <p class="text-xs text-red-500 font-medium mt-2"><i class="ph-clock mr-1"></i>Ends Feb 16 @ 8:30 AM</p>
                            </div>
                        </div>
                        <button onclick="startEnrollment()" class="w-full sm:w-auto bg-amber-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-amber-700 transition transform hover:-translate-y-0.5 shadow-md hover:shadow-amber-500/30">
                            Start Now
                        </button>
                    </div>
                </div>`;
            } else {
                // Expired
                enrollmentCardHtml = `
                <div class="bg-white p-6 rounded-xl border-l-4 border-slate-300 shadow-sm relative opacity-75 hover:opacity-100 transition-opacity">
                    <div class="absolute top-0 right-0 bg-slate-100 text-slate-500 text-xs font-bold px-3 py-1 rounded-bl-lg">WINDOW CLOSED</div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-start gap-4">
                            <div class="p-3 bg-slate-50 rounded-lg text-slate-400"><i class="ph-student text-3xl"></i></div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-700">2026-2027 Re-enrollment</h3>
                                <p class="text-slate-500 text-sm mt-1">Standard Fee: $250. Priority pricing has ended.</p>
                            </div>
                        </div>
                        <a href="https://secure.gradelink.com/lkg/Gradelink.xml?contenttype=text%2Fhtml&Language=English&v=1.0" target="_blank" class="w-full sm:w-auto text-center bg-slate-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-slate-700 transition">
                            Pay on Gradelink
                        </a>
                    </div>
                </div>`;
            }

            // 2. SIBLING CARD
            let siblingCardHtml = '';
            const hasSiblings = portalData.submittedSiblings && portalData.submittedSiblings.length > 0;

            if (now >= SIBLING_START && now < SIBLING_END) {
                if (hasSiblings) {
                    // Submitted (Green)
                    siblingCardHtml = `
                    <div class="bg-white p-6 rounded-xl border-l-4 border-green-500 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="flex items-start gap-4">
                                <div class="p-3 bg-green-50 rounded-lg text-green-600"><i class="ph-check-circle text-3xl"></i></div>
                                <div>
                                    <h3 class="text-xl font-bold text-slate-900">Sibling Request Submitted</h3>
                                    <p class="text-slate-600 text-sm mt-1">For: <span class="font-medium">${portalData.submittedSiblings.map(s=>s.name).join(', ')}</span></p>
                                </div>
                            </div>
                            <button onclick="openSiblingModal()" class="w-full sm:w-auto border border-green-600 text-green-700 font-bold py-2.5 px-6 rounded-lg hover:bg-green-50 transition">
                                View Details
                            </button>
                        </div>
                    </div>`;
                } else {
                    // Active (Orange)
                    siblingCardHtml = `
                    <div class="bg-white p-6 rounded-xl border-l-4 border-orange-500 shadow-sm hover:shadow-md transition-shadow group relative">
                        <div class="absolute top-0 right-0 bg-orange-100 text-orange-700 text-xs font-bold px-3 py-1 rounded-bl-lg">NEW</div>
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="flex items-start gap-4">
                                <div class="p-3 bg-orange-50 rounded-lg text-orange-600 group-hover:bg-orange-100 transition-colors"><i class="ph-users-three text-3xl"></i></div>
                                <div>
                                    <h3 class="text-xl font-bold text-slate-900">Sibling Priority Enrollment</h3>
                                    <p class="text-slate-600 text-sm mt-1">Enroll new siblings (PreK - 8th) for next year.</p>
                                    <p class="text-xs text-orange-600 font-medium mt-1">Closes Feb 23</p>
                                </div>
                            </div>
                            <button onclick="openSiblingModal()" class="w-full sm:w-auto bg-orange-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-orange-700 transition transform hover:-translate-y-0.5 shadow-md hover:shadow-orange-500/30">
                                Enroll Sibling
                            </button>
                        </div>
                    </div>`;
                }
            } else if (now < SIBLING_START) {
                // Upcoming
                siblingCardHtml = `<div class="bg-slate-50 border border-dashed border-slate-300 p-6 rounded-xl text-center"><p class="text-slate-400 font-medium">Sibling Enrollment Opens Feb 16</p></div>`;
            }

            // 3. ABSENCE FORM
            const studentOptions = students.map(s => `<option value="${s.uniqueStudentId}">${s.studentName}</option>`).join('');
            const absenceFormHtml = `
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                    <div class="bg-teal-50 p-2 rounded text-teal-600"><i class="ph-calendar-x text-xl"></i></div>
                    <h3 class="text-lg font-bold text-slate-800">Report Absence or Tardy</h3>
                </div>
                <form id="absence-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Student</label>
                            <select id="student-select" class="w-full rounded-lg border-slate-300 text-sm py-2.5">${studentOptions}</select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                            <div class="flex gap-4 mt-2">
                                <label class="flex items-center"><input type="radio" name="report-type" value="absent" checked class="text-teal-600 focus:ring-teal-500 mr-2"> <span class="text-sm">Absence</span></label>
                                <label class="flex items-center"><input type="radio" name="report-type" value="tardy" class="text-teal-600 focus:ring-teal-500 mr-2"> <span class="text-sm">Tardy</span></label>
                            </div>
                        </div>
                    </div>
                    <div id="absence-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label><input type="date" id="absence-start" class="w-full rounded-lg border-slate-300 text-sm py-2.5"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label><input type="date" id="absence-end" class="w-full rounded-lg border-slate-300 text-sm py-2.5"></div>
                    </div>
                    <div id="tardy-fields" class="hidden grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Expected Arrival</label><input type="time" id="tardy-start-time" class="w-full rounded-lg border-slate-300 text-sm py-2.5"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label><input type="date" id="tardy-end-time" class="w-full rounded-lg border-slate-300 text-sm py-2.5"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Reason</label>
                        <select id="absence-reason" class="w-full rounded-lg border-slate-300 text-sm py-2.5">
                            <option>Sick</option><option>Travel</option><option>Appointment</option><option>Other</option>
                        </select>
                    </div>
                    <div id="other-reason-container" class="hidden">
                        <textarea id="other-reason-text" rows="2" class="w-full rounded-lg border-slate-300 text-sm" placeholder="Please specify..."></textarea>
                    </div>
                    <textarea id="absence-comments" rows="2" class="w-full rounded-lg border-slate-300 text-sm" placeholder="Optional comments..."></textarea>
                    <button id="send-notification-btn" type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">Send Notification</button>
                </form>
            </div>`;

            // 4. PICKUP FORM
            const eligibleStudents = students.filter(s => ['K', '0', '1', '2', '3', '4', '5', '6', '7', '8'].includes(String(s.grade)));
            let pickupFormHtml = '';
            if (eligibleStudents.length > 0) {
                const checkboxes = eligibleStudents.map(s => `<label class="flex items-center p-2 bg-slate-50 rounded border border-slate-200"><input type="checkbox" class="pickup-student-checkbox text-teal-600 rounded mr-3" value="${s.uniqueStudentId}"><span class="text-sm font-medium text-slate-700">${s.studentName}</span></label>`).join('');
                pickupFormHtml = `
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                        <div class="bg-purple-50 p-2 rounded text-purple-600"><i class="ph-car text-xl"></i></div>
                        <div><h3 class="text-lg font-bold text-slate-800">One-Time Pickup Auth</h3><p class="text-xs text-slate-500">K-8th Only</p></div>
                    </div>
                    <form id="pickup-form" class="space-y-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Select Student(s)</label><div class="grid grid-cols-1 sm:grid-cols-2 gap-2">${checkboxes}</div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="pickup-name" placeholder="Auth Person Full Name" class="w-full rounded-lg border-slate-300 text-sm">
                            <input type="text" id="pickup-relationship" placeholder="Relationship" class="w-full rounded-lg border-slate-300 text-sm">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="date" id="pickup-date" class="w-full rounded-lg border-slate-300 text-sm">
                            <input type="email" id="pickup-email" placeholder="Person's Email (Opt)" class="w-full rounded-lg border-slate-300 text-sm">
                        </div>
                        <textarea id="pickup-reason" rows="1" placeholder="Note (Optional)" class="w-full rounded-lg border-slate-300 text-sm"></textarea>
                        <button id="send-pickup-btn" type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">Authorize Pickup</button>
                    </form>
                </div>`;
            }

            container.innerHTML = enrollmentCardHtml + siblingCardHtml + absenceFormHtml + pickupFormHtml;
        }

        // --- SIBLING FUNCTIONS ---
        function renderSiblingInputs() {
            const count = document.getElementById('sibling-count').value;
            const container = document.getElementById('sibling-inputs-container');
            const btn = document.getElementById('btn-submit-sibling');
            container.innerHTML = '';
            
            if (count > 0) {
                btn.classList.remove('hidden');
                for(let i=1; i<=count; i++) {
                    container.innerHTML += `
                    <div class="p-4 bg-white border border-slate-200 rounded-xl shadow-sm">
                        <h5 class="text-xs font-bold text-orange-600 uppercase mb-3">Sibling #${i}</h5>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="text" class="sib-name w-full rounded-lg border-slate-300 focus:border-orange-500 focus:ring-orange-500 text-sm" placeholder="Full Legal Name">
                            <select class="sib-grade w-full rounded-lg border-slate-300 focus:border-orange-500 focus:ring-orange-500 text-sm">
                                <option value="">Select Grade 2026-27...</option>
                                <option value="Pre-K">Pre-K</option><option value="KG">KG</option>
                                <option value="1">1st Grade</option><option value="2">2nd Grade</option><option value="3">3rd Grade</option>
                                <option value="4">4th Grade</option><option value="5">5th Grade</option><option value="6">6th Grade</option>
                                <option value="7">7th Grade</option><option value="8">8th Grade</option>
                            </select>
                        </div>
                    </div>`;
                }
            } else { btn.classList.add('hidden'); }
        }

        function openSiblingModal() {
            openModal('sibling-modal');
            const submitted = portalData.submittedSiblings || [];
            
            if (submitted.length > 0) {
                // Show Success/Summary Screen
                document.getElementById('sibling-step-1').classList.add('hidden');
                document.getElementById('sibling-step-success').classList.remove('hidden');
                
                // Show Confirmation ID
                const confID = submitted[0].confirmationId || "Sent via Email";
                document.getElementById('sibling-conf-id').innerText = confID;

                // --- FIX: Add "Register Another" Button ---
                const successContainer = document.getElementById('sibling-step-success');
                if(!document.getElementById('btn-add-another')) {
                    const btn = document.createElement('button');
                    btn.id = 'btn-add-another';
                    btn.className = "mt-6 text-sm text-slate-400 hover:text-orange-600 underline w-full text-center transition cursor-pointer";
                    btn.innerText = "Register another sibling?";
                    btn.onclick = () => {
                        // Reset the form for a new entry
                        document.getElementById('sibling-step-success').classList.add('hidden');
                        document.getElementById('sibling-step-1').classList.remove('hidden');
                        document.getElementById('sibling-count').value = 0;
                        document.getElementById('sibling-inputs-container').innerHTML = '';
                        document.getElementById('btn-submit-sibling').classList.add('hidden');
                    };
                    successContainer.appendChild(btn);
                }
                
            } else {
                // Show Fresh Form
                document.getElementById('sibling-step-1').classList.remove('hidden');
                document.getElementById('sibling-step-success').classList.add('hidden');
                document.getElementById('sibling-inputs-container').innerHTML = '';
                document.getElementById('sibling-count').value = 0;
                document.getElementById('btn-submit-sibling').classList.add('hidden');
            }
        }

        function submitSiblingEnrollment() {
            const inputs = document.querySelectorAll('#sibling-inputs-container .bg-white');
            const siblings = [];
            let valid = true;
            inputs.forEach(div => {
                const name = div.querySelector('.sib-name').value.trim();
                const grade = div.querySelector('.sib-grade').value;
                if(!name || !grade) valid = false;
                siblings.push({ name, grade });
            });

            if(!valid) return alert("Please complete all fields.");

            const btn = document.getElementById('btn-submit-sibling');
            btn.innerHTML = '<i class="ph-spinner animate-spin mr-2"></i> Submitting...';
            btn.disabled = true;

            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'siblingEnrollment', token: ID_TOKEN, siblings: siblings })
            }).then(() => {
                // Optimistic UI Update
                const newSiblings = siblings.map(s => ({ name: s.name, grade: s.grade, confirmationId: 'Sent via Email' }));
                if (!portalData.submittedSiblings) portalData.submittedSiblings = [];
                portalData.submittedSiblings.push(...newSiblings);
                
                // 1. Show Success Screen
                document.getElementById('sibling-step-1').classList.add('hidden');
                document.getElementById('sibling-step-success').classList.remove('hidden');
                document.getElementById('sibling-conf-id').innerText = "Check your Email";
                
                // 2. Reload Data from Server to get real ID
                fetchData(ID_TOKEN); 
                
            }).catch(e => {
                console.error(e);
                alert("Error. Please check connection.");
                btn.disabled = false;
                btn.innerText = "Submit Request";
            });
        }

        // --- GLOBAL & INIT ---
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function showLoginScreen(id) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('passkey-verify-screen').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }
        function formatDate(d) { if(!d) return 'N/A'; const date = new Date(d); return !isNaN(date)?date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : d; }
        function decodeGrade(g) { const s=String(g).toUpperCase(); return s==='P'?'Pre-K':(s==='0'||s==='K'?'KG':`Grade ${s}`); }
        
        function switchToTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active', 'text-teal-600', 'border-teal-600'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.add('text-slate-500', 'border-transparent'));
            document.querySelectorAll(`.tab-btn[data-tab="${tab}"]`).forEach(b => {
                b.classList.add('tab-active', 'text-teal-600', 'border-teal-600');
                b.classList.remove('text-slate-500', 'border-transparent');
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('tab-content-active'));
            document.getElementById(tab).classList.add('tab-content-active');
            document.getElementById('mobile-menu').classList.add('hidden');
        }

        // --- ENROLLMENT (Standard) Functions ---
        function startEnrollment() {
            openModal('enrollment-modal');
            const list = document.getElementById('enrollment-student-list');
            list.innerHTML = '';
            
            // Countdown Logic
            const dest = new Date("Feb 16, 2026 08:30:00").getTime();
            const timer = setInterval(() => {
                const diff = dest - new Date().getTime();
                if (diff < 0) { clearInterval(timer); document.getElementById("priority-countdown").innerText = "Closed"; }
                else {
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    document.getElementById("priority-countdown").innerText = `${d}d ${h}h ${m}m left`;
                }
            }, 1000);

            portalData.students.forEach(s => {
                const isPaid = s.enrollmentDetails?.timestamp;
                list.innerHTML += `
                <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-slate-50 transition ${isPaid ? 'bg-green-50 border-green-200' : 'border-slate-200'}">
                    <input type="checkbox" class="enroll-student-check h-5 w-5 text-teal-600 rounded" value="${s.uniqueStudentId}" ${isPaid ? 'disabled checked' : 'checked'}>
                    <div class="ml-3">
                        <span class="font-bold text-slate-800 block">${s.studentName}</span>
                        ${isPaid ? '<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded">PAID</span>' : '<span class="text-xs text-slate-500">Eligible</span>'}
                    </div>
                </label>`;
            });
            wizardNext('start');
        }

        function wizardNext(step) {
            if(step === 'payment') {
                const checked = document.querySelectorAll('.enroll-student-check:checked:not(:disabled)');
                if(checked.length === 0) {
                    document.getElementById('enrollment-error').classList.remove('hidden'); return;
                }
                document.getElementById('enrollment-error').classList.add('hidden');
                
                enrollmentState.selectedStudents = Array.from(checked).map(c => c.value);
                const amt = enrollmentState.selectedStudents.length * 153.75;
                enrollmentState.totalAmount = amt;
                
                document.getElementById('payment-student-count').innerText = enrollmentState.selectedStudents.length;
                document.getElementById('payment-amount').innerText = '$' + amt.toFixed(2);
                
                renderPayPalButton(amt);
            }
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('hidden'));
            document.getElementById('step-'+step).classList.remove('hidden');
        }
        
        function wizardPrev(step) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('hidden'));
            document.getElementById('step-'+step).classList.remove('hidden');
        }

        function renderPayPalButton(amount) {
            document.getElementById('paypal-button-container').innerHTML = '';
            paypal.Buttons({
                style: { shape: 'rect', borderRadius: 10, height: 45 },
                createOrder: (data, actions) => actions.order.create({ purchase_units: [{ amount: { value: amount.toFixed(2) } }] }),
                onApprove: (data, actions) => actions.order.capture().then(details => {
                    enrollmentState.paymentID = details.id;
                    submitStandardEnrollment();
                    document.getElementById('success-payment-id').innerText = details.id;
                    document.getElementById('paypal-button-container').classList.add('hidden');
                    document.getElementById('payment-completed-msg').classList.remove('hidden');
                    document.getElementById('btn-back-to-start').classList.add('hidden');
                })
            }).render('#paypal-button-container');
        }

        function submitStandardEnrollment() {
            const students = portalData.students.filter(s => enrollmentState.selectedStudents.includes(String(s.uniqueStudentId)));
            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'enrollmentSubmit', token: ID_TOKEN,
                    students: students, paymentID: enrollmentState.paymentID,
                    paymentPlan: 'NotSelected', volunteerS1: false, volunteerS2: false, contactStatus: 'Skipped', initials: 'N/A'
                })
            }).then(() => fetchData(ID_TOKEN)).catch(e => console.error(e));
        }

        // --- DASHBOARD RENDERERS ---
        function renderDashboard(students) {
            const container = document.getElementById('student-content-container');
            container.innerHTML = ''; 
            if (!students || students.length === 0) {
                container.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-center text-slate-600">No students found.</p></div>';
                return;
            }
            students.forEach(s => {
                const initials = s.studentName.split(" ").map(n=>n[0]).join("");
                const teachers = (s.teachers||[]).slice(0,3).map(t => 
                    `<div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded">
                        <img src="${t.photoUrl}" class="w-8 h-8 rounded-full bg-gray-200">
                        <div><p class="text-sm font-bold text-slate-800">${t.teacherName}</p><p class="text-xs text-slate-500">${t.role}</p></div>
                    </div>`).join('') || '<p class="text-slate-400 text-sm p-2">No teachers assigned.</p>';
                
                const events = (s.events||[]).slice(0,3).map(e => 
                    `<div class="flex justify-between items-start border-b border-slate-100 last:border-0 py-2">
                        <div><p class="text-sm font-bold text-slate-800">${e.name}</p><p class="text-xs text-slate-500">${formatDate(e.date)}</p></div>
                    </div>`).join('') || '<p class="text-slate-400 text-sm p-2">No events.</p>';

                container.innerHTML += `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 bg-slate-50 border-b border-slate-200 flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-white flex items-center justify-center text-xl font-bold text-teal-700 shadow-sm border border-slate-100">${initials}</div>
                        <div><h3 class="text-xl font-bold text-slate-900">${s.studentName}</h3><p class="text-slate-500 text-sm">${decodeGrade(s.grade)} ‚Ä¢ Classroom ${s.classroom}</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2">
                        <div class="p-6 border-b lg:border-b-0 lg:border-r border-slate-100"><h4 class="font-bold text-xs uppercase text-slate-400 mb-3">Teachers</h4>${teachers}</div>
                        <div class="p-6"><h4 class="font-bold text-xs uppercase text-slate-400 mb-3">Upcoming Events</h4>${events}</div>
                    </div>
                </div>`;
            });
        }

        // --- AUTH & INIT ---
        function handleLoginSuccess(idToken) {
            ID_TOKEN = idToken;
            localStorage.setItem('sva_id_token', idToken);
            const profile = JSON.parse(atob(ID_TOKEN.split('.')[1]));
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            const pic = profile.picture || `https://placehold.co/100x100/E2E8F0/4A5568?text=${profile.email[0]}`;
            document.getElementById('user-info-desktop').innerHTML = `<div class="flex items-center gap-3"><div class="text-right"><p class="text-sm font-bold text-slate-800">${profile.name||'User'}</p><p class="text-xs text-slate-500">${profile.email}</p></div><img src="${pic}" class="w-9 h-9 rounded-full border border-slate-200"></div>`;
            
            fetchData(ID_TOKEN);
            // fetchAndRenderResources(); // Add back if needed
        }

        function fetchData(token) {
            fetch(`${WEB_APP_URL}?token=${token}`)
                .then(r => r.json())
                .then(d => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    if(d.status !== 'success') return handleTokenExpired();
                    
                    portalData = d.data;
                    document.getElementById('portal-container').classList.remove('hidden');
                    
                    renderDashboard(portalData.students);
                    renderActionsTab(portalData.students);
                    // renderVolunteering()... add others as needed
                })
                .catch(e => handleTokenExpired(e.message));
        }

        window.onload = function() {
            const token = localStorage.getItem('sva_id_token');
            const hash = window.location.hash.startsWith('#token=') ? window.location.hash.substring(7) : null;
            
            if(hash) {
                window.history.replaceState({}, document.title, window.location.pathname);
                handleLoginSuccess(hash);
            } else if(token) {
                handleLoginSuccess(token);
            } else {
                try {
                    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: r => handleLoginSuccess(r.credential) });
                    google.accounts.id.renderButton(document.getElementById('google-signin-button-container'), { theme: "outline", size: "large", width: 400 });
                } catch(e) { console.error(e); }
                document.getElementById('passkey-request-form').addEventListener('submit', handlePasskeyRequest);
            }
            
            // Mobile Menu
            document.getElementById('mobile-menu-button').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));
            
            // Tab Delegation
            document.body.addEventListener('click', e => {
                if(e.target.closest('.tab-btn')) switchToTab(e.target.closest('.tab-btn').dataset.tab);
                
                // Absence Logic
                if(e.target.name === 'report-type') {
                    const isTardy = e.target.value === 'tardy';
                    document.getElementById('tardy-fields').classList.toggle('hidden', !isTardy);
                    document.getElementById('absence-fields').classList.toggle('hidden', isTardy);
                }
                
                // Absence Submit
                if(e.target.id === 'send-notification-btn' || e.target.id === 'send-pickup-btn') {
                    e.preventDefault();
                    const isPickup = e.target.id === 'send-pickup-btn';
                    const btn = e.target;
                    
                    // Basic Validation
                    if(isPickup && !document.getElementById('pickup-name').value) return alert("Enter name.");
                    
                    btn.disabled = true; btn.innerText = "Sending...";
                    
                    // Construct Payload based on form type (Simplified for brevity)
                    const payload = { 
                        action: isPickup ? 'sendPickupEmail' : 'sendAbsenceEmail', 
                        token: ID_TOKEN,
                        // ... map fields ...
                        student: portalData.students.find(s => s.uniqueStudentId == document.getElementById('student-select').value)
                        // Add pickup fields if isPickup...
                    };
                    
                    if(isPickup) {
                        // Add pickup specific fields manually for this demo block
                        const checked = Array.from(document.querySelectorAll('.pickup-student-checkbox:checked')).map(c=>c.value);
                        if(checked.length===0) { alert("Select student"); btn.disabled=false; return; }
                        payload.students = portalData.students.filter(s=>checked.includes(String(s.uniqueStudentId)));
                        payload.pickupName = document.getElementById('pickup-name').value;
                        payload.relationship = document.getElementById('pickup-relationship').value;
                        payload.date = document.getElementById('pickup-date').value;
                        payload.reason = document.getElementById('pickup-reason').value;
                    } else {
                        payload.reportType = document.querySelector('input[name="report-type"]:checked').value;
                        payload.startDate = document.getElementById('absence-start').value;
                        payload.endDate = document.getElementById('absence-end').value;
                        payload.tardyStartTime = document.getElementById('tardy-start-time').value;
                        payload.tardyEndTime = document.getElementById('tardy-end-time').value;
                        payload.reason = document.getElementById('absence-reason').value;
                        payload.comments = document.getElementById('absence-comments').value;
                    }

                    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                        .then(() => { alert('Sent successfully!'); btn.disabled = false; btn.innerText = isPickup ? "Authorize Pickup" : "Send Notification"; })
                        .catch(e => { alert("Error sending."); btn.disabled = false; });
                }
            });
        };

        function handlePasskeyRequest(e) {
            e.preventDefault();
            const btn = document.getElementById('request-passkey-btn');
            const email = document.getElementById('email-input').value;
            btn.disabled = true; btn.innerText = "Sending...";
            
            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action: 'requestLoginPasskey', email: email })
            }).then(() => {
                document.getElementById('passkey-email-display').innerText = email;
                showLoginScreen('passkey-verify-screen');
            }).catch(e => { alert("Error sending link."); btn.disabled = false; });
        }
        
        function handleTokenExpired(msg) {
            localStorage.removeItem('sva_id_token');
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('portal-container').classList.add('hidden');
            showLoginScreen('login-screen');
            if(msg) {
                const err = document.getElementById('login-error-msg');
                err.innerText = msg;
                err.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
